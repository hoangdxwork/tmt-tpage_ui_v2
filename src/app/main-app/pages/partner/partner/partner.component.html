<div class="w-full h-full flex flex-col">
    <div class="p-4 w-full bg-white">
        <div class="w-full flex justify-between">
            <h1 class="flex cursor-pointer items-center group whitespace-pre-wrap font-semibold">
                <span class="text-neutral-1-900 text-header-1 font-semibold font-sans">Khách hàng</span>
            </h1>
            <div class="flex gap-x-2">
                <button tds-button color="primary" size="md" (click)="showModalAddPartner()">
                    <span class="flex items-center">
                        <i class="tdsi-plus-circle-fill text-lg leading-none mr-2"></i>Thêm mới
                    </span>
                </button>
                <button tds-button color="secondary" size="md" (click)="showModalConvertPartner()">
                    <span class="flex items-center">
                        <i class="tdsi-in-out-fill text-lg leading-none mr-2 text-neutral-500"></i>Chuyển đổi khách hàng
                    </span>
                </button>
                <button tds-button color="secondary" size="md" (click)="showModalResetPoint()">
                    <span class="flex items-center">
                        <i class="tdsi-reload-fill text-lg leading-none mr-2 text-neutral-500"></i>Reset điểm tích lũy
                    </span>
                </button>
                <button tds-button color="secondary" size="md">
                    <span class="flex items-center">
                        <i class="tdsi-excel-fill text-lg leading-none mr-2 text-neutral-500"></i>Xuất Excel
                    </span>
                </button>
            </div>

        </div>
    </div>
    <div class="p-4 h-full">
        <div class="bg-white w-full h-full rounded-md border border-neutral-200 flex flex-col">
            <div class="flex h-full justify-between">
                <tds-tabset [tabBarExtraContent]="extraTemplate">
                    <tds-tab *ngFor="let tab of tabsPartner" [title]="titleTemplate" class="h-full !p-0">
                        <ng-template #titleTemplate let-active="active">
                            <div class="p-4 font-semibold text-body-2 border-b-3 cursor-pointer group flex items-center"
                                [ngClass]='{"border-primary-1":active,"border-transparent text-neutral-1-400  hover:border-primary-1":!active}'>
                                <span class="mr-2">{{ tab.name }}</span>
                                <div class="text-caption-2 font-semibold py-0.5 px-1.5 rounded-full flex"
                                    [ngClass]="{'text-white bg-primary-1':active,'text-neutral-1-500 bg-neutral-3-100 group-hover:text-white group-hover:bg-primary-1':!active}">
                                    {{tab.count}}
                                </div>
                            </div>
                        </ng-template>
                        <tds-table *ngIf="tab.id==0" #rowSelectionTable showSizeChanger [listData]="listOfData"
                            [scroll]="{y:'auto'}" (currentPageDataChange)="onCurrentPageDataChange($event)">
                            <thead>
                                <tr>
                                    <th width="50px"></th>
                                    <th width="42px" [(checked)]="checked" [indeterminate]="indeterminate"
                                        (checkedChange)="onAllChecked($event)">
                                    </th>
                                    <th width="12%">Tên</th>
                                    <th width="8%">Điện thoại</th>
                                    <th width="10%">Email</th>
                                    <th width="22%">Địa chỉ</th>
                                    <th width="8%">Trạng thái</th>
                                    <th width="10%">Nhãn</th>
                                    <th width="7.5%" class="text-right">Nợ hiện tại</th>
                                    <th width="7.5%" class="text-center">Hiệu lực</th>
                                    <th width="9%">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <ng-template ngFor let-data [ngForOf]="rowSelectionTable.data" let-odd='odd'>
                                    <tr class="text-body-2 text-neutral-900 font-regular"
                                        [ngClass]="setOfCheckedId.has(data.id)?'bg-[#F2FCF5]':''">
                                        <td [expand]="expandSet.has(data.id)"
                                            (expandChange)="onExpandChange(data.id, $event)"></td>
                                        <td [checked]="setOfCheckedId.has(data.id)"
                                            (checkedChange)="onItemChecked(data.id, $event)"
                                            class="border-l border-r text-center border-neutral-200"></td>
                                        <td class=" border-r border-neutral-200">
                                            <div class="flex flex-col">
                                                <span>{{data.code +' '+ data.name}}</span>
                                            </div>
                                        </td>
                                        <td class=" border-r border-neutral-200">
                                            <div class="flex flex-col">
                                                <span>{{data.phone}}</span>
                                                <tds-tag
                                                    [status]="checkPhone(data.phone)=='Viettel'?'error':(checkPhone(data.phone)=='Mobifone'?'success':'info')"
                                                    type="outline">
                                                    {{checkPhone(data.phone)}}
                                                </tds-tag>
                                            </div>
                                        </td>
                                        <td class="border-r border-neutral-200">{{ data.email }}</td>
                                        <td class="border-r border-neutral-200 ">
                                            <div class="w-full flex ">
                                                <span class="">{{ data.address }}</span>
                                            </div>
                                        </td>
                                        <td class="border-r border-neutral-200 ">
                                            <div class="w-full flex ">
                                                <tds-badge class="truncate"
                                                    [status]="data.status==0?'error':(data.status==1?'secondary':'success')"
                                                    [text]="data.status==0?'Bom hàng':(data.status==1?'Bình thường':'Thân thiết')">
                                                </tds-badge>
                                            </div>
                                        </td>
                                        <td class="border-r border-neutral-200">
                                            <div class="flex w-full gap-x-2 items-center">
                                                <div class="flex w-full flex-wrap gap-2" *ngIf="data.tag.length!=0">
                                                    <tds-tag class=" truncate" *ngFor="let item of data.tag"
                                                        status='primary'>
                                                        {{item}}</tds-tag>
                                                </div>
                                                <button (click)="addTag(data.id)" tds-button-icon tds-popover
                                                    [popoverVisible]="indClickTag==data.id" popoverTrigger="click"
                                                    [popoverFooter]="footerAddTag" [popoverContent]="contentAddtag"
                                                    popoverPlacement="left" color="secondary" size="sm"
                                                    class=" border-0">
                                                    <span class="flex items-center relative">
                                                        <i class="tdsi-tag-fill "></i>
                                                        <i
                                                            class="h-2.5 w-2.5 tdsi-plus-circle-fill text-xs leading-4 text-primary-1 absolute right-0 bottom-0"></i>
                                                    </span>
                                                </button>
                                                <!-- button thêm nhãn -->
                                                <ng-template #contentAddtag>
                                                    <div class="w-96">
                                                        <tds-form-field>
                                                            <tds-select valueField="id" textField="name"
                                                                placeholder='select item' [(ngModel)]="listSelectedTag"
                                                                [allowClear]="true" [valuePrimitive]="false"
                                                                [data]="listDataTag" (change)="onChange($event)"
                                                                mode="multiple">
                                                            </tds-select>
                                                        </tds-form-field>
                                                    </div>
                                                </ng-template>
                                                <ng-template #footerAddTag>
                                                    <div class="flex justify-end pt-2">
                                                        <button tds-button-icon color="secondary" class="mr-2" size="sm"
                                                            (click)="close()">
                                                            <span class="flex items-center">
                                                                <i class="tdsi-close-fill"></i>
                                                            </span>
                                                        </button>
                                                        <button tds-button-icon size="sm" (click)="apply()">
                                                            <span class="flex items-center">
                                                                <i class="tdsi-tick-fill"></i>
                                                            </span>
                                                        </button>
                                                    </div>
                                                </ng-template>
                                            </div>
                                        </td>
                                        <td class="border-r border-neutral-200 text-right">{{ data.debt |
                                            number :'1.0-3'}}</td>
                                        <td class="border-r border-neutral-200">
                                            <div class="flex items-center justify-center">
                                                <div class="">
                                                    <span
                                                        [ngClass]="data.effect?'tdsi-success-fill text-success-400':'tdsi-error-fill text-error-400'"
                                                        class="text-xl leading-5"></span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="flex gap-x-2">
                                                <button tds-button-icon color="secondary" size="sm"
                                                    (click)="openDrawerMessage(data.facebook)">
                                                    <span class="flex items-center">
                                                        <i class="tdsi-messenger-fill"></i>
                                                    </span>
                                                </button>
                                                <button tds-button-icon color="secondary" size="sm"
                                                    (click)="showModalEditPartner(data.id)">
                                                    <span class="flex items-center">
                                                        <i class="tdsi-edit-fill"></i>
                                                    </span>
                                                </button>
                                                <button tds-button-icon color="secondary" size="sm">
                                                    <span class="flex items-center">
                                                        <i class="tdsi-trash-fill"></i>
                                                    </span>
                                                </button>
                                            </div>
                                        </td>

                                    </tr>
                                    <tr [expand]="expandSet.has(data.id)"
                                        class="border-b border-neutral-2-100 text-neutral-1-900 w-full bg-light-50">
                                        <app-info-order-debt-of-partner [dataPartner]="data">
                                        </app-info-order-debt-of-partner>
                                    </tr>
                                </ng-template>
                            </tbody>
                        </tds-table>
                    </tds-tab>
                </tds-tabset>

                <ng-template #extraTemplate>
                    <div class="flex items-center gap-x-2">
                        <div [tooltipTrigger]="'hover'" tooltipTitle="Chọn khách hàng để gửi tin nhắn"
                            tooltipPlacement="top" tds-tooltip>
                            <button tds-button color="primary" [disabled]="setOfCheckedId.size==0"
                                (click)="showModalSendMessage()">
                                <span class="flex items-center">
                                    <i class="tdsi-send-fill mr-2"></i>Gửi tin nhắn
                                </span>
                            </button>
                        </div>
                        <button tds-button color="secondary" class="flex" (click)="showModalBirthday()">
                            <span class="mr-2">Sinh nhật</span>
                            <div
                                class="text-caption-2 font-semibold py-0.5 px-1.5 rounded-full flex text-white bg-primary-1">
                                2
                            </div>
                        </button>
                        <tds-button-group>
                            <button tds-button color="secondary" tds-dropdown trigger="click" [tdsDropdownMenu]="menu">
                                <span class="flex items-center">
                                    Thao tác <i class="tdsi-arrow-down-fill text-lg leading-none ml-2"></i>
                                </span>
                            </button>
                            <tds-dropdown-menu #menu="tdsDropdownMenu">
                                <div class="w-full">
                                    <div tds-dropdown-item>
                                        <a> Item 1 </a>
                                    </div>
                                    <div tds-dropdown-item>
                                        <a> Item 2 </a>
                                    </div>
                                </div>
                            </tds-dropdown-menu>
                        </tds-button-group>
                        <tds-form-field class="w-full">
                            <input tdsInput placeholder="Tìm kiếm" autocomplete="off" />
                            <span tdsPrefix><i class="text-neutral-1-500 tdsi-search-fill"></i></span>
                        </tds-form-field>
                        <button tds-button-icon color="secondary">
                            <span class="flex items-center">
                                <i class="tdsi-column-setting-fill text-lg leading-none"></i>
                            </span>
                        </button>
                    </div>
                </ng-template>
            </div>
        </div>
    </div>
    <app-drawer-message [isOpenDrawer]="isOpenMessageFacebook" (isCloseDrawer)="closeDrawerMessage($event)">
    </app-drawer-message>
</div>