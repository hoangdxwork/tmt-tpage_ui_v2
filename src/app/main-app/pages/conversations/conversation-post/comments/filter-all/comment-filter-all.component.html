<tds-spin [spinning]="isLoading">
    <div *ngIf="data && dataSource && team" class="w-full h-full overflow-hidden overflow-y-auto tds-custom-scroll p-3 flex flex-col gap-y-3">

        <div class="flex flex-col gap-y-1" id="myScroll" is-lock="true"
            yiAutoScroll lock-y-offset="10" scroll-end="true" observe-attributes (on-change-bottom)="nextData($event)">

            <div *ngFor="let item of dataSource.Items; let i= index; trackBy: trackByIndex" class="flex flex-auto w-full">
                <div *ngIf="item" class="flex flex-auto w-full"  @eventFadeState>

                    <tpage-avatar-facebook [shape]="'circle'" [size]="'lg'" [psid]="item.UserId" [token]="team.ChannelToken">
                    </tpage-avatar-facebook>

                    <div class="ml-2 w-full h-full">
                        <div class="bg-white rounded-2xl px-4 py-3">
                            <div class="flex items-center justify-between">
                                <div class="flex gap-x-2">
                                    <label class="font-semibold">{{ item.Data?.from?.name }} </label>

                                    <div *ngIf="commentOrders && item.Data?.from" class="flex flex-row items-center">
                                      <div *ngFor="let order of commentOrders[item.Data?.from!.id]"
                                        class="text-info-500 font-semibold flex flex-row items-center gap-2">
                                        <div class="flex flex-row cursor-pointer hover:underline" (click)="editOrder(order.id, item.Data)">
                                          <span *ngIf="!order.code.includes('#')">#</span>{{order.code}}
                                        </div>
                                      </div>
                                    </div>
                                </div>

                                <span class="text-neutral-1-400 text-right text-caption-1">{{item.CreatedTime | date:'dd/MM/yyyy HH:mm aa'}}</span>
                            </div>
                            <div *ngIf="(partners$ | async)?.data[item.UserId] || commentOrders[item.UserId]?.length > 0 "
                                class="w-full flex flex-row items-center justify-between pb-2">

                                <!-- trạng thái khách hàng & mã đơn hàng -->
                                <div class="flex items-center gap-1.5">
                                    <!-- trạng thái khách hàng -->
                                    <div *ngIf="(partners$ | async)?.data[item.UserId] as partner" class="button-status flex items-center gap-1.5 mr-4">
                                        <span *ngIf="partner.p" tds-tooltip tooltipTitle="Chọn làm số điện thoại"
                                            class="h-5 w-5 bg-green-400 flex items-center justify-center rounded-md cursor-pointer">
                                            <i class="tdsi-call-fill text-xs text-white"></i>
                                        </span>

                                        <span *ngIf="partner.a" tds-tooltip tooltipTitle="Chọn làm địa chỉ"
                                            class="h-5 w-5 bg-orange-500 flex items-center justify-center rounded-md cursor-pointer">
                                            <i class="tdsi-pin-fill text-xs text-white"></i>
                                        </span>

                                        <tds-tag *ngIf="partner.st" [ngStyle]="{ 'color' : partner.ss }" type="outline">
                                            {{partner.st || 'Bình thường'}}
                                        </tds-tag>
                                    </div>
                                </div>
                                <div *ngIf="(partners$ | async)?.data[item.UserId] as partner" class="tag-status w-1/2">
                                    <div *ngIf="partner.t" class="w-full flex flex-wrap items-center justify-end">
                                        <a class="tdsi-radio-circle-fill" *ngFor="let tag of partner.t"
                                            [ngStyle]="{ 'color' : [tag.color_class] }" [title]="tag.name">
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- nội dung bình luận -->
                            <div class="flex flex-row">
                                <div [innerHTML]="item.Message | formatIconLike | safeHtml"></div>
                            </div>

                            <!-- hình ảnh đính kèm -->
                            <div *ngIf="item.Data?.attachment">
                                <img tds-image *ngIf="item.Data?.attachment?.type != 'sticker'" [tdsSrc]="item.Data?.attachment?.media?.image?.src"
                                  class="max-w-[200px]" />
                                <img tds-image *ngIf="item.Data?.attachment?.type == 'sticker'" [tdsSrc]="item.Data?.attachment?.media?.image?.src"
                                  class="max-w-[100px]" />
                            </div>

                            <!-- thao tác -->
                            <div class="flex items-center pt-3">
                              <button type="button" tds-button color="primary" class="mr-2" size="sm" (click)="onCreateOrder(item.Data)"> Tạo đơn hàng  </button>
                              <button type="button" tds-button-icon color="secondary" class="mr-2" size="sm" tooltipTitle="Thông tin khách hàng" tooltipPlacement="top" tds-tooltip
                                  (click)="onInformation(item.Data)">
                                  <span class="flex items-center justify-center">
                                      <i class="tdsi-information-fill text-neutral-1-500"></i>
                                  </span>
                              </button>
                              <button type="button" tds-button-icon color="secondary" class="mr-2" size="sm" tooltipTitle="Phản hồi bình luận"
                                  tooltipPlacement="top" tds-tooltip (click)="isReply(item)">
                                  <span class="flex items-center justify-center">
                                    <i class="tdsi-reply-fill text-neutral-1-500"></i>
                                  </span>
                              </button>

                              <div *ngIf="childs[item.Id]">
                                  <button type="button" *ngIf="isHiddenComment[item.Id]" tds-button-icon color="secondary" (click)="hiddenComment(item, true)" class="mr-2" size="sm" tooltipTitle="Ẩn thị bài viết" tooltipPlacement="top" tds-tooltip>
                                      <span class="flex items-center justify-center">
                                          <i class="tdsi-eye-close-fill text-neutral-1-500"></i>
                                      </span>
                                  </button>
                                  <button type="button" *ngIf="!isHiddenComment[item.Id]" tds-button-icon color="secondary" (click)="hiddenComment(item, false)" class="mr-2" size="sm" tooltipTitle="Hiển thị bài viết" tooltipPlacement="top" tds-tooltip>
                                      <span class="flex items-center justify-center">
                                          <i class="tdsi-eye-line text-neutral-1-500"></i>
                                      </span>
                                  </button>
                              </div>
                              <div class="flex items-center ml-6 gap-x-2">
                                  <div class="flex h-5 w-5 items-center justify-center bg-base-green-400 rounded-md">
                                      <i class="tdsi-call-fill leading-none text-white"></i>
                                  </div>
                                  <div class="flex h-5 w-5 items-center justify-center bg-base-orange-500 rounded-md">
                                      <i class="tdsi-pin-fill leading-none text-white"></i>
                                  </div>
                                  <tds-tag status='primary' type="outline">Bình thường</tds-tag>
                              </div>
                            </div>
                        </div>
                      <!-- Input trả lời bình luận -->
                      <div class="bg-white rounded-2xl border-b-2 border-primary-1 p-4 mt-3" *ngIf="item.Data?.is_reply" @eventFadeState>
                        <div class="flex justify-between gap-2 pb-2">
                            <textarea tdsInput placeholder="Nhập nội dung tin nhắn, nhấn [Enter] để gửi" [(ngModel)]="messageModel"
                                [ngModelOptions]="{standalone: true}" (keydown.enter)="onEnter(item, $event)" class="resize-none" rows="3"></textarea>
                            <button tds-button type="button" color="primary" class="!rounded-full" [size]="'lg'" (click)="messageSendingToServer(item)">
                              <span class="flex items-center px-5">
                                <i class="tdsi-send-fill text-lg leading-none mr-2"></i> Gửi
                              </span>
                            </button>
                        </div>
                        <!-- Check Private Reply -->
                        <div class="quick-message gap-5">
                          <div class="check gap-5 flex justify-between">
                            <tds-checkbox [checked]="item.Data.is_private_reply" (change)="isPrivateReply(item)"> Gửi về tin nhắn </tds-checkbox>

                            <div class="icon-send flex flex-row mr-2">
                              <span class="p-1 hover:bg-neutral-3-50 rounded-md" *ngIf="item.Data.is_private_reply" (click)="onProductsbypageFb(item)"
                                  product-show-button  tooltipTitle="Sản phẩm" tooltipPlacement="top" tds-tooltip>
                                  <i class="tdsi-product-line text-xl"></i>
                              </span>

                              <span class="p-1  hover:bg-neutral-3-50 rounded-md" container="body" placement="auto"
                                  tds-popover popoverTrigger="click" tooltipTitle="Emoji" tooltipPlacement="top" tds-tooltip
                                  [popoverContent]="infoEmojiMart" [popoverAutoClose]="true"
                                  [popoverBackdrop]="true" popoverPlacement="top">
                                  <i class="tdsi-emotion-line text-xl"></i>
                                  <ng-template #infoEmojiMart>
                                    <div (loadEmojiMart)="loadEmojiMart($event)" icon-emoji-mart></div>
                                  </ng-template>
                              </span>

                              <div class="p-1 hover:bg-neutral-3-50 rounded-md flex items-center" tds-tooltip tooltipTitle="Tin nhắn nhanh">
                                  <quick-reply-button (onQuickReplySelected)="onQuickReplySelected($event)"></quick-reply-button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <!-- Trả lời bình luận -->
                      <div *ngIf="childs[item.Id] && isHiddenComment[item.Id]" @eventFadeState>
                        <div *ngFor="let child of childs[item.Id]" class="mt-3">
                          <div *ngIf="child" class="flex">
                            <tpage-avatar-facebook [shape]="'circle'" [size]="'lg'" [psid]="child.from?.id"
                              [token]="team.ChannelToken">
                            </tpage-avatar-facebook>
                            <div class="list bg-white rounded-2xl ml-2 p-4 w-full">
                              <div class="flex justify-between">
                                <div class="flex flex-row items-center">
                                  <label class="font-semibold">{{child.from?.name}}</label>
                                  <div *ngIf="commentOrders">
                                    <a class="text-info-500 font-semibold" (click)="editOrder(order.id, child)" *ngFor="let order of commentOrders[child.from.id]">
                                      {{order.code}}
                                    </a>
                                  </div>
                                </div>
                                <span class="text-neutral-1-400 text-right text-caption-1">{{child.created_time | date:'dd/MM/yyyy HH:mm aa'}}</span>
                              </div>
                              <!-- nội dung tin nhắn -->
                              <div [innerHTML]="child.message | safeHtml"></div>
                              <div *ngIf="child.attachment">
                                  <img tds-image *ngIf="child.attachment?.type != 'sticker'"
                                    [tdsSrc]="child.attachment?.media?.image?.src" style="max-width: 200px;"/>
                                  <img tds-image *ngIf="child.attachment?.type == 'sticker'"
                                    [tdsSrc]="child.attachment?.media?.image?.src" style="max-width: 100px;"/>
                              </div>

                              <div class="flex pt-4">
                                  <button type="button" tds-button-icon color="secondary" class="mr-2" tooltipTitle="Thông tin"
                                      tooltipPlacement="top" tds-tooltip (click)="onInformation(child)">
                                      <span class="flex items-center justify-center">
                                        <i class="tdsi-information-fill"></i>
                                      </span>
                                  </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</tds-spin>
