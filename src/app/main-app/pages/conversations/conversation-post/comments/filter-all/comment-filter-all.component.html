<tds-spin [spinning]="isLoading" class="overflow-hidden flex flex-auto w-full h-full">
    <div *ngIf="data && dataSource && team" class="overflow-hidden flex flex-col flex-auto w-full h-full gap-y-3" style="padding: 0.75rem 0 0.75rem 0.75rem">

        <div class="overflow-y-auto tds-custom-scroll flex flex-col gap-y-3" is-lock="true" id="scrollCommentAll" style="padding-right: 0.75rem"
          yiAutoScroll lock-y-offset="10" scroll-end="true" observe-attributes (on-change-bottom)="nextData($event)">

            <div *ngFor="let item of dataSource.Items | sortDataSourcePost; let i= index; trackBy: trackByIndex" class="flex flex-auto w-full">
                <div *ngIf="item" class="flex flex-auto w-full" @eventFadeState>

                    <div *ngIf="item.Type == 12">
                        <tpage-avatar-facebook [shape]="'circle'" [size]="'lg'" [psid]="item.UserId" [token]="team.ChannelToken">
                        </tpage-avatar-facebook>
                    </div>

                    <div *ngIf="item.Type == 91">
                        <tds-avatar [tdsSrc]="(item.Data | tShopDataMessage)?.Actor?.AvatarUrl"></tds-avatar>
                    </div>
                    

                    <div class="ml-2 w-full h-full">
                        <div class="bg-white rounded-2xl px-4 py-3">
                            <div class="flex items-center justify-between">
                                <div class="flex gap-x-2">
                                    <div *ngIf="item.Type == 12">
                                        <label class="font-semibold" *ngIf="item.Data && item.Data?.from">{{ item.Data.from.name }} </label>
                                    </div>
                
                                    <div *ngIf="item.Type == 91">
                                        <label class="font-semibold" *ngIf="item.Data">{{ (item.Data | tShopDataMessage).Actor?.Name }} </label>
                                    </div>

                                    <div *ngIf="commentOrders && item?.Data?.from" class="flex flex-row items-center">
                                        <div *ngFor="let order of commentOrders[item.Data?.from!.id]"  class="text-info-500 font-semibold flex flex-row items-center gap-2">
                                            <div class="flex flex-row cursor-pointer hover:underline" (click)="loadOrderByCode(order.id, item)">
                                                <span *ngIf="!order.code.includes('#')">#</span>{{order.code}}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <span class="text-neutral-1-400 text-right text-caption-1">{{item.CreatedTime | date:'dd/MM/yyyy HH:mm aa'}}</span>
                            </div>

                            <!-- nội dung bình luận -->
                            <div class="flex flex-row gap-x-3">
                                <div [innerHTML]="item.Message | formatIconLike | bbcodeConvert | safeHtml "></div>
                                <!-- <button tooltipTitle="Thêm vào ghi chú" tds-tooltip="" tooltipPlacement="top"
                                    class="rounded-full h-5 w-5 border border-primary-1 text-primary-1 flex justify-center items-center">
                                    <span class="tdsi-plus-fill"></span>
                                </button> -->
                            </div>

                            <!-- hình ảnh đính kèm -->
                            <div *ngIf="item.Data?.attachment">
                                <img tds-image *ngIf="item.Data?.attachment?.type != 'sticker'" [tdsSrc]="item.Data.attachment?.media?.image?.src"
                                  class="max-w-[200px]" />
                                <img tds-image *ngIf="item.Data?.attachment?.type == 'sticker'" [tdsSrc]="item.Data.attachment?.media?.image?.src"
                                  class="max-w-[100px]" />
                            </div>

                            <!-- thao tác -->
                            <div class="flex items-center pt-3">
                                <button type="button" tds-button color="primary" class="mr-2" size="sm" (click)="onInsertFromPost(item)"> Tạo đơn hàng  </button>

                                <button type="button" tds-button-icon color="secondary" class="mr-2" size="sm" tooltipTitle="Thông tin khách hàng"
                                    tooltipPlacement="top" (click)="loadPartnerTab(item)" tds-tooltip>
                                    <span class="flex items-center justify-center">
                                        <i class="tdsi-information-fill text-neutral-1-500"></i>
                                    </span>
                                </button>

                                <button type="button" tds-button-icon color="secondary" class="mr-2" size="sm" tooltipTitle="Phản hồi bình luận" tooltipPlacement="top" tds-tooltip (click)="isReply(item)">
                                    <span class="flex items-center justify-center">
                                        <i class="tdsi-reply-fill text-neutral-1-500"></i>
                                    </span>
                                </button>

                                <button type="button" tds-button-icon color="secondary" class="mr-2" size="sm" tooltipTitle="Hội thoại tin nhắn" tooltipPlacement="top" tds-tooltip (click)="openMiniChat(item)">
                                    <span class="flex items-center justify-center">
                                        <i class="tdsi-messenger-fill text-neutral-1-500"></i>
                                    </span>
                                </button>

                                <div *ngIf="childs[item.Id]">
                                    <button type="button" *ngIf="isHiddenComment[item.Id]" tds-button-icon color="secondary" (click)="hiddenComment(item, true)" class="mr-2" size="sm" tooltipTitle="Ẩn thị bài viết" tooltipPlacement="top" tds-tooltip>
                                        <span class="flex items-center justify-center">
                                            <i class="tdsi-eye-close-fill text-neutral-1-500"></i>
                                        </span>
                                    </button>

                                    <button type="button" *ngIf="!isHiddenComment[item.Id]" tds-button-icon color="secondary" (click)="hiddenComment(item, false)" class="mr-2" size="sm" tooltipTitle="Hiển thị bài viết" tooltipPlacement="top" tds-tooltip>
                                        <span class="flex items-center justify-center">
                                            <i class="tdsi-eye-line text-neutral-1-500"></i>
                                        </span>
                                    </button>
                                </div>

                                <div *ngIf="partnerDict && partnerDict[item.UserId]" class="w-full flex flex-row items-center justify-between">
                                    <!-- trạng thái khách hàng & mã đơn hàng -->
                                    <div class="flex items-center gap-1.5">

                                        <!-- trạng thái khách hàng -->
                                        <div *ngIf="partnerDict[item.UserId]" class="button-status flex items-center gap-1.5 mr-4">
                                            <span *ngIf="partnerDict[item.UserId].p" class="h-5 w-5 bg-base-green-400 flex items-center justify-center rounded-md cursor-pointer">
                                                <i class="tdsi-call-fill text-body-2 leading-none text-white"></i>
                                            </span>

                                            <span *ngIf="partnerDict[item.UserId].a" class="h-5 w-5 bg-base-orange-500 flex items-center justify-center rounded-md cursor-pointer">
                                                <i class="tdsi-pin-fill text-body-2 leading-none text-white"></i>
                                            </span>

                                            <div *ngIf="partnerDict[item.UserId].st" [ngStyle]="{'background-color': partnerDict[item.UserId].ss+'30', 'border-color': partnerDict[item.UserId].ss, 'color': partnerDict[item.UserId].ss}"
                                                class="border font-semibold px-2 py-0.5 rounded text-caption-2 ">
                                                {{partnerDict[item.UserId].st}}
                                            </div>
                                        </div>
                                    </div>

                                    <div *ngIf="partnerDict[item.UserId].t" class="justify-end flex-col gap-2 tag-status flex-auto xl:hidden 2xl:flex">
                                        <div class="flex gap-2">
                                            <div class="flex-auto flex flex-nowrap gap-1 justify-end items-center overflow-hidden" #currentWidthTag>
                                                <div class="flex gap-x-1">
                                                    <div *ngFor="let tag of partnerDict[item.UserId].t | slice: 0:3" #widthTag
                                                        class="relative flex items-center text-caption-2 text-[11px] max-w-[110px] font-regular text-neutral-1-900 rounded truncate flex-none">
                                                        <div *ngIf="tag" [ngStyle]="{'background-color': [tag.color_class+'30'] }" tds-tooltip [tooltipTitle]="tag.name"
                                                            class="w-full rounded-md py-0.5 px-1.5 flex justify-center items-center gap-x-1">
                                                            <div class="flex items-center">
                                                                <span [ngStyle]="{'background-color': [tag.color_class] }"
                                                                class="-top-px inline-block align-middle rounded-full w-2 h-2"></span>
                                                            </div>
                                                            <span class="flex-auto truncate">{{tag.name}}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="flex gap-1.5 items-center"  *ngIf="partnerDict[item.UserId].t.length > 3">
                                                <div class="px-1 py-0.5 text-info-500 bg-[#E5F2FF] text-caption-2 rounded truncate" tds-popover
                                                    [popoverContent]="popoverContentTag"
                                                    popoverPlacement="topRight">
                                                    +{{partnerDict[item.UserId].t.length - 3}}
                                                </div>

                                                <ng-template #popoverContentTag>
                                                    <div class="flex gap-x-2 flex-wrap max-w-[500px]">
                                                        <div *ngFor="let tag of partnerDict[item.UserId].t | slice: 3:(partnerDict[item.UserId].t.length)" #widthTag
                                                            class="relative flex items-center text-caption-2 text-[11px] font-regular text-neutral-1-900 rounded truncate flex-none">
                                                            <div [ngStyle]="{'background-color': [tag.color_class+'30'] }" tds-tooltip [tooltipTitle]="tag.name"
                                                                class="w-full rounded-md py-0.5 px-1.5 flex justify-center items-center gap-x-1">
                                                                <div class="flex items-center">
                                                                    <span [ngStyle]="{'background-color': [tag.color_class] }"
                                                                    class="-top-px inline-block align-middle rounded-full w-2 h-2"></span>
                                                                </div>
                                                                <span class="flex-auto truncate">{{tag.name}}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </ng-template>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                      <!-- Input trả lời bình luận -->
                      <div class="bg-white rounded-2xl border-b-2 border-primary-1 p-4 mt-3 relative" *ngIf="item.Data?.is_reply" @eventFadeState>
                          <div [ngClass]="isReplyingComment ? '!cursor-wait' : 'hidden'" class="absolute top-0 left-0 z-10 w-full h-full opacity-100"></div>
                          <div class="flex justify-between gap-2 pb-2">

                              <textarea #contentReply tdsInput placeholder="Nhập nội dung tin nhắn, nhấn [Enter] để gửi" [(ngModel)]="messageModel"
                                  [ngModelOptions]="{standalone: true}" (keydown.enter)="onEnter(item, $event)" class="resize-none" rows="2"></textarea>

                              <button tds-button type="button" color="primary" class="!rounded-full" [size]="'lg'" (click)="messageSendingToServer(item)">
                                  <span class="flex items-center px-5">
                                      <i class="tdsi-send-fill text-lg leading-none mr-2"></i> Gửi
                                  </span>
                              </button>
                          </div>

                          <!-- Check Private Reply -->
                          <div class="quick-message gap-5">
                              <div class="check gap-5 flex justify-between">
                                  <tds-checkbox [checked]="item.Data.is_private_reply" (change)="isPrivateReply(item)"> Gửi về tin nhắn </tds-checkbox>

                                  <div class="icon-send flex flex-row mr-2">
                                      <span class="p-1 hover:bg-neutral-3-50 rounded-md" *ngIf="item.Data.is_private_reply" (click)="onProductsbypageFb(item)"
                                          product-show-button  tooltipTitle="Sản phẩm" tooltipPlacement="top" tds-tooltip>
                                          <i class="tdsi-product-line text-xl"></i>
                                      </span>

                                      <span class="p-1  hover:bg-neutral-3-50 rounded-md" container="body" placement="auto"
                                          tds-popover popoverTrigger="click" tooltipTitle="Emoji" tooltipPlacement="top" tds-tooltip
                                          [popoverContent]="infoEmojiMart" [popoverAutoClose]="true"
                                          [popoverBackdrop]="true" popoverPlacement="top">
                                          <i class="tdsi-emotion-line text-xl"></i>

                                          <ng-template #infoEmojiMart>
                                            <div (loadEmojiMart)="loadEmojiMart($event)" icon-emoji-mart></div>
                                          </ng-template>
                                      </span>

                                      <div class="p-1 hover:bg-neutral-3-50 rounded-md flex items-center" tds-tooltip tooltipTitle="Tin nhắn nhanh">
                                          <quick-reply-button (onQuickReplySelected)="onQuickReplySelected($event, partnerDict[item.UserId])"></quick-reply-button>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <!-- Trả lời bình luận -->
                      <div *ngIf="childs[item.Id] && isHiddenComment[item.Id]" @eventFadeState>
                          <div *ngFor="let child of childs[item.Id]" class="mt-3">
                              <div *ngIf="child" class="flex">

                                  <tpage-avatar-facebook [shape]="'circle'" [size]="'lg'" [psid]="child.from?.id" [token]="team.ChannelToken">
                                  </tpage-avatar-facebook>

                                  <div class="list bg-white rounded-2xl ml-2 p-4 w-full">

                                      <div class="flex justify-between">
                                          <div class="flex flex-row items-center">
                                              <label class="font-semibold">{{child.from?.name}}</label>

                                              <div *ngIf="commentOrders">
                                                  <a class="text-info-500 font-semibold" *ngFor="let order of commentOrders[child.from.id]"
                                                      (click)="loadOrderByCode(order.id, child)"> {{order.code}} </a>
                                              </div>
                                          </div>
                                          <span class="text-neutral-1-400 text-right text-caption-1">{{child.created_time | date:'dd/MM/yyyy HH:mm aa'}}</span>
                                      </div>

                                      <!-- nội dung tin nhắn -->
                                      <div [innerHTML]="child.message | safeHtml"></div>

                                      <!-- hình ảnh -->
                                      <div *ngIf="child.attachment">
                                          <img tds-image *ngIf="child.attachment?.type != 'sticker'"
                                            [tdsSrc]="child.attachment?.media?.image?.src" style="max-width: 200px;"/>
                                          <img tds-image *ngIf="child.attachment?.type == 'sticker'"
                                            [tdsSrc]="child.attachment?.media?.image?.src" style="max-width: 100px;"/>
                                      </div>

                                      <div class="flex pt-4">
                                          <button (click)="loadPartnerTab(child)" type="button" tds-button-icon color="secondary" class="mr-2"
                                              tooltipTitle="Thông tin" tooltipPlacement="top" tds-tooltip >
                                              <span class="flex items-center justify-center"> <i class="tdsi-information-fill"></i></span>
                                          </button>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <!-- Phản hồi bình luận -->
                      <div *ngFor="let data of childsComment; let i= index; trackBy: trackByIndex" class="flex flex-auto w-full">
                        <div *ngIf="data && data.ParentId == item.Data?.id" class="flex flex-auto w-full mt-3" @eventFadeState>

                            <tpage-avatar-facebook [shape]="'circle'" [size]="'md'" [psid]="data.UserId" [token]="team.ChannelToken">
                            </tpage-avatar-facebook>

                            <div class="ml-2 w-full h-full">
                                <div class="bg-white rounded-2xl px-4 py-3">
                                    <div class="flex items-center justify-between">
                                        <div class="flex gap-x-2">
                                            <label class="font-semibold" *ngIf="data.Data && data.Data?.from">{{ data.Data.from.name }} </label>

                                            <div *ngIf="commentOrders && item?.Data?.from" class="flex flex-row items-center">
                                                <div *ngFor="let order of commentOrders[data.Data?.from!.id]"  class="text-info-500 font-semibold flex flex-row items-center gap-2">
                                                    <div class="flex flex-row cursor-pointer hover:underline" (click)="loadOrderByCode(order.id, item)">
                                                        <span *ngIf="!order.code.includes('#')">#</span>{{order.code}}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <span class="text-neutral-1-400 text-right text-caption-1">{{data.CreatedTime | date:'dd/MM/yyyy HH:mm aa'}}</span>
                                    </div>

                                    <!-- nội dung bình luận -->
                                    <div class="flex flex-row gap-x-3">
                                        <div [innerHTML]="data.Message | formatIconLike | bbcodeConvert | safeHtml "></div>
                                        <!-- <button *ngIf="!data.IsOwner" tooltipTitle="Thêm vào ghi chú" tds-tooltip="" tooltipPlacement="top"
                                            class="rounded-full h-5 w-5 border border-primary-1 text-primary-1 flex justify-center items-center">
                                            <span class="tdsi-plus-fill"></span>
                                        </button> -->
                                    </div>

                                    <!-- hình ảnh đính kèm -->
                                    <div *ngIf="data.Data?.attachment">
                                        <img tds-image *ngIf="data.Data?.attachment?.type != 'sticker'" [tdsSrc]="data.Data.attachment?.media?.image?.src"
                                          class="max-w-[200px]" />
                                        <img tds-image *ngIf="data.Data?.attachment?.type == 'sticker'" [tdsSrc]="data.Data.attachment?.media?.image?.src"
                                          class="max-w-[100px]" />
                                    </div>

                                    <!-- thao tác -->
                                    <div class="flex items-center pt-3" *ngIf="!data.IsOwner">
                                        <button type="button" tds-button color="primary" class="mr-2" size="sm" (click)="onInsertFromPost(item)"> Tạo đơn hàng  </button>

                                        <button type="button" tds-button-icon color="secondary" class="mr-2" size="sm" tooltipTitle="Thông tin khách hàng"
                                            tooltipPlacement="top" (click)="loadPartnerTab(item)" tds-tooltip>
                                            <span class="flex items-center justify-center">
                                                <i class="tdsi-information-fill text-neutral-1-500"></i>
                                            </span>
                                        </button>

                                        <button type="button" tds-button-icon color="secondary" class="mr-2" size="sm" tooltipTitle="Phản hồi bình luận" tooltipPlacement="top" tds-tooltip (click)="isReply(item, 'child')">
                                            <span class="flex items-center justify-center">
                                                <i class="tdsi-reply-fill text-neutral-1-500"></i>
                                            </span>
                                        </button>

                                        <button type="button" tds-button-icon color="secondary" class="mr-2" size="sm" tooltipTitle="Hội thoại tin nhắn" tooltipPlacement="top" tds-tooltip (click)="openMiniChat(item)">
                                            <span class="flex items-center justify-center">
                                                <i class="tdsi-messenger-fill text-neutral-1-500"></i>
                                            </span>
                                        </button>
        
                                        <div *ngIf="childs[data.Id]">
                                            <button type="button" *ngIf="isHiddenComment[data.Id]" tds-button-icon color="secondary" (click)="hiddenComment(item, true)" class="mr-2" size="sm" tooltipTitle="Ẩn thị bài viết" tooltipPlacement="top" tds-tooltip>
                                                <span class="flex items-center justify-center">
                                                    <i class="tdsi-eye-close-fill text-neutral-1-500"></i>
                                                </span>
                                            </button>

                                            <button type="button" *ngIf="!isHiddenComment[data.Id]" tds-button-icon color="secondary" (click)="hiddenComment(item, false)" class="mr-2" size="sm" tooltipTitle="Hiển thị bài viết" tooltipPlacement="top" tds-tooltip>
                                                <span class="flex items-center justify-center">
                                                    <i class="tdsi-eye-line text-neutral-1-500"></i>
                                                </span>
                                            </button>
                                        </div>

                                        <div *ngIf="partnerDict && partnerDict[data.UserId]" class="w-full flex flex-row items-center justify-between">
                                            <!-- trạng thái khách hàng & mã đơn hàng -->
                                            <div class="flex items-center gap-1.5">

                                                <!-- trạng thái khách hàng -->
                                                <div *ngIf="partnerDict[data.UserId]" class="button-status flex items-center gap-1.5 mr-4">
                                                    <span *ngIf="partnerDict[data.UserId].p" class="h-5 w-5 bg-base-green-400 flex items-center justify-center rounded-md cursor-pointer">
                                                        <i class="tdsi-call-fill text-body-2 leading-none text-white"></i>
                                                    </span>

                                                    <span *ngIf="partnerDict[data.UserId].a" class="h-5 w-5 bg-base-orange-500 flex items-center justify-center rounded-md cursor-pointer">
                                                        <i class="tdsi-pin-fill text-body-2 leading-none text-white"></i>
                                                    </span>

                                                    <div *ngIf="partnerDict[data.UserId].st" [ngStyle]="{'background-color': partnerDict[data.UserId].ss+'30', 'border-color': partnerDict[data.UserId].ss, 'color': partnerDict[data.UserId].ss}"
                                                        class="border font-semibold px-2 py-0.5 rounded text-caption-2 ">
                                                        {{partnerDict[data.UserId].st}}
                                                    </div>
                                                </div>
                                            </div>

                                            <div *ngIf="partnerDict[data.UserId].t" class="justify-end flex-col gap-2 tag-status flex-auto xl:hidden 2xl:flex">
                                                <div class="flex gap-2">
                                                    <div class="flex-auto flex flex-nowrap gap-1 justify-end items-center overflow-hidden" #currentWidthTag>
                                                        <div class="flex gap-x-1">
                                                            <div *ngFor="let tag of partnerDict[data.UserId].t | slice: 0:3" #widthTag
                                                                class="relative flex items-center text-caption-2 text-[11px] max-w-[110px] font-regular text-neutral-1-900 rounded truncate flex-none">
                                                                <div *ngIf="tag" [ngStyle]="{'background-color': [tag.color_class+'30'] }" tds-tooltip [tooltipTitle]="tag.name"
                                                                    class="w-full rounded-md py-0.5 px-1.5 flex justify-center items-center gap-x-1">
                                                                    <div class="flex items-center">
                                                                        <span [ngStyle]="{'background-color': [tag.color_class] }"
                                                                        class="-top-px inline-block align-middle rounded-full w-2 h-2"></span>
                                                                    </div>
                                                                    <span class="flex-auto truncate">{{tag.name}}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="flex gap-1.5 items-center"  *ngIf="partnerDict[data.UserId].t.length > 3">
                                                        <div class="px-1 py-0.5 text-info-500 bg-[#E5F2FF] text-caption-2 rounded truncate" tds-popover
                                                            [popoverContent]="popoverContentTag"
                                                            popoverPlacement="topRight">
                                                            +{{partnerDict[data.UserId].t.length - 3}}
                                                        </div>

                                                        <ng-template #popoverContentTag>
                                                            <div class="flex gap-x-2 flex-wrap max-w-[500px]">
                                                                <div *ngFor="let tag of partnerDict[data.UserId].t | slice: 3:(partnerDict[data.UserId].t.length)" #widthTag
                                                                    class="relative flex items-center text-caption-2 text-[11px] font-regular text-neutral-1-900 rounded truncate flex-none">
                                                                    <div [ngStyle]="{'background-color': [tag.color_class+'30'] }" tds-tooltip [tooltipTitle]="tag.name"
                                                                        class="w-full rounded-md py-0.5 px-1.5 flex justify-center items-center gap-x-1">
                                                                        <div class="flex items-center">
                                                                            <span [ngStyle]="{'background-color': [tag.color_class] }"
                                                                            class="-top-px inline-block align-middle rounded-full w-2 h-2"></span>
                                                                        </div>
                                                                        <span class="flex-auto truncate">{{tag.name}}</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </ng-template>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</tds-spin>

<tds-drawer [visible]="isOpenDrawer"
    [bodyStyle]="{'background-color':'rgb(235 237 239)','overflow':'hidden','display': 'flex','flex-direction': 'column','padding': '0'}"
    [placement]="'right'" [title]="titleMessage" (onClose)="closeDrawer()" [width]="'50vw'">
    <ng-template #titleMessage>
      <span class="flex w-full items-center text-title-1 font-semibold text-neutral-900">
        Gửi tin nhắn Facebook
      </span>
    </ng-template>
    <ng-container *tdsDrawerContent>   
        <div class="w-full h-full flex overflow-hidden bg-neutral-3-200" cdkScrollable>
          <div *ngIf="currentConversation && team" class="w-full">
            <shared-tds-conversations-v2 class="flex w-full h-full" [team]="team"
              [data]="currentConversation" [type]="'all'">
            </shared-tds-conversations-v2>
          </div>
        </div>
    </ng-container>
</tds-drawer>
