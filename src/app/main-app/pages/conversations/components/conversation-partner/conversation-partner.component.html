<div *ngIf="data?.id">
  <form [formGroup]="_form" novalidate>
    <div class="w-full h-[calc(100vh-109px)] bg-neutral-3-100 overflow-y-auto tds-custom-scroll flex-col flex">
      <div class="bg-white px-6 py-4">
        <div class="flex gap-6">
          <tpage-avatar-facebook [shape]="'circle'" [size]="'lg'" [psid]="data.psid" [token]="team?.Facebook_PageToken">
          </tpage-avatar-facebook>
          <div class="flex flex-col gap-2">
            <div class="flex gap-4 items-center" style="min-height: 34px;">
              <div class="text-heading-4 font-sans font-semibold text-neutral-1-900">
                  {{_form.controls['Name'].value}}
              </div>
              <button tds-button color="secondary" (click)="onEditPartner()" *ngIf="!isEditPartner">
                <span class="flex items-center ">
                  <i class="tdsi-edit-fill text-xl leading-none text-neutral-1-400"></i>
                </span>
              </button>
            </div>
            <div class="flex gap-2">
              <tds-button-group>
                <div tds-button color="secondary" tds-dropdown trigger="click" [tdsDropdownMenu]="menu"
                  class="border border-solid rounded-md px-2" [ngStyle]="{'border-color': getStatusColor() }">
                  <span class="flex items-center text-caption-2 font-semibold text-accent-6 font-sans cursor-pointer" [ngStyle]="{'color': getStatusColor() }">
                    {{ partner ? partner?.status_text : 'Bình thường' }} <i class="tdsi-arrow-down-fill text-lg leading-none ml-1"></i>
                  </span>
                </div>
                <tds-dropdown-menu #menu="tdsDropdownMenu">
                  <div class="w-full">
                    <div tds-dropdown-item *ngFor="let status of lstPartnerStatus" (click)="selectStatus(status)">
                      <a [ngStyle]="{'color': status.value }"> {{ status.text }} </a>
                    </div>
                  </div>
                </tds-dropdown-menu>
              </tds-button-group>
              <div class="text-body-2 font-regular font-sans text-neutral-1-400">ID: <span
                  class="font-semibold">{{_form.controls['Id'].value}}</span></div>
            </div>
          </div>
        </div>
        <div class="pt-6 flex flex-col gap-3" *ngIf="!isEditPartner">
          <div class="flex gap-2 items-center">
            <div
              class="tdsi-call-fill px-1 bg-neutral-3-50 text-neutral-1-400 text-xl rounded-[10px]">
            </div>
            <div class="flex items-center gap-1">
                <div class="text-neutral-1-900 text-body-2 font-regular font-sans">
                  {{_form.controls['Phone'].value || 'Chưa có SĐT'}}
                </div>
                <div class="tdsi-success-fill text-xl text-primary-1" *ngIf="!_form.value?.PhoneReport" (click)="showModalListBlock()"></div>
                <div class="tdsi-success-fill text-xl text-accent-3" *ngIf="_form.value?.PhoneReport" (click)="showModalListBlock()"></div>
            </div>
          </div>
          <div class="flex gap-2 items-center">
            <div
              class="tdsi-email-fill px-1 bg-neutral-3-50 text-neutral-1-400 text-xl rounded-[10px]">
            </div>
            <div class="text-neutral-1-900 text-body-2 font-regular font-sans">
              {{_form.controls['Email'].value || 'Chưa có Email'}}
            </div>
          </div>
          <div class="flex gap-2 items-center">
            <div
              class="tdsi-pin-fill px-1 bg-neutral-3-50 text-neutral-1-400 text-xl rounded-[10px]">
            </div>
            <div class="text-neutral-1-900 text-body-2 font-regular font-sans">
              {{_form.controls['Street'].value || 'Chưa có địa chỉ'}}
            </div>
          </div>
        </div>
        <div class="pt-4 flex gap-2 pb-4" *ngIf="!isEditPartner">
          <tds-button-group>
            <button tds-dropdown color="secondary" trigger="click" [tdsDropdownMenu]="menuRevenue"
              class="rounded-full border border-neutral-2-100 border-solid bg-white py-1.5 px-4">
              <span class="flex items-center text-body-2 font-semibold text-neutral-1-500 cursor-pointer">
                Tổng doanh số: <span class="pl-2 text-primary-1">{{objRevenue?.RevenueTotal || 0 | number: '1.0-3'}}đ</span><i
                  class="tdsi-arrow-down-line text-lg leading-none ml-2"></i>
              </span>
            </button>
            <tds-dropdown-menu #menuRevenue="tdsDropdownMenu">
              <div class="w-full">
                  <div tds-dropdown-item>Doanh số đầu kỳ:{{objRevenue?.RevenueBegan || 0 | number: '1.0-3'}}đ</div>
                  <div tds-dropdown-item>Doanh số: {{objRevenue?.Revenue || 0 | number: '1.0-3'}}đ</div>
                  <div tds-dropdown-item>Tổng doanh số: {{objRevenue?.RevenueTotal || 0 | number: '1.0-3'}}đ</div>
              </div>
            </tds-dropdown-menu>
          </tds-button-group>
          <button class="border border-neutral-2-100 border-solid px-4 rounded-full" (click)="showModalBlockPhone()">
            <span class="flex items-center text-body-2 font-semibold font-sans text-neutral-1-900">
              <i class="tdsi-block-fill text-lg mr-2 text-neutral-1-400"></i> Chặn SĐT
            </span>
          </button>
        </div>
      </div>
      <!-- Xử lý ghi chú -->
      <div class="bg-white pt-0 p-4" *ngIf="!isEditPartner">
        <div class="flex items-center gap-2 pb-3">
          <tds-form-field class="w-full">
              <input class="placeholder-neutral-1-400 bg-neutral-3-50" placeholder="Nhập ghi chú" tdsInput (keyup.enter)="addNote()"
                [(ngModel)]="innerNote" [ngModelOptions]="{standalone: true}" />
          </tds-form-field>
          <button tds-button color="primary" (click)="addNote()">
            <span class="flex items-center">
              <i class="tdsi-plus-fill text-lg leading-none mr-2"></i>Thêm
            </span>
          </button>
        </div>
        <div class="pl-2 flex flex-col gap-3 overflow-auto overflow-y-auto tds-custom-scroll max-h-[200px]" *ngIf="noteData.items.length > 0">
          <div class="border-l border-primary-1 border-solid pl-2 " *ngFor="let item of noteData.items; let i=index">
            <div class="text-neutral-1-400 text-body-2 font-regular font-sans">{{item.DateCreated | date:'HH:mm dd/MM/yyyy'}}</div>
            <div class="flex gap-2 pt-1">
              <div class="text-body-2 font-semibold font-sans text-neutral-1-900">{{item.CreatedBy.Name}} ({{item.CreatedBy.UserName}})</div>
              <div class="text-body-2 font-regular font-sans text-neutral-1-900" tds-typography ellipsis expandable
                [ellipsisRows]="2" [content]="item.message" [contentCollapse]="'Ẩn'">
              </div>
              <button tds-button color="error" (click)="removeNote(item.id, i)">
                  <span class="flex items-center">
                      <i class="tdsi-trash-line text-lg leading-none"></i>
                  </span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Phiếu bán hàng -->
      <div class="pt-1" *ngIf="!isEditPartner && totalBill > 0">
        <tds-collapse [expandIconPosition]="'right'" class="bg-white">
          <tds-collapse-panel [header]="headerSalesDetails" [active]="true" [disabled]=false
            [expandedIcon]="'tdsi-arrow-up-line'">
            <ng-template #headerSalesDetails>
              <div class="flex items-center gap-4">
                <tds-avatar size="lg" tdsSrc="/assets/images/conversation/avatar-salesslip.svg">
                </tds-avatar>
                <div class="flex flex-col gap-1">
                  <div class="text-neutral-1-400 font-regular text-body-2 font-sans">Phiếu bán hàng gần nhất</div>
                  <div class="flex gap-2 items-center" *ngIf="lastBill">
                    <div class="text-info-500 text-header-1 font-sans font-semibold">
                      #{{ lastBill.Number || 'N/A' }}</div>
                    <div>
                      <tds-tag status='primary' type="outline" [status]="getColorStatusText(lastBill.ShowState)">
                        {{ lastBill.ShowState }}
                      </tds-tag>
                    </div>
                  </div>
                </div>
              </div>
            </ng-template>

            <div class="w-full h-full flex flex-col gap-1.5" *ngIf="lastBill">
              <div class="flex gap-3 items-center">
                <div><img src="/assets/images/conversation/avatar-ghn.svg"></div>
                <div class="text-body-2 font-semibold font-sans text-neutral-1-900">
                  {{ lastBill.CarrierName }}
                </div>
                <div class="text-body-2 font-regular font-sans text-neutral-1-900">
                  [ {{ lastBill.ShowState }} - <span class="text-info-500 pl-0.5">{{ lastBill.TrackingRef || '#N/A' }}</span>]
                </div>
              </div>
              <div class="text-body-2 font-regular font-sans text-neutral-1-400">
                Tổng tiền: <span class="text-neutral-1-900 pl-0.5">{{ lastBill.AmountTotal }} ({{ lastBill.PaymentJournalName }})</span>
              </div>
              <div class="text-body-2 font-regular font-sans text-neutral-1-400">
                Thời gian giao hàng: <span class="text-neutral-1-900 pl-0.5">{{ lastBill.DateCreated | date: "HH:mm, dd/MM/yyyy" }}</span>
              </div>
              <div class="text-body-2 font-regular font-sans text-neutral-1-400">
                {{ lastBill.Phone }} - {{ lastBill.Address }} </div>
              <div class="text-body-2 font-semibold font-sans text-accent-3"> {{ lastBill.DeliveryNote }} </div>
            </div>
          </tds-collapse-panel>
        </tds-collapse>
      </div>
      <div class="pt-1" *ngIf="!isEditPartner && totalBill > 0">
        <tds-collapse [expandIconPosition]="'right'" class="bg-white" [bordered]="false">
          <tds-collapse-panel [header]="headerListSales" [active]="true" [disabled]=false [expandedIcon]="'tdsi-arrow-up-line'">
            <ng-template #headerListSales>
              <div class="flex items-center gap-4">
                <div class="text-neutral-1-900 font-semibold text-header-1 font-sans">Phiếu bán hàng</div>
                <div>
                  <tds-badge [standalone]="true" [count]="totalBill"></tds-badge>
                </div>
              </div>
            </ng-template>

            <div class="w-full h-full">
              <div class="w-full">

                <tds-filter-status (selectChange)="onChangeBill($event)" [ngModel]='tabBillCurrent' [ngModelOptions]="{standalone: true}">
                  <tds-filter-status-item *ngFor="let bills of lstBill; let index = index"
                    [name]='bills.data[0].ShowState' [value]='index' [count]='bills.total'>
                    <ng-template tds-filter-status-template let-active='active' let-count='count' let-name='name' let-value>
                      <div class="py-1 px-2 flex items-center border border-neutral-2-100 border-solid rounded-full mr-2"
                        [ngClass]="{' border-primary-1':active,'border-neutral-2-100 group-hover:border-primary-1':!active}">
                          <div class="text-body-2 mr-2 font-semibold" [ngClass]="{'text-primary-1':active,'text-neutral-1-400 group-hover:text-primary-1':!active}">
                            {{name}}&nbsp; {{count}}
                          </div>
                      </div>
                    </ng-template>
                  </tds-filter-status-item>
                </tds-filter-status>

              </div>
              <div class="pt-4 flex flex-col gap-2 w-full" *ngIf="lstBill">
                <tds-collapse *ngFor="let bill of lstBill[tabBillCurrent]?.data; let index = index">
                  <tds-collapse-panel [header]="headerBill" [active]="false" [disabled]=false>
                    <ng-template #headerBill>
                      <div class="flex gap-4 w-full content-center items-center">
                        <div class="flex flex-col gap-0.5 pr-10">
                          <div class="text-info-500 font-semibold text-body-2 font-sans">
                            #{{bill.Number || 'N/A'}}
                          </div>
                          <div class="text-neutral-1-400 text-caption-2 font-regular">
                            {{bill.DateCreated | date: "HH:mm, dd/MM/yyyy"}}
                          </div>
                        </div>
                        <div class="text-neutral-1-900 text-body-2 font-semibold pr-10">
                          {{bill.AmountTotal | number}}đ
                        </div>
                        <div>
                          <tds-tag status='primary' type="outline" [status]="getColorStatusText(bill.ShowState)">
                            {{ bill.ShowState }}
                          </tds-tag>
                        </div>
                      </div>
                    </ng-template>
                    <div class="w-full flex flex-col gap-4">
                      <div class="flex items-center">
                        <div class="w-1/4">
                          <div class="text-body-2 font-regular text-neutral-1-900 font-sans">
                            Đối tác GH:
                          </div>
                        </div>
                        <div class="w-3/4 flex gap-1">
                          <div><img src="/assets/images/conversation/avatar-ghn.svg">
                          </div>
                          <div class="font-semibold text-body-2 font-sans text-neutral-1-900">
                            {{ bill.CarrierName }} - <span class="text-info-500">{{ lastBill?.TrackingRef || '#N/A' }}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </tds-collapse-panel>
                </tds-collapse>
              </div>
            </div>
          </tds-collapse-panel>
        </tds-collapse>
      </div>
      <div class="pt-1 flex-auto" *ngIf="!isEditPartner && totalBill < 1">
        <div class="flex flex-col gap-4 p-4 items-center bg-white h-full">
          <img src="../../../assets/images/shop-empty.svg" alt="" class="mt-24 w-[110px] h-[82px]">
          <span class="text-neutral-1-400 font-normal">Chưa có phiếu bán hàng nào</span>
          <button tds-button color="primary" class="mt-3.5" (click)="createOrder()">
            <span class="flex items-center">
              <i class="tdsi-add-fill text-lg leading-none mr-2"></i>Tạo đơn hàng
            </span>
          </button>
        </div>
      </div>

      <!-- Edit khách hàng -->
      <div class="pt-1" *ngIf="isEditPartner">
        <div class="flex flex-col gap-4 bg-white p-4">
          <tds-form-field>
            <tds-label>
              Tên khách hàng
            </tds-label>
            <input tdsInput placeholder="Nhập tên khách hàng" [required]='true' formControlName="Name" />
          </tds-form-field>

          <div class="flex gap-5">
            <tds-form-field class="w-1/2">
                <tds-label>
                  Số điện thoại
                </tds-label>
              <input tdsInput placeholder="Nhập số điện thoại" formControlName="Phone" />
            </tds-form-field>

            <tds-form-field class="w-1/2">
              <tds-label>
                Email
              </tds-label>
              <input tdsInput autocomplete="off"  placeholder="Nhập email" formControlName="Email" />
            </tds-form-field>
          </div>

          <tds-form-field>
            <tds-label>Ghi chú</tds-label>
            <input tdsInput placeholder="Nhập ghi chú" formControlName="Comment" />
          </tds-form-field>

          <div class="flex flex-col gap-y-2">
            <tds-label>Địa chỉ</tds-label>
            <tpage-conversation-address class="w-full"
              [streetText]="_form.value['Street']"
              [cityCode]="_form.value['City']?.code"
              [districtCode]="_form.value['District']?.code"
              [wardCode]="_form.value['Ward']?.code"
              (onChangeAddress)="onChangeAddress($event)">
            </tpage-conversation-address>
          </div>

          <div class="mt-4">
            <button tds-button class="w-[100px]" type="submit" color="primary" (click)="onSaveEdit()" [disabled]="!_form?.valid">Lưu</button>
            <button tds-button class="ml-3 w-[100px]" color="secondary" (click)="onCancelEdit()">Hủy bỏ</button>
          </div>

        </div>
      </div>
    </div>
  </form>
</div>
