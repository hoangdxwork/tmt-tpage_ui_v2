<tds-spin [spinning]="isLoading" class="flex w-full h-[calc(100vh-109px)] overflow-hidden">

  <div *ngIf="partner && conversationItem; else noData">
      <div class="w-full h-[calc(100vh-109px)] bg-neutral-3-100 overflow-hidden overflow-y-auto tds-custom-scroll flex-col flex">
          <!-- Thông tin khách hàng -->
          <div class="bg-white px-4 py-4">
              <div *ngIf="isEditPartner && partner" class="pb-6">
                <button tds-button color="secondary" rounded="!rounded-full" (click)="onCancelEdit()">
                  <span class="flex items-center">
                    <i class="tdsi-back-fill text-neutral-1-400 text-lg leading-none mr-2"></i>Trở lại
                  </span>
                </button>
              </div>
              <div class="flex gap-6">

                <!-- Facebook -->
                <tpage-avatar-facebook *ngIf="team.Type =='Facebook'" [shape]="'circle'" [size]="'lg'" [psid]="conversationItem.ConversationId" [token]="team.ChannelToken">
                </tpage-avatar-facebook>

                <!-- Tshop -->
                <tds-avatar *ngIf="team.Type =='TShop'" [size]="'lg'" [tdsSrc]="conversationItem.Avatar?.Url" [isAvatar]="true"></tds-avatar>

                <!-- Tiktok -->
                <tds-avatar *ngIf="team.Type =='UnofficialTikTok'" [size]="'lg'" [tdsSrc]="conversationItem.Avatar?.Url" [isAvatar]="true"></tds-avatar>

                <div class="flex flex-col gap-2">
                    <div class="flex gap-4 items-center" style="min-height: 34px;">
                        <div class="font-sans font-semibold text-neutral-1-900 text-[20px]">
                            {{partner.Name || conversationItem.Name}}
                        </div>
                        <button type="button" size="sm" tds-button-icon color="secondary" tds-tooltip="Chỉnh sửa" (click)="onEditPartner()" *ngIf="!isEditPartner">
                            <span class="flex items-center">
                              <i class="tdsi-edit-fill text-xl leading-none text-neutral-1-400"></i>
                            </span>
                        </button>
                    </div>

                    <div class="flex gap-2" *ngIf="partner.Id">
                        <tds-button-group>

                          <div tds-button color="secondary" tds-dropdown trigger="click" [tdsDropdownMenu]="menu" [placement]="'bottomRight'"
                              class="border border-solid rounded-md px-2" [ngStyle]="getStatusColor(partner.StatusText) | buttonStatusColor">
                              <span class="flex items-center text-caption-2 font-semibold font-sans cursor-pointer">
                                  {{ partner.StatusText || 'Bình thường' }} <i class="tdsi-arrow-down-fill text-lg leading-none ml-1"></i>
                              </span>
                          </div>

                          <tds-dropdown-menu #menu="tdsDropdownMenu">
                              <div class="w-full max-h-[300px] overflow-y-auto tds-panel-scroll">
                                  <div tds-dropdown-item *ngFor="let x of lstPartnerStatus" (click)="selectStatus(x)" class="flex items-center gap-x-2">
                                      <a [ngStyle]="{'background-color': x.value }" class="w-2 h-2 rounded-full"></a>
                                      <span class="text-neutral-1-900 desktop:text-body-2 laptop:text-caption-1">{{ x.text }} </span>
                                  </div>
                              </div>
                          </tds-dropdown-menu>
                        </tds-button-group>

                        <div class="desktop:text-body-2 laptop:text-caption-1 font-regular font-sans text-neutral-1-400">
                            ID: <span class="font-semibold">{{partner.Id}}</span>
                        </div>
                    </div>
                </div>
              </div>

              <div class="pt-6 flex flex-col desktop:gap-3 laptop:gap-2" *ngIf="!isEditPartner">
                  <div class="flex gap-2 items-center">
                      <div class="tdsi-call-fill px-1 bg-neutral-3-50 text-neutral-1-400 text-xl rounded-[10px]"></div>

                      <div class="flex items-center gap-1">
                            <div class="text-neutral-1-900 desktop:text-body-2 laptop:text-caption-1 font-regular font-sans">{{partner.Phone || 'Chưa có SĐT'}} </div>
                            <!-- <div class="tdsi-success-fill text-sm text-primary-1 cursor-pointer" *ngIf="!partner.PhoneReport && partner.Phone" (click)="onlListPhoneBlock()"></div>
                            <div class="tdsi-success-fill text-sm text-accent-3  cursor-pointer" *ngIf="partner.PhoneReport && partner.Phone" (click)="onBlockPhone()"></div> -->
                      </div>
                  </div>

                  <div class="flex gap-2 items-center">
                      <div class="tdsi-email-fill px-1 bg-neutral-3-50 text-neutral-1-400 text-xl rounded-[10px]"></div>
                      <div class="text-neutral-1-900 desktop:text-body-2 laptop:text-caption-1 font-regular font-sans">{{partner.Email  || 'Chưa có Email'}}</div>
                  </div>

                  <div class="flex gap-2 items-center">
                      <div class="tdsi-pin-fill px-1 bg-neutral-3-50 text-neutral-1-400 text-xl rounded-[10px]"> </div>
                      <div class="text-neutral-1-900 desktop:text-body-2 laptop:text-caption-1 font-regular font-sans">{{partner.Street || 'Chưa có địa chỉ'}} </div>
                  </div>
              </div>

              <div class="pt-3 flex gap-2" *ngIf="!isEditPartner && revenue">
                  <tds-button-group>
                      <button type="button" tds-dropdown color="secondary" trigger="click" [tdsDropdownMenu]="menuRevenue"
                          class="rounded-full border border-neutral-2-100 border-solid bg-white py-1.5 2xl:px-4 px-2">
                          <span class="flex items-center desktop:text-body-2 laptop:text-caption-1 font-semibold text-neutral-1-500 cursor-pointer whitespace-nowrap">
                              Tổng doanh số: <span class="pl-2 text-primary-1">{{revenue.RevenueTotal || 0 | numberCustom }} đ</span>
                              <i class="tdsi-arrow-down-line text-lg leading-none ml-2"></i>
                          </span>
                      </button>

                      <tds-dropdown-menu #menuRevenue="tdsDropdownMenu">
                          <div class="w-full">
                              <div tds-dropdown-item>Doanh số đầu kỳ: {{revenue.RevenueBegan || 0 | numberCustom }} đ</div>
                              <div tds-dropdown-item>Doanh số: {{revenue.Revenue || 0 | numberCustom }} đ</div>
                              <div tds-dropdown-item>Tổng doanh số: {{revenue.RevenueTotal || 0 | numberCustom }} đ</div>
                          </div>
                      </tds-dropdown-menu>
                  </tds-button-group>

                  <button type="button" class="border border-neutral-2-100 border-solid 2xl:px-4 px-2 rounded-full" (click)="onBlockPhone()">
                      <span class="flex items-center desktop:text-body-2 laptop:text-caption-1 font-semibold font-sans text-neutral-1-900 whitespace-nowrap">
                          <i class="tdsi-block-fill text-lg mr-2 text-neutral-1-400"></i> Chặn SĐT
                      </span>
                  </button>
              </div>
          </div>

          <!-- Xử lý ghi chú -->
          <div class="bg-white" *ngIf="!isEditPartner">

              <div class="flex items-center gap-2 desktop:p-4 laptop:pb-4 laptop:px-4">
                  <tds-form-field class="w-full">
                      <input class="placeholder-neutral-1-400 bg-neutral-3-50" placeholder="Nhập ghi chú" tdsInput (keyup.enter)="addNote()"
                      [(ngModel)]="innerNote" [ngModelOptions]="{standalone: true}" />
                  </tds-form-field>

                  <button type="button" tds-button color="primary" (click)="addNote()">
                      <span class="flex items-center">
                          <i class="tdsi-plus-fill text-lg leading-none mr-2"></i>Thêm
                      </span>
                  </button>
              </div>

              <div class="overflow-x-hidden overflow-y-auto tds-panel-scroll max-h-[200px]" *ngIf="noteData.items.length > 0">
                <div class="py-3 px-4 flex flex-col gap-3">
                  <div class="border-l-3 border-primary-1 border-solid pl-2 flex w-full items-center justify-between" *ngFor="let item of noteData.items; let i=index">
                    <div class="flex flex-col flex-auto overflow-hidden">
                        <div class="text-neutral-1-400 desktop:text-body-2 laptop:text-caption-1 font-regular font-sans">{{item.DateCreated | date:'HH:mm dd/MM/yyyy'}}</div>
                        <div class="w-full flex gap-2 overflow-hidden">
                          <div class="max-w-[100px] desktop:text-body-2 laptop:text-caption-1 font-semibold font-sans text-neutral-1-900 relative">{{item.CreatedBy.Name}} ({{item.CreatedBy.UserName}})</div>
                          <div class="flex flex-auto overflow-hidden">
                            <div class="w-full flex overflow-hidden">
                              <span class="w-full truncate" [innerHTML]="item.message | safeHtml"></span>
                            </div>
                          </div>
                        </div>
                    </div>
                    <div class="flex w-[28px] px-1" tds-tooltip="Xóa ghi chú">
                        <i class="tdsi-trash-line text-error-500 text-xl cursor-pointer" (click)="removeNote(item.id, i)"></i>
                    </div>
                  </div>
                </div>
              </div>
          </div>

          <!-- Phiếu bán hàng -->
          <div class="pt-1" *ngIf="!isEditPartner && lastInvoice && lastInvoice.Id">
            <tds-collapse [expandIconPosition]="'right'" class="bg-white" style="border: 0; border-radius: 0">
              <tds-collapse-panel [header]="headerSalesDetails" [active]="true" [disabled]=false [expandedIcon]="'tdsi-arrow-up-line'">

                <ng-template #headerSalesDetails>
                    <div class="flex items-center gap-4">
                        <tds-avatar size="lg" tdsSrc="../../../assets/imagesv2/conversation/avatar-salesslip.svg"></tds-avatar>
                        <div class="flex flex-col gap-1">
                            <div class="text-neutral-1-400 font-regular desktop:text-body-2 laptop:text-caption-1 font-sans">Phiếu bán hàng gần nhất</div>

                            <div class="flex gap-2 items-center" *ngIf="lastInvoice">
                                <drawer-detail-bill [isBillNearest]="true" [bill]="lastInvoice"></drawer-detail-bill>
                                <tds-tag status='primary' class="w-full truncate" style="width: auto;"
                                    type="outline" [status]="lastInvoice.ShowState | getColorStatusShowState">
                                    {{lastInvoice.ShowState}}
                                </tds-tag>
                            </div>
                        </div>
                    </div>
                </ng-template>

                <div class="w-full h-full flex flex-col gap-3" *ngIf="lastInvoice && lastInvoice.Id">
                    <div class="flex desktop:gap-3 laptop:gap-2 items-center">
                        <div *ngIf="lastInvoice.CarrierName" class="desktop:text-body-2 laptop:text-caption-1 font-semibold font-sans text-neutral-1-900">
                          <img [src]="lastInvoice.Type | getAvatarCarrier" alt="">
                          <span>
                            {{ lastInvoice.CarrierName || 'Chưa có đối tác'}}
                          </span>
                        </div>

                        <div *ngIf="!lastInvoice.CarrierName" class="desktop:text-body-2 laptop:text-caption-1 italic font-regular font-sans text-neutral-1-900">
                          (Chưa có đối tác)</div>

                        <div class="desktop:text-body-2 laptop:text-caption-1 font-regular font-sans text-neutral-1-900">
                          [{{ lastInvoice.ShowState }}<span class="text-info-500 pl-0.5" *ngIf="lastInvoice.TrackingRef" (click)="onOpenTrackingUrl(lastInvoice)"> - {{ lastInvoice.TrackingRef }}</span>]
                        </div>

                    </div>

                    <div class="desktop:text-body-2 laptop:text-caption-1 font-regular font-sans text-neutral-1-400">
                        Tổng tiền: <span class="text-neutral-1-900 font-semibold pl-0.5">{{ lastInvoice.AmountTotal | numberCustom }} đ ({{ lastInvoice.PaymentJournalName }})</span>
                    </div>

                    <div class="desktop:text-body-2 laptop:text-caption-1 font-regular font-sans text-neutral-1-400">
                        Ngày tạo: <span class="text-neutral-1-900 font-semibold pl-0.5">{{ lastInvoice.DateCreated | date: "HH:mm, dd/MM/yyyy" }}</span>
                    </div>

                    <div class="desktop:text-body-2 laptop:text-caption-1 font-regular font-sans text-neutral-1-400">
                        {{ lastInvoice.Phone }} - {{ lastInvoice.Address }} </div>

                    <div class="text-caption-1 font-semibold font-sans text-accent-3" [innerHtml]="lastInvoice.DeliveryNote | bbcodeConvert"></div>
                </div>
              </tds-collapse-panel>
            </tds-collapse>
          </div>

          <div class="pt-1" *ngIf="!isEditPartner && totalBill > 0" >
            <tds-collapse [expandIconPosition]="'right'" class="bg-white" [bordered]="false"  style="border: 0; border-radius: 0">

              <tds-collapse-panel [header]="headerListSales" [active]="true" [disabled]=false [expandedIcon]="'tdsi-arrow-up-line'">
                <ng-template #headerListSales>
                    <div class="flex items-center gap-4">
                        <div class="text-neutral-1-900 font-semibold text-header-1 font-sans">Phiếu bán hàng</div>
                        <tds-badge [standalone]="true" [count]="totalBill"></tds-badge>
                    </div>
                </ng-template>

                <div class="w-full h-full">
                    <div class="w-full" *ngIf="stateInvoices">
                      <tds-filter-status [ngModel]='tab_Bill' [ngModelOptions]="{standalone: true}" class="gap-2 flex flex-wrap">
                          <tds-filter-status-item *ngFor="let item of stateInvoices; let index = index"
                              [name]='item.Name' [value]='index' [count]='item.Total' (click)="onChangeTabBill(index, item)">

                              <ng-template tds-filter-status-template let-active='active' let-count='count' let-name='name' let-value>

                                <div class="py-1 px-2 flex items-center border border-neutral-2-100 border-solid rounded-full"
                                    [ngClass]="{' border-primary-1':active,'border-neutral-2-100 group-hover:border-primary-1':!active}">
                                    <div class="desktop:text-body-2 laptop:text-caption-1 mr-2 font-semibold" [ngClass]="{'text-primary-1':active,'text-neutral-1-400 group-hover:text-primary-1':!active}">
                                        {{name}}&nbsp; {{count}}
                                    </div>
                                </div>

                              </ng-template>
                          </tds-filter-status-item>
                      </tds-filter-status>
                  </div>

                  <div class="pt-4 flex flex-col gap-2 w-full" *ngIf="lstInvoice">
                      <tds-collapse *ngFor="let item of lstInvoice; let index = index" class="!rounded-xl">
                          <tds-collapse-panel [header]="headerBill" [active]="false" [disabled]="false" class="!rounded-xl">
                              <ng-template #headerBill>
                                  <div class="flex w-full" *ngIf="item">

                                      <div class="w-[40%] flex flex-col gap-x-0.5">
                                          <drawer-detail-bill [bill]="item"></drawer-detail-bill>
                                          <div class="text-neutral-1-400 text-caption-2 font-regular"> {{item.DateCreated | date: "HH:mm, dd/MM/yyyy"}} </div>
                                      </div>

                                      <div class="w-[24%]">
                                          <span class="text-neutral-1-900 desktop:text-body-2 laptop:text-caption-1 font-semibold text-center">{{item.AmountTotal | numberCustom }} đ</span>
                                      </div>

                                      <div class="w-[36%] text-center">
                                          <tds-badge [status]="item.ShowState | getColorStatusShowState" [text]="item.ShowState"></tds-badge>
                                      </div>
                                  </div>
                              </ng-template>

                              <div class="grid grid-cols-3 desktop:gap-x-6 desktop:gap-y-4 laptop:gap-x-2 laptop:gap-y-3 desktop:text-body-2 laptop:text-caption-1 text-caption-1" *ngIf="item">
                                <span>Đối tác GH:</span>
                                <div class="col-span-2 flex gap-1">
                                  <!-- <img width="40px" height="20px" [src]="item?.Type| getAvatarCarrier" alt=""> -->
                                  <div class="font-semibold">{{item.CarrierName || '---'}} <span *ngIf="item.CarrierName" class="text-info-500 cursor-pointer" (click)="onOpenTrackingUrl(item)">- {{item.TrackingRef || '#N/A'}}</span></div>
                                </div>

                                <span>Phương thức TT:</span>
                                <div class="col-span-2 flex gap-1">
                                    <div class="font-semibold">{{item.PaymentJournalName}}</div>
                                </div>

                                <span>Điện thoại:</span>
                                <div class="w-full col-span-2 flex gap-1">
                                    <div class="font-semibold">{{item.Phone}}</div>
                                </div>

                                <span>Địa chỉ:</span>
                                <div class="w-full col-span-2 flex gap-1">
                                    <div class="font-semibold">{{item.Address}}</div>
                                </div>

                                <span>Trạng thái GH:</span>
                                <div class="w-full col-span-2 flex gap-1">
                                  <span class="text-info-400 cursor-pointer border-b border-info-400 border-dashed">
                                    {{item.ShipPaymentStatus}}
                                  </span>
                                </div>

                                <div class="flex flex-row items-center justify-end w-full col-span-3">
                                    <button tds-button color="primary" class="mr-2" (click)="editBill(item)">Sửa</button>
                                    <button *ngIf="item.State === 'open'" tds-button color="primary" (click)="showPaymentModal(item)">Thanh toán</button>
                                </div>
                              </div>
                          </tds-collapse-panel>
                      </tds-collapse>
                  </div>
                </div>
              </tds-collapse-panel>
            </tds-collapse>
          </div>

          <div class="pt-1 flex-auto" *ngIf="!isEditPartner && totalBill < 1 && type != 'post'">
              <div class="flex flex-col gap-4 p-4 items-center bg-white h-full">
                  <img src="../../../assets/imagesv2/shop-empty.svg" alt="" class="mt-24 w-[110px] h-[82px]">
                  <span class="text-neutral-1-400 font-normal">Chưa có phiếu bán hàng nào</span>

                  <button type="button" tds-button color="primary" class="mt-3.5" (click)="onTabOrder()">
                      <span class="flex items-center">
                          <i class="tdsi-add-fill text-lg leading-none mr-2"></i>Tạo đơn hàng
                      </span>
                  </button>
              </div>
          </div>

          <!-- Edit khách hàng -->
          <div class="pt-1" *ngIf="isEditPartner && partner">
              <div class="flex flex-col gap-4 bg-white p-4">
                  <tds-form-field>
                      <tds-label> Tên khách hàng </tds-label>
                      <input tdsInput placeholder="Nhập tên khách hàng" [required]='true'  [(ngModel)]="partner.Name" [ngModelOptions]="{standalone: true}"/>
                  </tds-form-field>

                  <div class="flex gap-5">

                      <tds-form-field class="w-1/2">
                          <tds-label> Số điện thoại</tds-label>
                          <div tdsAddOnRight tds-tooltip="Kiểm tra số điện thoại" (click)="checkAddressByPhone()"><i class="tdsi-search-fill text-xl leading-none"></i></div>
                          <input tdsInput placeholder="Nhập số điện thoại" [(ngModel)]="partner.Phone" [ngModelOptions]="{standalone: true}"/>
                      </tds-form-field>

                      <tds-form-field class="w-1/2">
                          <tds-label> Email </tds-label>
                          <input tdsInput autocomplete="off"  placeholder="Nhập email" [(ngModel)]="partner.Email" [ngModelOptions]="{standalone: true}"/>
                      </tds-form-field>
                  </div>

                  <tds-form-field>
                      <tds-label>Ghi chú</tds-label>
                      <textarea tdsInput placeholder="Nhập ghi chú" class="resize-none no-scrollbar" [(ngModel)]="partner.Comment" [ngModelOptions]="{standalone: true}"></textarea>
                  </tds-form-field>

                  <div class="flex flex-col gap-y-2">
                      <tds-label>Địa chỉ</tds-label>
                      <div class="flex gap-x-2 items-center">

                        <tds-form-field *ngIf="isEditPartner" class="flex flex-auto">
                          <!-- <input tdsInput autocomplete="off" class="w-full truncate" placeholder="Địa chỉ" [(ngModel)]="" [ngModelOptions]="{standalone: true}"/> -->

                          <tds-select valueField="Address" textField="Address"
                              placeholder='Nhập địa chỉ cần tìm' disabledField="isActive"
                              [data]="suggestData | async" [allowClear]="true" [valuePrimitive]="false"
                              [autoClearSearchValue]="true" [serverSearch]="true"
                              [(ngModel)]="suggestText" [ngModelOptions]="{standalone: true}"
                              (onSearch)="onSearchSuggestion($event)" (selectChange)="onSelectSuggestion($event)">
                          </tds-select>
                        </tds-form-field>

                        <button tds-button-icon color="primary" (click)="showModalSuggestAddress()" tds-tooltip [tooltipTitle]="partner.Street ? 'Kiểm tra địa chỉ' : 'Tìm kiếm địa chỉ'">
                            <span class="flex items-center">
                               <i class="tdsi-location-fill"></i>
                            </span>
                        </button>
                      </div>
                  </div>

                  <!-- Suggest -->
                  <div *ngIf="isSuggestion" class="flex flex-col overflow-hidden">
                    <div class="w-full flex mb-2">
                      <tds-form-field class="w-full">
                        <tds-select valueField="code" textField="name" placeholder='Tỉnh/Thành' [valuePrimitive]="false"
                          (onSearch)="handleCityFilter($event)" [(ngModel)]="partner.City" [ngModelOptions]="{standalone: true}"
                          disabledField="isActive" [data]="lstCity"
                          [allowClear]="true" (selectChange)="changeCity($event)">
                        </tds-select>
                      </tds-form-field>
                    </div>
                    <div class="w-full flex mb-2">
                      <tds-form-field class="w-full">
                        <tds-select valueField="code" textField="name" placeholder='Quận/Huyện' [valuePrimitive]="false"
                          (onSearch)="handleFilterDistrict($event)" [(ngModel)]="partner.District" [ngModelOptions]="{standalone: true}"
                          disabledField="isActive" [data]="lstDistrict" [allowClear]="true" (selectChange)="changeDistrict($event)">
                        </tds-select>
                      </tds-form-field>
                    </div>
                    <div class="w-full flex mb-2">
                      <tds-form-field class="w-full">
                        <tds-select valueField="code" textField="name" placeholder='Phường/Xã' [valuePrimitive]="false"
                          (onSearch)="handleFilterWard($event)" [(ngModel)]="partner.Ward" [ngModelOptions]="{standalone: true}"
                           disabledField="isActive" [data]="lstWard"
                          [allowClear]="true" (selectChange)="changeWard($event)">
                        </tds-select>
                      </tds-form-field>
                    </div>
                    <div class="w-full flex">
                      <tds-form-field class="w-full">
                           <input tdsInput autocomplete="off" class="w-full truncate" placeholder="Địa chỉ" [(ngModel)]="partner.Street" [ngModelOptions]="{standalone: true}"/>
                      </tds-form-field>
                    </div>
                  </div>

                  <div class="mt-4">
                      <button type="button" tds-button class="w-[100px]" type="submit" color="primary" (click)="onSaveEdit()">Lưu</button>
                      <button type="button" tds-button class="ml-3 w-[100px]" color="secondary" (click)="onCancelEdit()">Hủy bỏ</button>
                  </div>
              </div>
          </div>

          <!-- TODO Khoản trắng ở cuối giao diện -->
          <div class="flex-auto bg-white mt-1"></div>
      </div>
  </div>
  <ng-template #noData>
    <div class="w-full h-[calc(100vh-109px)]">
    </div>
  </ng-template>
</tds-spin>

