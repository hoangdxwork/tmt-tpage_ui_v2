
<tds-spin [spinning]="isLoading">
    <div *ngIf="partner && team && omcs_Item">
        <div class="w-full h-[calc(100vh-109px)] bg-neutral-3-100 overflow-hidden overflow-y-auto tds-custom-scroll flex-col flex">
            <!-- Thông tin khách hàng -->
            <div class="bg-white px-4 py-4">
                <div class="flex gap-6">

                  <tpage-avatar-facebook [shape]="'circle'" [size]="'lg'" [psid]="partner.Facebook_ASUserId" [token]="team.Facebook_PageToken">
                  </tpage-avatar-facebook>

                  <div class="flex flex-col gap-2">
                      <div class="flex gap-4 items-center" style="min-height: 34px;">
                          <div class="text-heading-4 font-sans font-semibold text-neutral-1-900">
                              {{ partner.Facebook_UserName || partner.Name}}
                          </div>
                          <button type="button" tds-button color="secondary" (click)="onEditPartner()" *ngIf="!isEditPartner">
                              <span class="flex items-center">
                                <i class="tdsi-edit-fill text-xl leading-none text-neutral-1-400"></i>
                              </span>
                          </button>
                      </div>

                      <div class="flex gap-2">
                          <tds-button-group>

                            <div tds-button color="secondary" tds-dropdown trigger="click" [tdsDropdownMenu]="menu"
                                class="border border-solid rounded-md px-2" [ngStyle]="getStatusColor(partner.StatusText) | buttonStatusColor">
                                <span class="flex items-center text-caption-2 font-semibold font-sans cursor-pointer">
                                    {{ partner.StatusText || 'Bình thường' }} <i class="tdsi-arrow-down-fill text-lg leading-none ml-1"></i>
                                </span>
                            </div>

                            <tds-dropdown-menu #menu="tdsDropdownMenu">
                                <div class="w-full">
                                    <div tds-dropdown-item *ngFor="let x of lstPartnerStatus" (click)="selectStatus(x)">
                                        <a [ngStyle]="{'color': x.value }"> {{ x.text }} </a>
                                    </div>
                                </div>
                            </tds-dropdown-menu>
                          </tds-button-group>

                          <div class="text-body-2 font-regular font-sans text-neutral-1-400">
                              ID: <span class="font-semibold">{{partner.Id}}</span>
                          </div>
                      </div>
                  </div>
                </div>

                <div class="pt-6 flex flex-col gap-3" *ngIf="!isEditPartner">
                    <div class="flex gap-2 items-center">
                        <div class="tdsi-call-fill px-1 bg-neutral-3-50 text-neutral-1-400 text-xl rounded-[10px]"></div>

                        <div class="flex items-center gap-1">
                              <div class="text-neutral-1-900 text-body-2 font-regular font-sans">{{partner.Phone || 'Chưa có SĐT'}} </div>
                              <div class="tdsi-success-fill text-sm text-primary-1 cursor-pointer" *ngIf="!partner.PhoneReport" (click)="onlListPhoneBlock()"></div>
                              <div class="tdsi-success-fill text-sm text-accent-3  cursor-pointer" *ngIf="partner.PhoneReport" (click)="onBlockPhone()"></div>
                        </div>
                    </div>

                    <div class="flex gap-2 items-center">
                        <div class="tdsi-email-fill px-1 bg-neutral-3-50 text-neutral-1-400 text-xl rounded-[10px]"></div>
                        <div class="text-neutral-1-900 text-body-2 font-regular font-sans">{{partner.Email  || 'Chưa có Email'}}</div>
                    </div>

                    <div class="flex gap-2 items-center">
                        <div class="tdsi-pin-fill px-1 bg-neutral-3-50 text-neutral-1-400 text-xl rounded-[10px]"> </div>
                        <div class="text-neutral-1-900 text-body-2 font-regular font-sans">{{partner.Street || 'Chưa có địa chỉ'}} </div>
                    </div>
                </div>

                <div class="pt-3 flex gap-2" *ngIf="!isEditPartner && objRevenue">
                    <tds-button-group>
                        <button type="button" tds-dropdown color="secondary" trigger="click" [tdsDropdownMenu]="menuRevenue"
                            class="rounded-full border border-neutral-2-100 border-solid bg-white py-1.5 2xl:px-4 px-2">
                            <span class="flex items-center text-body-2 font-semibold text-neutral-1-500 cursor-pointer whitespace-nowrap">
                                Tổng doanh số: <span class="pl-2 text-primary-1">{{objRevenue.RevenueTotal || 0 | number: '1.0-3'}} đ</span>
                                <i class="tdsi-arrow-down-line text-lg leading-none ml-2"></i>
                            </span>
                        </button>

                        <tds-dropdown-menu #menuRevenue="tdsDropdownMenu">
                            <div class="w-full">
                                <div tds-dropdown-item>Doanh số đầu kỳ: {{objRevenue.RevenueBegan || 0 | number: '1.0-3'}} đ</div>
                                <div tds-dropdown-item>Doanh số: {{objRevenue.Revenue || 0 | number: '1.0-3'}} đ</div>
                                <div tds-dropdown-item>Tổng doanh số: {{objRevenue.RevenueTotal || 0 | number: '1.0-3'}} đ</div>
                            </div>
                        </tds-dropdown-menu>
                    </tds-button-group>

                    <button type="button" class="border border-neutral-2-100 border-solid 2xl:px-4 px-2 rounded-full" (click)="onBlockPhone()">
                        <span class="flex items-center text-body-2 font-semibold font-sans text-neutral-1-900 whitespace-nowrap">
                            <i class="tdsi-block-fill text-lg mr-2 text-neutral-1-400"></i> Chặn SĐT
                        </span>
                    </button>
                </div>
            </div>

            <!-- Xử lý ghi chú -->
            <div class="bg-white pt-0 p-4" *ngIf="!isEditPartner">

                <div class="flex items-center gap-2 pb-3">
                    <tds-form-field class="w-full">
                        <input class="placeholder-neutral-1-400 bg-neutral-3-50" placeholder="Nhập ghi chú" tdsInput (keyup.enter)="addNote()"
                        [(ngModel)]="innerNote" [ngModelOptions]="{standalone: true}" />
                    </tds-form-field>

                    <button type="button" tds-button color="primary" (click)="addNote()">
                        <span class="flex items-center">
                            <i class="tdsi-plus-fill text-lg leading-none mr-2"></i>Thêm
                        </span>
                    </button>
                </div>

                <div class="pl-2 flex flex-col gap-3 overflow-auto overflow-y-auto tds-custom-scroll max-h-[200px]" *ngIf="noteData.items.length > 0">
                    <div class="border-l-3 border-primary-1 border-solid pl-2 flex items-center justify-between" *ngFor="let item of noteData.items; let i=index">
                        <div>
                            <div class="text-neutral-1-400 text-body-2 font-regular font-sans">{{item.DateCreated | date:'HH:mm dd/MM/yyyy'}}</div>

                            <div class="flex gap-2 pt-1">
                                <div class="text-body-2 font-semibold font-sans text-neutral-1-900">{{item.CreatedBy.Name}} ({{item.CreatedBy.UserName}})</div>
                                <div [innerHTML]="item.message | safeHtml"></div>
                            </div>
                        </div>
                        <div class="flex">
                            <i class="tdsi-trash-line text-error-500 text-xl cursor-pointer" (click)="removeNote(item.id, i)"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Phiếu bán hàng -->
            <div class="pt-1" *ngIf="!isEditPartner && totalBill > 0">
              <tds-collapse [expandIconPosition]="'right'" class="bg-white">
                <tds-collapse-panel [header]="headerSalesDetails" [active]="true" [disabled]=false [expandedIcon]="'tdsi-arrow-up-line'">

                  <ng-template #headerSalesDetails>
                      <div class="flex items-center gap-4">
                          <tds-avatar size="lg" tdsSrc="../../../assets/imagesv2/conversation/avatar-salesslip.svg"></tds-avatar>
                          <div class="flex flex-col gap-1">
                              <div class="text-neutral-1-400 font-regular text-body-2 font-sans">Phiếu bán hàng gần nhất</div>

                              <div class="flex gap-2 items-center" *ngIf="lastSaleOrder">

                                  <div class="text-info-500 text-header-1 font-sans font-semibold">#{{ lastSaleOrder.Number || 'N/A' }}</div>
                                  <tds-tag status='primary' type="outline" [status]="getColorStatusText(lastSaleOrder.ShowState)">
                                    {{ lastSaleOrder.ShowState }}
                                  </tds-tag>

                              </div>
                          </div>
                      </div>
                  </ng-template>

                  <div class="w-full h-full flex flex-col gap-3" *ngIf="lastSaleOrder">
                      <div class="flex gap-3 items-center">
                          <div *ngIf="lastSaleOrder.CarrierName" class="text-body-2 font-semibold font-sans text-neutral-1-900">
                            {{ lastSaleOrder.CarrierName || 'Chưa có đối tác'}}</div>

                          <div *ngIf="!lastSaleOrder.CarrierName" class="text-body-2 italic font-regular font-sans text-neutral-1-900">
                            (Chưa có đối tác)</div>

                          <div class="text-body-2 font-regular font-sans text-neutral-1-900">
                            [ {{ lastSaleOrder.ShowState }} - <span class="text-info-500 pl-0.5">{{ lastSaleOrder.TrackingRef || '#N/A' }}</span>]
                          </div>

                      </div>

                      <div class="text-body-2 font-regular font-sans text-neutral-1-400">
                          Tổng tiền: <span class="text-neutral-1-900 font-semibold pl-0.5">{{ lastSaleOrder.AmountTotal | number:'1.0-3' }} đ ({{ lastSaleOrder.PaymentJournalName }})</span>
                      </div>

                      <div class="text-body-2 font-regular font-sans text-neutral-1-400">
                          Ngày tạo: <span class="text-neutral-1-900 font-semibold pl-0.5">{{ lastSaleOrder.DateCreated | date: "HH:mm, dd/MM/yyyy" }}</span>
                      </div>

                      <div class="text-body-2 font-regular font-sans text-neutral-1-400">
                          {{ lastSaleOrder.Phone }} - {{ lastSaleOrder.Address }} </div>

                      <div class="text-body-2 font-semibold font-sans text-accent-3"> {{ lastSaleOrder.DeliveryNote }} </div>
                  </div>
                </tds-collapse-panel>
              </tds-collapse>
            </div>

            <div class="pt-1" *ngIf="!isEditPartner && totalBill > 0">
              <tds-collapse [expandIconPosition]="'right'" class="bg-white" [bordered]="false">

                <tds-collapse-panel [header]="headerListSales" [active]="true" [disabled]=false [expandedIcon]="'tdsi-arrow-up-line'">
                  <ng-template #headerListSales>
                      <div class="flex items-center gap-4">
                          <div class="text-neutral-1-900 font-semibold text-header-1 font-sans">Phiếu bán hàng</div>
                          <tds-badge [standalone]="true" [count]="totalBill"></tds-badge>
                      </div>
                  </ng-template>

                  <div class="w-full h-full" *ngIf="lstBill">
                      <div class="w-full">
                        <tds-filter-status (selectChange)="onChangeBill($event)" [ngModel]='tabBillCurrent' [ngModelOptions]="{standalone: true}" class="gap-2 flex flex-wrap">
                            <tds-filter-status-item *ngFor="let bills of lstBill; let index = index"
                                [name]='bills.data[0].ShowState' [value]='index' [count]='bills.total'>

                                <ng-template tds-filter-status-template let-active='active' let-count='count' let-name='name' let-value>

                                  <div class="py-1 px-2 flex items-center border border-neutral-2-100 border-solid rounded-full"
                                      [ngClass]="{' border-primary-1':active,'border-neutral-2-100 group-hover:border-primary-1':!active}">
                                      <div class="text-body-2 mr-2 font-semibold" [ngClass]="{'text-primary-1':active,'text-neutral-1-400 group-hover:text-primary-1':!active}">
                                          {{name}}&nbsp; {{count}}
                                      </div>
                                  </div>

                                </ng-template>
                            </tds-filter-status-item>
                        </tds-filter-status>
                    </div>

                    <div class="pt-4 flex flex-col gap-2 w-full" *ngIf="lstBill">
                        <tds-collapse *ngFor="let bill of lstBill[tabBillCurrent]?.data; let index = index">
                            <tds-collapse-panel [header]="headerBill" [active]="false" [disabled]=false>
                                <ng-template #headerBill>
                                    <div class="grid grid-cols-3 gap-x-6 w-full" *ngIf="bill">

                                        <div class="w-[125px] flex flex-col gap-y-0.5">
                                            <div class="text-info-500 font-semibold text-body-2 font-sans"> #{{bill.Number || 'N/A'}}</div>
                                            <div class="text-neutral-1-400 text-caption-2 font-regular"> {{bill.DateCreated | date: "HH:mm, dd/MM/yyyy"}} </div>
                                        </div>

                                        <div class="w-[125px]">
                                            <span class="text-neutral-1-900 text-body-2 font-semibold text-center">{{bill.AmountTotal | number}} đ</span>
                                        </div>

                                        <div class="w-[125px] text-center">
                                            <tds-badge [status]="getColorStatusText(bill.ShowState)" [text]="bill.ShowState"></tds-badge>
                                        </div>
                                    </div>
                                </ng-template>

                                <div class="grid grid-cols-4 gap-x-6 gap-y-4" *ngIf="bill">
                                    <label>Đối tác GH:</label>
                                    <div class="w-full col-span-3 flex gap-1">
                                        <div class="font-semibold"> {{bill.CarrierName}} - <span class="text-info-500">{{lastSaleOrder.TrackingRef || '#N/A'}}</span> </div>
                                    </div>

                                    <label>Phương thức TT:</label>
                                    <div class="w-full col-span-3 flex gap-1">
                                        <div class="font-semibold">{{bill.PaymentJournalName}}</div>
                                    </div>

                                    <label>Điện thoại:</label>
                                    <div class="w-full col-span-3 flex gap-1">
                                        <div class="font-semibold">{{bill.Phone}}</div>
                                    </div>

                                    <label>Địa chỉ:</label>
                                    <div class="w-full col-span-3 flex gap-1">
                                        <div class="font-semibold">{{bill.Address}}</div>
                                    </div>

                                    <label>Trạng thái GH:</label>
                                    <div class="w-full col-span-3 flex gap-1">
                                        <tds-tag status='primary' type="outline" [status]="getColorStatusText(bill.ShowState)">{{bill.ShowState}}</tds-tag>
                                    </div>

                                    <div class="flex flex-row items-center justify-end w-full col-span-4">
                                        <button tds-button color="primary" class="mr-2" (click)="editBill(bill)">Sửa</button>
                                        <button *ngIf="bill.State === 'open'" tds-button color="primary" (click)="showPaymentModal(bill)">Thanh toán</button>
                                    </div>
                                </div>
                            </tds-collapse-panel>
                        </tds-collapse>
                    </div>
                  </div>
                </tds-collapse-panel>
              </tds-collapse>
            </div>

            <div class="pt-1 flex-auto" *ngIf="!isEditPartner && totalBill < 1">
                <div class="flex flex-col gap-4 p-4 items-center bg-white h-full">
                    <img src="../../../assets/imagesv2/shop-empty.svg" alt="" class="mt-24 w-[110px] h-[82px]">
                    <span class="text-neutral-1-400 font-normal">Chưa có phiếu bán hàng nào</span>

                    <button type="button" tds-button color="primary" class="mt-3.5" >
                        <span class="flex items-center">
                            <i class="tdsi-add-fill text-lg leading-none mr-2"></i>Tạo đơn hàng
                        </span>
                    </button>
                </div>
            </div>

            <!-- Edit khách hàng -->
            <div class="pt-1" *ngIf="isEditPartner && partner">
                <div class="flex flex-col gap-4 bg-white p-4">
                    <tds-form-field>
                        <tds-label> Tên khách hàng </tds-label>
                        <input tdsInput placeholder="Nhập tên khách hàng" [required]='true'  [(ngModel)]="partner.Name" [ngModelOptions]="{standalone: true}"/>
                    </tds-form-field>

                    <div class="flex gap-5">
                        <tds-form-field class="w-1/2">
                            <tds-label> Số điện thoại</tds-label>
                            <input tdsInput placeholder="Nhập số điện thoại" [(ngModel)]="partner.Phone" [ngModelOptions]="{standalone: true}"/>
                        </tds-form-field>

                        <tds-form-field class="w-1/2">
                            <tds-label> Email </tds-label>
                            <input tdsInput autocomplete="off"  placeholder="Nhập email" [(ngModel)]="partner.Email" [ngModelOptions]="{standalone: true}"/>
                        </tds-form-field>
                    </div>

                    <tds-form-field>
                        <tds-label>Ghi chú</tds-label>
                        <input tdsInput placeholder="Nhập ghi chú"  [(ngModel)]="partner.Comment" [ngModelOptions]="{standalone: true}"/>
                    </tds-form-field>

                    <div class="flex flex-col gap-y-2">
                        <tds-label>Địa chỉ</tds-label>
                        <suggest-address [_isBtnExtend]="true" [_isExpanded]="false"
                            [_cities]="_cities" [_districts]="_districts"
                            [_wards]="_wards" [_street]="_street"
                            (onLoadSuggestion)="onLoadSuggestion($event)">
                        </suggest-address>
                    </div>

                    <div class="mt-4">
                        <button type="button" tds-button class="w-[100px]" type="submit" color="primary" (click)="onSaveEdit()">Lưu</button>
                        <button type="button" tds-button class="ml-3 w-[100px]" color="secondary" (click)="onCancelEdit()">Hủy bỏ</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</tds-spin>

