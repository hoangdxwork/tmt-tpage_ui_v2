<tds-spin [spinning]="isLoading">
    <div class="w-full h-full flex flex-col gap-4" *ngIf="dataModel">
      <!-- Cau hinh tao don -->
      <div class="border border-neutral-3-300 border-solid rounded-xl p-4 w-full h-full">
          <div class="text-header-2 text-neutral-1-900 font-semibold font-sans">Cấu hình tạo đơn tự động</div>
          
          <div class="flex flex-col gap-y-4 pt-4">
            <div class="flex flex-col gap-y-4">
                <div class="flex gap-x-2 items-center">
                    <tds-switch size="md" [(ngModel)]="dataModel.IsEnableOrderAuto"></tds-switch>
                    <div class="text-body-2 font-regular text-neutral-1-900 font-sans">Bật tạo đơn tự động?</div>
                </div>

                <div class="pl-4 flex gap-x-2 items-center" *ngIf="dataModel.IsEnableOrderAuto">
                    <tds-switch size="md" [(ngModel)]="dataModel.IsForceOrderWithAllMessage"></tds-switch>
                    <div class="text-body-2 font-regular text-neutral-1-900 font-sans">Tạo tự động với bình luận bất kỳ?</div>
                </div>
            </div>

            <div class="flex gap-x-2 items-center">
                <tds-switch size="md" [(ngModel)]="isImmediateApply"></tds-switch>
                <div class="text-body-2 font-regular text-neutral-1-900 font-sans"> Áp dụng ngay cho những bình luận đã có?</div>
            </div>

            <div class="flex items-center" *ngIf="dataModel.MaxCreateOrder >= 0">
                <div class="text-body-2 font-semibold text-neutral-1-900 font-sans mr-4">Giới hạn số đơn được tạo</div>
                <div class="flex w-[152px]">
                      <tds-input-number [(ngModel)]="dataModel.MaxCreateOrder" [min]="0" [max]="1000000" [step]="1" placeholder="0"></tds-input-number>
                </div>
            </div>
          </div>
      </div>

      <!-- Dong bo san pham tu chien dich live -->
      <div class="border border-neutral-3-300 border-solid rounded-xl p-4 flex justify-between w-full h-full"
        *ngIf="dataModel.IsEnableOrderAuto && dataModel.LiveCampaignId">
          <div class="flex items-center gap-x-4">
              <div class="text-header-2 text-neutral-1-900 font-semibold font-sans">Đồng bộ sản phẩm từ chiến dịch</div>

              <div class="flex gap-x-1 py-0.5 px-2 bg-base-orange-50 items-center rounded">
                  <div class="text-caption-1 font-regular text-base-orange-500">{{ currentLiveCampaign?.Name }} - chiến dịch mới setting</div>
                  <div class="flex items-center"><span class="tdsi-arrow-right-line text-base-orange-500 text-md flex items-center"></span></div>
              </div>
          </div>

          <button tds-button color="primary" (click)="loadConfigLiveCampaign(dataModel.LiveCampaignId)">
              <span class="flex items-center">
                  <i class="tdsi-download-fill text-lg leading-none mr-2"></i>Tải cấu hình
              </span>
          </button>
      </div>

      <div *ngIf="dataModel.IsEnableOrderAuto && !dataModel.IsForceOrderWithAllMessage" class="border border-neutral-3-300 border-solid rounded-xl p-4 w-full h-full">
        <div class="text-header-2 text-neutral-1-900 font-semibold font-sans">Tạo đơn với</div>

        <div class="flex flex-col gap-y-4 pt-4">
          <div class="flex items-center gap-x-2">
              <tds-switch size="md" [(ngModel)]="dataModel.IsOnlyOrderWithPartner"></tds-switch>
              <div class="text-body-2 font-regular text-neutral-1-900 font-sans"> Bình luận của khách đã có thông tin (điện thoại, địa chỉ)</div>
          </div>

          <div class="flex flex-col gap-y-4">
              <div class="flex items-center gap-x-2">
                  <tds-switch size="md" [(ngModel)]="dataModel.IsOnlyOrderWithPhone"></tds-switch>
                  <div class="text-body-2 font-regular text-neutral-1-900 font-sans"> Bình luận có số điện thoại</div>
              </div>
              <div class="flex items-center gap-x-2 pl-4" *ngIf="dataModel.IsOnlyOrderWithPhone">
                  <tds-switch size="md" [(ngModel)]="dataModel.IsForceOrderWithPhone"></tds-switch>
                  <div class="text-body-2 font-regular text-neutral-1-900 font-sans"> Ép buộc tạo đơn với số điện thoại</div>
              </div>

              <div class="flex items-center gap-x-2 pl-4"
                  *ngIf="dataModel.IsForceOrderWithPhone && dataModel.IsOnlyOrderWithPhone">
                      <tds-switch size="md" [(ngModel)]="dataModel.IsForcePrintWithPhone"></tds-switch>
                      <div class="text-body-2 font-regular text-neutral-1-900 font-sans"> Ép buộc in nhiều lần với số điện thoại</div>
              </div>
            </div>

            <div class="flex items-center" *ngIf="dataModel.IsEnableOrderAuto">
                <div class="text-body-2 font-semibold text-neutral-1-900 font-sans w-1/4">Bình luận có độ dài lớn hơn (Ký tự) : </div>
                <div class="flex w-40">
                    <tds-input-number [min]="1" [max]="100" [step]="1" placeholder="0" [(ngModel)]="dataModel.MinLengthToOrder"></tds-input-number>
                </div>
            </div>

          <div class="flex items-center">
              <div class="text-body-2 font-semibold text-neutral-1-900 font-sans w-1/4">Chốt tự động với nội dung:</div>
              <div class="flex items-center gap-x-2.5">
                  <button tds-button color="secondary" (click)="addContentToOrders()">
                      <span class="flex items-center text-primary-1">
                          <i class="tdsi-plus-fill text-lg leading-none mr-2 text-primary-1"></i>Thêm mẫu
                      </span>
                  </button>

                  <button tds-button color="secondary" (click)="changeMoreTemplate()">
                      <span class="flex items-center text-accent-9">
                          <i class="tdsi-plus-fill text-lg leading-none mr-2 text-accent-9"></i>Thêm mẫu hàng loạt
                      </span>
                  </button>

                  <button tds-button color="secondary" (click)="removeAllTemplate()">
                      <span class="flex items-center text-accent-3">
                          <i class="tdsi-trash-fill text-lg leading-none mr-2 text-accent-3"></i>Xóa hết mẫu
                      </span>
                  </button>
              </div>
          </div>

          <!-- Thêm mẫu hàng loạt -->
          <div class="border border-neutral-3-300 border-solid rounded-xl py-3 px-4 " *ngIf="isVisibleRangeGenerate">
              <div class="grid grid-cols-2 gap-4">
                  <tds-form-field>
                      <tds-label>Từ bắt đầu <span class="text-neutral-1-300">( không áp dụng )</span> </tds-label>
                      <input tdsInput [(ngModel)]="prefixMoreTemplate" autocomplete="off" placeholder="Nhập từ bắt đầu"/>
                  </tds-form-field>

                  <tds-form-field>
                      <tds-label>Từ kết thúc <span class="text-neutral-1-300">( không áp dụng )</span> </tds-label>
                      <input tdsInput [(ngModel)]="suffixMoreTemplate" autocomplete="off" placeholder="Nhập từ kết thúc"/>
                  </tds-form-field>

                  <tds-form-field>
                      <tds-label>Từ số</tds-label>
                      <tds-input-number [(ngModel)]="fromMoreTemplate" [min]="1" [max]="100" [step]="1" placeholder="0">
                      </tds-input-number>
                  </tds-form-field>

                  <tds-form-field>
                      <tds-label>Đến số</tds-label>
                      <tds-input-number [(ngModel)]="toMoreTemplate" [min]="1" [max]="100" [step]="1" placeholder="0">
                      </tds-input-number>
                  </tds-form-field>
              </div>

              <div class="flex justify-end gap-2.5 pt-4">
                  <button tds-button color="secondary" (click)="onCannelMoreTemplate()" >Hủy bỏ</button>
                  <button tds-button color="primary" (click)="addMoreTemplate()" >Tạo mẫu</button>
              </div>
          </div>

          <!-- Config Product -->
          <div class="grid grid-cols-2 gap-4" *ngIf="dataModel.TextContentToOrders">
              <div *ngFor="let configProduct of dataModel.TextContentToOrders"
                  class="bg-neutral-3-50 rounded-lg pt-3 px-4 pb-4">
                  <div class="flex gap-2.5 items-center">
                      <tds-badge [count]="iconTemplate" (click)="showModalListProduct(configProduct.Index)">
                        <a class="tdsi-box-fill text-lg text-neutral-1-500 p-0.5"></a>
                      </tds-badge>

                      <ng-template #iconTemplate>
                        <span class="tdsi-add-fill text-primary-1 absolute bottom-1 right-1 cursor-pointer
                          inline-block transform translate-x-1/2 translate-y-1/2 text-[12px] p-0.5 bg-neutral-3-50 rounded-full">
                        </span>
                      </ng-template>

                      <div class="text-info-500 text-body-2 font-semibold " *ngIf="configProduct.Product as product; else notProduct">
                        {{ product.ProductNameGet || '' }}  /  {{ (product.Price || 0) | number }}
                      </div>

                      <ng-template #notProduct>
                          <div class="text-info-500 text-body-2 font-semibold ">
                            Chưa gán sản phẩm
                          </div>
                      </ng-template>
                  </div>

                  <div class="pt-6">
                      <div class="flex p-2 bg-white rounded-md gap-x-1">
                          <tds-form-field class="p-3 w-full">
                              <tds-select [ngModel]="(configProduct.Content | stringToStringArray) || []"
                                  (ngModelChange)="selectContent($event, configProduct.Index)"
                                  placeholder='Nội dung nhập' mode="tags" [maxTagCount]="10">
                              </tds-select>
                          </tds-form-field>
                      </div>
                  </div>

                  <div *ngIf="configProduct.Product as product">
                    <div class="pt-4 flex items-center">
                      <div class="text-neutral-1-900 font-semibold text-body-2 w-1/4">Số lượng tối đa</div>
                      <div class="w-3/4">
                        <tds-form-field class="w-full">
                          <tds-input-number [min]="1" [max]="100" [step]="1" placeholder="0" [(ngModel)]="product.Quantity"
                           >
                          </tds-input-number>
                        </tds-form-field>
                      </div>
                    </div>
                    <div class="pt-3">
                      <tds-checkbox [(ngModel)]="product.IsEnableRegexAttributeValues" (ngModelChange)="enableRegexAttributeValues($event, configProduct.Index)">
                        Kiểm tra thuộc tính? 
                        <span *ngIf="product.DescriptionAttributeValues">([{{product.DescriptionAttributeValues | json}}])</span>
                      </tds-checkbox>
                    </div>
                    <div class="pt-3" *ngIf="product.IsEnableRegexAttributeValues">
                      <div class="flex p-2 bg-white rounded-md gap-x-1">
                        <tds-form-field class="p-3 w-full">
                          <tds-select [ngModel]="configProduct.ContentWithAttributes | stringToStringArray"
                              (ngModelChange)="selectContentWithAttributes($event, configProduct.Index)"
                              placeholder='Nội dung nhập' mode="tags" [maxTagCount]="10">
                          </tds-select>
                        </tds-form-field>
                      </div>
                    </div>
                    <div class="pt-3">
                      <tds-checkbox [(ngModel)]="product.IsEnableRegexQty" (ngModelChange)="enableRegexQty($event, configProduct.Index)">
                        Bật xử lý số lượng?
                      </tds-checkbox>
                    </div>
                    <div class="pt-3">
                      <tds-checkbox [(ngModel)]="product.IsEnableOrderMultiple" (ngModelChange)="enableOrderMultiple($event, configProduct.Index)">
                        Cho phép chốt nhiều lần (nhưng không cho trùng nội dung chốt)
                      </tds-checkbox>
                    </div>
                  </div>
                  <div class="pt-6">
                    <button tds-button color="secondary" class="rounded-md border border-accent-3 border-solid w-full flex justify-center"
                      (click)="removeTemplate(configProduct.Index)">
                      <span class="flex items-center text-accent-3 text-body-2 font-semibold">
                        <i class="tdsi-trash-fill text-lg leading-none mr-2 text-accent-3"></i>Xóa mẫu
                      </span>
                    </button>
                  </div>
              </div>
              <div>
                <button tds-button color="secondary" (click)="addContentToOrders()">
                  <span class="flex items-center text-primary-1">
                    <i class="tdsi-plus-fill text-lg leading-none mr-2 text-primary-1"></i>Thêm mẫu
                  </span>
                </button>
              </div>
          </div>
        </div>
      </div>

      <div *ngIf="dataModel.IsEnableOrderAuto" class="border border-neutral-3-300 border-solid rounded-lg p-4 w-full h-full">
          <div class="text-header-2 text-neutral-1-900 font-semibold font-sans">Không tạo đơn với</div>
          
          <div class="pt-4 grid grid-cols-2 gap-x-4">
            <tds-form-field>
                <tds-label>Khách hàng thuộc trạng thái</tds-label>
                <tds-select valueField="Name" textField="Name" placeholder='Nhập nội dung và nhấn [Enter]' [valuePrimitive]="false"
                    [data]="(lstTags$ | async) || []" mode="tags" [maxTagCount]="10" 
                    [ngModel]="dataModel.ExcludedStatusNames | convertToCRMTagsList" (ngModelChange)="changeExcludedStatusNames($event)">
                </tds-select>
            </tds-form-field>

            <tds-form-field>
                <tds-label>Bình luận có nội dung</tds-label>
                    <tds-select [ngModel]="lstTextContentToExcludeOrder" placeholder='Nhập nội dung và nhấn [Enter]'
                        mode="tags" [maxTagCount]="10"
                        (ngModelChange)="changeTextContentToExcludeOrder($event)">
                </tds-select>
            </tds-form-field>
          </div>
          <div class="pt-4 ">
              <tds-label>Danh sách số điện thoại seeding</tds-label>
              <div class="flex gap-x-4 pt-2 items-center">
                  <tds-form-field class="w-full">
                      <tds-select [ngModel]="dataModel.ExcludedPhones" placeholder='Nhập nội dung và nhấn [Enter]'
                          mode="tags" [maxTagCount]="10"
                          (ngModelChange)="changeExcludedPhones($event)">
                      </tds-select>
                  </tds-form-field>
                  <button tds-button-icon color="secondary">
                      <input type="file" (change)="addExcludedPhone($event)" id="ip_add_excel_phone" class="hidden">
                      <label class="tdsi-note-fill flex items-center text-neutral-1-500" for="ip_add_excel_phone"></label>
                  </button>
                  <button tds-button-icon color="secondary">
                      <input type="file" (change)="addExcludedPhone($event)" id="ip_add_txt_phone" class="hidden">
                      <label class="tdsi-excel-fill flex items-center text-neutral-1-500" for="ip_add_txt_phone"></label>
                  </button>
              </div>
          </div>
      </div>
      
      <div *ngIf="dataModel.IsEnableOrderAuto" class="border border-neutral-3-300 border-solid rounded-lg p-4 w-full h-full">
        <div class="text-header-2 text-neutral-1-900 font-semibold font-sans">Phân công hội thoại tự động</div>
        <div class="flex flex-col gap-y-4 pt-4">
          <div class="flex gap-x-2 items-center">
            <tds-switch [(ngModel)]="dataModel.IsEnableAutoAssignUser" size="md"></tds-switch>
            <div class="text-body-2 font-regular text-neutral-1-900 font-sans">Bật phân công đơn hàng tự động cho nhân viên?</div>
          </div>

          <tds-form-field *ngIf="dataModel.IsEnableAutoAssignUser">
            <tds-label> Chọn nhân viên để phân công: </tds-label>
            <tds-select valueField="Id" textField="Name" [ngModel]="dataModel.Users" mode="tags" [maxTagCount]="10" [valuePrimitive]="false"
              placeholder='Chọn nhân viên' 
              [allowClear]="true" [data]="(lstUser$ | async) || []" mode="multiple" 
              (ngModelChange)="changeUsers($event)">
            </tds-select>
          </tds-form-field>
        </div>
      </div>
    </div>
</tds-spin>

