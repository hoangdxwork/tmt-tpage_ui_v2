<div *ngIf="item" class="text-body-2 text-neutral-1-900 w-full h-full">
    <div class="w-full overflow-hidden bg-white h-full break-words whitespace-pre-line">
        <div [ngClass]="conversationItem && (conversationItem.Id == item.Id)?'bg-secondary-3 border-blue-500':'bg-white border-transparent'"
            class="flex w-full h-full min-h-[100px] hover:bg-neutral-3-50 border-l-4">
            <div class="p-3.5 flex flex-col w-full h-full">
                <div class="flex gap-3">
                    <div class="relative">
                        <!-- Facebook -->
                        <tpage-avatar-facebook *ngIf="team.Type == 'Facebook'"
                            [noAssignedUser]="item.AssignedTo ? true : false" [shape]="'circle'" [size]="'lg'"
                            [hasAvatar]="item.Avatar" [psid]="item.ConversationId" [token]="team.ChannelToken">
                        </tpage-avatar-facebook>

                        <!-- icon comment -->
                        <span
                            *ngIf="item.LatestMessage && (item.LatestMessage.MessageType == 12) && (type == 'all' || type == 'comment')"
                            class="absolute top-[31px] left-[31px]">
                            <svg width="20" height="21" viewBox="0 0 26 27" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M1.6665 13.0152C1.6665 16.3866 3.04389 19.3288 5.30367 21.373L5.36031 23.2061C5.36031 23.2061 5.36031 23.2061 5.36031 23.2061C5.4008 24.5175 6.75463 25.3774 7.96053 24.845C7.96056 24.8449 7.96059 24.8449 7.96062 24.8449C7.96097 24.8448 7.96132 24.8446 7.96168 24.8444L10.0314 23.9321C11.076 24.2135 12.1824 24.3646 13.3332 24.3646C19.857 24.3646 24.9998 19.55 24.9998 13.0179C24.9998 6.4862 19.8573 1.66858 13.3332 1.66858C6.80934 1.66858 1.6665 6.4832 1.6665 13.0152Z"
                                    fill="url(#paint0_linear_11437_27281)" stroke="white" stroke-width="2" />
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                    d="M16.4272 6.33233V8.49995L15.1407 8.5033C14.1322 8.5033 13.9379 8.98238 13.9379 9.68259V11.2338H16.3401L16.0285 13.6593H13.9379V19.9712H11.4323V13.6593H9.33466V11.2338H11.4323V9.44472C11.4323 7.36756 12.6983 6.23517 14.5544 6.23517C15.4392 6.23517 16.2027 6.30217 16.4272 6.33233Z"
                                    fill="white" />
                                <defs>
                                    <linearGradient id="paint0_linear_11437_27281" x1="8.04667" y1="4.43833"
                                        x2="18.8263" y2="22.09" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#005BE6" />
                                        <stop offset="1" stop-color="#63A0FF" />
                                    </linearGradient>
                                </defs>
                            </svg>
                        </span>

                        <!-- icon message -->
                        <span
                            *ngIf="item.LatestMessage && (item.LatestMessage.MessageType == 11) && (type == 'all' || type == 'message')"
                            class="absolute top-[31px] left-[31px]">
                            <svg width="20" height="21" viewBox="0 0 26 27" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M1.6665 13.0134C1.6665 16.3847 3.04389 19.327 5.30367 21.3711L5.36031 23.2042C5.36031 23.2042 5.36031 23.2042 5.36031 23.2042C5.4008 24.5156 6.75463 25.3755 7.96053 24.8431C7.96056 24.8431 7.96059 24.843 7.96062 24.843C7.96097 24.8429 7.96132 24.8427 7.96168 24.8426L10.0314 23.9302C11.076 24.2116 12.1824 24.3627 13.3332 24.3627C19.857 24.3627 24.9998 19.5481 24.9998 13.016C24.9998 6.48431 19.8573 1.66669 13.3332 1.66669C6.80934 1.66669 1.6665 6.48131 1.6665 13.0134Z"
                                    fill="url(#paint0_radial_11437_25390)" stroke="white" stroke-width="2" />
                                <path
                                    d="M6.92785 16.04L10.0612 11.0694C10.5598 10.2774 11.6265 10.0827 12.3758 10.6427L14.8692 12.512C15.0985 12.6827 15.4132 12.6827 15.6398 12.5094L19.0051 9.9547C19.4531 9.61336 20.0398 10.152 19.7411 10.6294L16.6052 15.5974C16.1065 16.3894 15.0398 16.584 14.2905 16.024L11.7972 14.1547C11.5678 13.984 11.2532 13.984 11.0265 14.1574L7.66118 16.712C7.21318 17.0534 6.62651 16.5174 6.92785 16.04Z"
                                    fill="white" />
                                <defs>
                                    <radialGradient id="paint0_radial_11437_25390" cx="0" cy="0" r="1"
                                        gradientUnits="userSpaceOnUse"
                                        gradientTransform="translate(6.77317 23.8838) scale(23.2448)">
                                        <stop stop-color="#0099FF" />
                                        <stop offset="0.317708" stop-color="#5364FF" />
                                        <stop offset="0.6098" stop-color="#A033FF" />
                                        <stop offset="0.9348" stop-color="#FF91AE" />
                                        <stop offset="1" stop-color="#FFA399" />
                                    </radialGradient>
                                </defs>
                            </svg>
                        </span>

                        <!-- TShop -->
                        <tds-avatar *ngIf="team.Type == 'TShop'"
                            [ngClass]="item.AssignedTo?.UserName? 'border-2 border-white ring-2 ring-primary-1':''"
                            [tdsSrc]="item.Avatar?.Url" [shape]="'circle'" [size]="'lg'">
                        </tds-avatar>

                        <!-- icon comment -->
                        <span
                            *ngIf="item.LatestMessage && item.LatestMessage?.MessageType == 91 && (type == 'all' || type == 'comment')"
                            class="absolute top-[30px] left-[30px] border-2 border-white bg-info-400 rounded-full">
                            <span
                                class="font-extrabold text-transparent bg-clip-text bg-white w-4 h-4 flex items-center justify-center">
                                <i class="tdsi-message-fill text-caption-1 leading-none"></i>
                            </span>
                        </span>

                        <!-- icon message -->
                        <span
                            *ngIf="item.LatestMessage && item.LatestMessage?.MessageType == 92 && (type == 'all' || type == 'message')"
                            class="absolute top-[30px] left-[30px] border-2 border-white bg-gradient-to-b from-d-base-pink-600 to-base-blue-500 rounded-full">
                            <span
                                class="font-extrabold text-transparent bg-clip-text bg-white w-4 h-4 flex items-center justify-center">
                                <i class="tdsi-email-fill text-caption-1 leading-none"></i>
                            </span>
                        </span>

                        <!-- Tiktok -->
                        <tds-avatar *ngIf="team.Type == 'UnofficialTikTok'"
                            [ngClass]="item.AssignedTo?.UserName? 'border-2 border-white ring-2 ring-primary-1':''"
                            [tdsSrc]="item.Avatar?.Url" [shape]="'circle'" [size]="'lg'">
                        </tds-avatar>

                        <span *ngIf="item.LatestMessage && item.LatestMessage?.MessageType == 1001"
                            class="absolute top-[30px] left-[30px] border-2 border-white bg-info-400 rounded-full">
                            <span
                                class="font-extrabold text-transparent bg-clip-text bg-white w-4 h-4 flex items-center justify-center">
                                <i class="tdsi-message-fill text-caption-1 leading-none"></i>
                            </span>
                        </span>
                    </div>
                    <div class="flex-auto overflow-hidden flex flex-col gap-1">
                        <span class="flex flex-auto justify-between items-start gap-x-1.5 overflow-hidden">
                            <span class="flex flex-auto items-center overflow-hidden">
                                <span [ngClass]="(type | seenedMessage: item.CountUnread) ? 'font-semibold' : ''"
                                    class="text-body-1 text-neutral-1-900 {{item.State ? 'w-4/5': 'flex-auto'}} truncate"
                                    [tooltipTitle]="item.Name" [tooltipPlacement]="['topLeft', 'leftTop']" tds-tooltip>
                                    {{item.Name}}
                                </span>
                                <span *ngIf="item.State" class="text-body-2 flex-auto">
                                    <span *ngIf="item.State == 1" class="tdsi-friend-fill ml-2" tds-tooltip
                                        tooltipTitle="Đang chuyển cho admin xử lý"></span>
                                    <span *ngIf="item.State == 2" class="tdsi-bot-fill ml-2" tds-tooltip
                                        tooltipTitle="Hệ thống chatbot đang gặp vấn đề"></span>
                                </span>
                            </span>

                            <span class="flex items-center gap-2">
                                <span *ngIf="item.CountUnread > 0">
                                    <tds-badge class="flex items-center" [standalone]="true" [count]="item.CountUnread"
                                        title="Phản hồi chưa đọc"
                                        [tdsStyle]="{ backgroundColor: '#FA5171' }"></tds-badge>
                                </span>
                                <span *ngIf="!isOpenCollapCheck"
                                    class="text-neutral-1-400 text-body-2 font-regular font-sans whitespace-nowrap">
                                    {{item.UpdatedTime | yiDateTimeFormat}}
                                </span>
                                <tds-checkbox *ngIf="isOpenCollapCheck" [checked]="checked" class="checkboxMessage"
                                    (click)="changeCheck($event)"></tds-checkbox>
                            </span>
                        </span>

                        <span *ngIf="item | latestMessageType: type"
                            [ngClass]="(type | seenedMessage: item.CountUnread)? 'text-neutral-1-900' : 'text-neutral-1-600'"
                            class="cs-item relative min-h-[20px]" showMore [length]="25"
                            [text]="(item.LatestMessage?.Message | jsonPayload)">
                        </span>

                        <!-- Nhân viên  -->
                        <span *ngIf="item" class="flex items-center w-full min-h-[20px]"
                            [ngClass]="item.AssignedTo?.Name ? 'justify-between' : 'justify-end'">
                            <span *ngIf="item.AssignedTo" class="flex items-center overflow-hidden">
                                <span *ngIf="item.AssignedTo?.Avatar">
                                    <tds-avatar [shape]="'circle'" [size]="18"
                                        [tdsSrc]="item.AssignedTo.Avatar"></tds-avatar>
                                </span>
                                <span *ngIf="!item.AssignedTo?.Avatar">
                                    <tds-avatar [text]="item.AssignedTo?.Name | avatarRandom" [shape]="'circle'"
                                        class="text-white" [size]="17"
                                        [style.background-color]="item.AssignedTo?.Id | randomColor"></tds-avatar>
                                </span>
                                <span
                                    class="ml-1 text-caption-1 !leading-[15px] w-full flex-auto truncate">{{item.AssignedTo?.Name}}</span>
                            </span>
                        </span>
                    </div>
                </div>

                <!--keyTags thêm trong mục binh luận-->
                <div class="flex justify-end flex-col gap-2"
                    [ngClass]="((item.Tags && item.Tags.length > 0) || item.HasPhone || item.HasAddress )? 'pt-3': ''">
                    <div class="flex gap-2 items-end">
                        <div class="flex-auto flex flex-nowrap gap-1 items-center overflow-hidden" #currentWidthTag>
                            <div *ngIf="item.Tags" class="flex gap-x-1">
                                <div *ngFor="let tag of item.Tags" #widthTag
                                    class="relative flex items-center text-caption-2 text-[11px] max-w-[110px] font-regular text-neutral-1-900 rounded truncate flex-none">
                                    <span [ngStyle]="{'background-color': [tag.ColorClass+'30'] }" tds-tooltip [tooltipTitle]="tag.Name"
                                        class="w-full rounded-md py-0.5 px-1.5 flex justify-center items-center gap-x-1">
                                        <span class="flex items-center">
                                            <span [ngStyle]="{'background-color': [tag.ColorClass] }"
                                            class="-top-px inline-block align-middle rounded-full w-2 h-2"></span>
                                        </span>
                                        <span class="flex-auto truncate">{{tag.Name}}</span>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-1.5 items-center">
                            <span [ngClass]="countHiddenTag > 0 ? 'flex' : 'hidden'" class="px-1 py-0.5 text-info-500 bg-[#E5F2FF] text-caption-2 rounded truncate"
                                tds-popover [popoverContent]="popoverContentTag"
                                popoverPlacement="topRight">
                                +{{countHiddenTag}}
                            </span>
                            <ng-template #popoverContentTag>
                                <div class="flex gap-1 flex-wrap items-center max-w-[336px]">
                                    <span *ngFor="let tag of item.Tags | slice:displayTag:item.Tags!.length"
                                        class="relative flex items-center text-caption-2 text-[11px] font-regular text-neutral-1-900 rounded truncate flex-none">
                                        <span [ngStyle]="{'background-color': [tag.ColorClass+'30'] }"
                                            class=" rounded-md py-0.5 px-1.5 flex justify-center items-center gap-x-1">
                                            <span [ngStyle]="{'background-color': [tag.ColorClass] }"
                                                class="-top-px inline-block align-middle rounded-full w-2 h-2"></span>
                                            <span class="flex-auto truncate">{{tag.Name}}</span>
                                        </span>
                                    </span>
                                </div>
                            </ng-template>
                            <span *ngIf="item.HasPhone"
                                class="tdsi-call-fill text-body-2 leading-none text-white bg-base-green-400 p-0.5 rounded-md">
                            </span>
                            <span *ngIf="item.HasAddress"
                                class="tdsi-pin-fill text-body-2 leading-none text-white bg-base-orange-500 p-0.5 rounded-md">
                            </span>
                        </div>
                    </div>
                </div>

                <!-- admin đang xem -->
                <div class="flex justify-end items-center text-accent-3 text-caption-1 pt-2"
                    *ngIf="item.Markseen && item.Markseen?.Message">
                    <span class="flex items-center justify-center"><i class="tdsi-flash-on-fill mr-1"></i>
                        {{item.Markseen?.Message}}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
