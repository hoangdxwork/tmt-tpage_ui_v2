<tds-spin [spinning]="isLoading">
    <div *ngIf="quickOrderModel">
        <div class="w-full h-[calc(100vh-109px)] flex flex-col bg-neutral-3-100 overflow-y-auto tds-custom-scroll text-body-2">
            <!-- Thông tin khách hàng -->
            <tds-collapse [expandIconPosition]="'right'" class="bg-white collapse-content-bg-white">
                <tds-collapse-panel header="Thông tin khách hàng" [active]="true" [disabled]=false [expandedIcon]="'tdsi-arrow-up-line'">
                    <div class="flex flex-col gap-3 p-2">
                        <!-- partner name -->
                        <div class="flex gap-2 items-center">
                            <div class="tdsi-user-fill px-1 bg-neutral-3-50 text-neutral-1-400 text-xl rounded-[10px]"></div>

                            <div class="flex flex-auto items-center justify-between">
                                <div class="flex gap-4 items-center">
                                    <span *ngIf="!isEditPartner">{{ quickOrderModel.PartnerName }}</span>
                                    <tds-form-field *ngIf="isEditPartner">
                                        <input tdsInput autocomplete="off" placeholder="Tên khách hàng" [required]='true'
                                            [(ngModel)]="quickOrderModel.PartnerName" [ngModelOptions]="{ standalone: true }"/>
                                    </tds-form-field>

                                    <span class="text-primary-1 font-semibold xl:truncate">FB: {{ quickOrderModel.Facebook_UserName }}</span>
                                </div>

                                <button type="button" tds-button-icon color="secondary" (click)="onEditPartner()" tds-tooltip [tooltipTitle]="isEditPartner ? 'Đóng' : 'Chỉnh sửa'">
                                    <span class="flex items-center">
                                        <i [ngClass]="isEditPartner? 'tdsi-close-fill': 'tdsi-edit-fill'" class="text-xl leading-none text-neutral-1-400"></i>
                                    </span>
                                </button>
                            </div>
                        </div>

                        <!-- telephone -->
                        <div class="flex gap-2 items-center">
                            <div class="tdsi-call-fill px-1 bg-neutral-3-50 text-neutral-1-400 text-xl rounded-[10px]"></div>
                            <span *ngIf="!isEditPartner" class="text-neutral-1-900 font-regular font-sans">
                                {{ quickOrderModel.Telephone || 'Không có số điện thoại' }}
                            </span>

                            <tds-form-field *ngIf="isEditPartner" class="flex flex-auto">
                                <input tdsInput placeholder="Số điện thoại" [(ngModel)]="quickOrderModel.Telephone" [ngModelOptions]="{ standalone: true }" [required]='true'/>
                            </tds-form-field>
                        </div>

                        <!-- email -->
                        <div class="flex gap-2 items-center">
                            <div class="tdsi-email-fill px-1 bg-neutral-3-50 text-neutral-1-400 text-xl rounded-[10px]"></div>
                            <span *ngIf="!isEditPartner" class="text-neutral-1-900 font-regular font-sans">{{ quickOrderModel.Email || 'Chưa có Email' }}</span>

                            <tds-form-field *ngIf="isEditPartner" class="flex flex-auto">
                                <input tdsInput autocomplete="off" placeholder="Email" [(ngModel)]="quickOrderModel.Email" [ngModelOptions]="{ standalone: true }"/>
                            </tds-form-field>
                        </div>
                        <!-- địa chỉ -->
                        <div class="flex gap-2 items-center">
                            <div class="tdsi-pin-fill p-1 bg-neutral-3-50 text-neutral-1-400 text-xl leading-none rounded-[10px]"></div>
                            <span *ngIf="!isEditPartner" class="text-neutral-1-900 font-regular font-sans">{{ quickOrderModel.Address || 'Chưa có địa chỉ' }}</span>

                            <div *ngIf="isEditPartner" class="w-full flex gap-x-2">
                                <tds-form-field *ngIf="isEditPartner" class="flex flex-auto">
                                    <input tdsInput autocomplete="off" placeholder="Địa chỉ" [(ngModel)]="quickOrderModel.Address" [ngModelOptions]="{ standalone: true }"/>
                                </tds-form-field>
                                <button tds-button-icon color="primary" (click)="showModalSuggestAddress()" tds-tooltip [tooltipTitle]="quickOrderModel.Address ? 'Kiểm tra địa chỉ' : 'Tìm kiếm địa chỉ'">
                                    <span class="flex items-center">
                                      <i class="tdsi-location-fill"></i>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="w-full pt-4 flex items-stretch bg-white">
                        <textarea tdsInput placeholder="Ghi chú" class="resize-none no-scrollbar 2xl:w-3/4 xl:w-3/5 mx-2 px-3 py-2 rounded-xl !bg-neutral-3-50 !text-neutral-1-400"
                            [innerHTML]="quickOrderModel.Note | jsonPayload | formatIconLike | bbcodeConvert | safeHtml" (change)="changeNote($event)"></textarea>

                        <button tds-button-flat-icon color="secondary" tds-dropdown trigger="click" [placement]="'bottomRight'" [autoClose]="true" [backdrop]="true" [tdsDropdownMenu]="menuUser"
                            class="2xl:w-1/4 xl:w-2/5 !h-full flex items-center mx-2 px-3 py-2 rounded-xl !bg-neutral-3-50">
                            <div class="flex flex-col flex-auto items-start">
                                <label class="text-neutral-1-400 font-regular 2xl:text-body-2 xl:text-caption-1">Nhân viên</label>
                                <span class="text-info-500 font-semibold text-body-2 max-w-[80px] truncate">{{ quickOrderModel?.User?.Name || 'N/A' }}</span>
                            </div>

                            <i class="tdsi-arrow-down-line w-1/5"></i>

                            <tds-dropdown-menu #menuUser="tdsDropdownMenu">
                                <div class="w-72 max-h-80 overflow-hidden overflow-y-auto tds-panel-scroll ">
                                    <div class="px-4 py-2">
                                        <tds-form-field class="w-full">
                                            <input tdsInput placeholder="Tìm kiếm" autocomplete="off" [(ngModel)]="keyFilterUser" [ngModelOptions]="{standalone: true}" [tdsInputDebounce]="750" (inputKeyup)="searchUser()"/>
                                            <span tdsPrefix><i class="text-neutral-1-500 tdsi-search-fill"></i></span>
                                        </tds-form-field>
                                    </div>
                                    <div class="gap-y-2 flex flex-col overflow-y-auto tds-panel-scroll">
                                        <div *ngFor="let item of lstUser" (click)="changeUser(item)"
                                        class="py-2 px-3 rounded-full cursor-pointer hover:bg-neutral-3-50 flex justify-between items-center" >
                                        <div class="flex gap-x-2">
                                            <tds-avatar size="sm" [tdsSrc]="item.Avatar"></tds-avatar>
                                            <span>{{item.Name}}</span>
                                        </div>
                                        <span class="tdsi-success-fill text-success-500" *ngIf="item.Id == quickOrderModel?.User?.Id"></span>
                                        </div>
                                    </div>
                                    <!-- <div class="flex justify-center items-center text-caption-1 text-error-400 border-t border-neutral-2-100">
                                        <span class="cursor-pointer pt-2 flex items-center" (click)="assignUser()">
                                            <i class="tdsi-error-line leading-none mr-2"></i>Bỏ gán nhân viên
                                        </span>
                                    </div> -->
                                </div>
                            </tds-dropdown-menu>
                        </button>
                    </div>
                </tds-collapse-panel>
            </tds-collapse>

            <!-- Sản phẩm -->
            <tds-collapse [expandIconPosition]="'right'" class="bg-white collapse-content-bg-white mt-1">
                <tds-collapse-panel [header]="headerProduct" [active]="true" [disabled]=false [expandedIcon]="'tdsi-arrow-up-line'" tdsClass="p-0">
                    <ng-template #headerProduct>
                        <span class="text-header-1 font-semibold text-neutral-1-900 font-sans mr-2">Sản phẩm</span>
                        <tds-badge *ngIf="quickOrderModel.Details" [standalone]="true" [count]="quickOrderModel.Details.length" [tdsClass]="'bg-success-400 text-white'"></tds-badge>
                    </ng-template>

                    <div class="flex gap-1.5 px-4 pt-6 pb-3">
                        <div class="w-full">
                            <div class="relative flex-auto">
                                <tds-form-field class="w-full">
                                    <input tdsInput placeholder="Tìm kiếm sản phẩm" autocomplete="off" [tdsInputDebounce]="750" [(ngModel)]="textSearchProduct"
                                        [ngModelOptions]="{standalone: true}" (inputKeyup)="onSearchProduct($event)">

                                    <span tdsPrefix><i class="text-neutral-1-500 tdsi-search-fill"></i></span>
                                    <span *ngIf="textSearchProduct" tdsSuffix>
                                        <i (click)="closeSearchProduct()" class="text-neutral-1-500 tdsi-close-fill mr-2"></i>
                                    </span>

                                    <span tdsSuffix class="cursor-pointer" title="Chọn sản phẩm" (click)="showModalListProduct()">
                                        <i class="text-neutral-1-500 tdsi-product-line"></i>
                                    </span>
                                </tds-form-field>

                                <virtual-scroller *ngIf="textSearchProduct && lstProductSearch && lstProductSearch.length > 0; else noDataProduct"
                                    #scroll [items]="lstProductSearch"
                                    (vsEnd)="vsEndUOMLine($event)"
                                    [enableUnequalChildrenSizes]="true"
                                    [scrollAnimationTime]="750"
                                    class="absolute left-0 right-0 -bottom-2 top-full p-2 h-[300px] text-caption-1 overflow-hidden overflow-y-auto tds-panel-scroll z-10 bg-white flex flex-col gap-y-2 shadow-md">
        
                                    <div *ngFor="let item of scroll.viewPortItems; let index = index;"
                                        (click)="selectProduct(item)" class="w-full block h-[56px]">
        
                                        <div *ngIf="item" class="flex flex-col p-2 hover:bg-neutral-3-50 cursor-pointer rounded-md" [ngClass]="index == indClick ? 'bg-neutral-3-50': ''">
                                          <div>
                                              <span class="text-info-400"> {{ item.NameGet }} - {{ item.Price | numberCustom }}đ </span>
                                          </div>
        
                                          <div *ngIf="lstInventory && lstInventory[item.Id]">
                                              <span class="text-neutral-1-400">Tồn kho: </span>
                                              <span class="text-primary-1">{{lstInventory[item.Id] ? lstInventory[item.Id].QtyAvailable : 0}}</span>/
        
                                              <span class="text-neutral-1-400">Tồn dự báo: </span>
                                              <span class="text-primary-1">{{lstInventory[item.Id] ? lstInventory[item.Id].VirtualAvailable : 0}}</span>
                                          </div>
                                        </div>
                                    </div>
                                    <div *ngIf="isLoadingNextdata" class="px-2 bg-white">
                                        <tds-skeleton [tdsActive]="true" [tdsTitle]="false" [tdsParagraph]="{ rows: 2 }"></tds-skeleton>
                                    </div>
        
                                </virtual-scroller>

                                <ng-template #noDataProduct>
                                    <div *ngIf="textSearchProduct" class="absolute left-0 right-0 -bottom-2 top-full h-44 overflow-hidden z-10 bg-white shadow-md">
                                        <tds-spin [spinning]="isLoadingProduct">
                                            <tds-empty></tds-empty>
                                        </tds-spin>
                                    </div>
                                </ng-template>
                            </div>
                        </div>
                        <button tds-button-flat-icon type="button" color="secondary" class="cursor-pointer"
                            tds-tooltip tooltipTitle="Thêm sản phẩm" (click)="showModalAddProduct()">
                            <span class="flex items-center"> <i class="tdsi-add-fill text-primary-1"></i></span>
                        </button>
                        <!-- <button tds-button-flat-icon type="button" color="secondary" class="cursor-pointer"
                            tds-tooltip tooltipTitle="Khuyến mãi" (click)="showModalAddPromotion()">
                            <span class="flex items-center"><i class="tdsi-gift-fill text-primary-1"></i></span>
                        </button> -->
                        <button tds-button-flat-icon type="button" color="secondary" class="cursor-pointer"
                            tds-tooltip tooltipTitle="Chọn bảng giá" (click)="showModalConfigProduct()">
                            <span class="flex items-center"><i class="tdsi-adjustments-fill text-neutral-1-400"></i></span>
                        </button>
                    </div>

                    <div class="max-h-[270px] overflow-y-auto tds-panel-scroll w-full px-3">
                        <tds-table #basicTable class="w-full h-full" [listData]="quickOrderModel.Details" [noResult]="emptyData" [frontPagination]="false">
                            <tbody>
                                <tr class="bg-white editable-row py-3" *ngFor="let item of quickOrderModel.Details; let index =index">
                                    <!-- Sản phẩm -->
                                    <td width="60%">
                                        <div class="flex gap-3.5">
                                            <tds-avatar size="xl" [isAvatar]="false" [shape]="'square'" class="bg-white h-[58px] w-[58px]" [tdsSrc]="item.ImageUrl">
                                            </tds-avatar>

                                            <div class="flex flex-col gap-y-0.5 w-2/3">
                                                <p class="font-semibold xl:text-caption-1">{{ item.ProductNameGet }}</p>

                                                <!-- giá bán -->
                                                <div class="text-neutral-1-400 flex items-center gap-x-2">
                                                    <span class="text-[13px] flex">
                                                        <span *ngIf="item.UOMName" class="text-[13px] flex"> {{ item.UOMName }} -&nbsp;</span>
                                                        {{ item.Price | numberCustom }}đ
                                                    </span>

                                                    <span class="tdsi-edit-line flex text-base cursor-pointer mr-1" tds-popover [popoverVisible]="visibleIndex == index"
                                                        popoverTrigger="click" [popoverContent]="tmpEditPrice" [popoverAutoClose]="true" [popoverBackdrop]="true"
                                                        (popoverVisibleChange)="openPopover($event, item.Price, index)">
                                                    </span>

                                                    <!-- <span *ngIf="item.Discount > 0 && isEnableCreateOrder" class="text-caption-1 text-primary-1 flex justify-center items-center font-semibold">
                                                        <i class="tdsi-tag-fill mr-1"></i> {{item.Discount}}%
                                                    </span> -->

                                                    <ng-template #tmpEditPrice>
                                                        <div class="w-[336px] flex flex-col gap-y-4" *ngIf="item">
                                                            <div class="flex gap-x-4 items-center">
                                                                <tds-label class="w-1/3">Đơn giá</tds-label>

                                                                <tds-form-field class="w-2/3">
                                                                    <tds-input-number autocomplete="off" placeholder="0" [min]="0" [step]="1000"
                                                                        [formatter]="numberWithCommas" [parser]="parserComas"
                                                                        [(ngModel)]="priceValue" [ngModelOptions]="{standalone: true}">
                                                                    </tds-input-number>
                                                                </tds-form-field>
                                                            </div>

                                                            <!-- <div class="flex gap-x-4 items-center">
                                                                <tds-label class="w-1/3">Giảm giá</tds-label>

                                                                <tds-form-field class="w-2/3">
                                                                    <tds-input-number autocomplete="off" placeholder="0" [min]="0" [step]="1" [max]="100"
                                                                        [formatter]="numberWithCommas" [parser]="parserComas" [disabled]="true">
                                                                    </tds-input-number>
                                                                    <span tdsSuffix>
                                                                        <span class="font-semibold text-body-2 font-sans text-primary-1">%</span>
                                                                        <span class="font-semibold text-body-2 font-sans text-neutral-1-400 pl-2">VNĐ</span>
                                                                    </span>
                                                                </tds-form-field>
                                                            </div> -->

                                                            <div class="flex gap-x-2 mt-4 justify-end">
                                                                <button class="min-w-[89px]" type="button" tds-button color="secondary" size="sm" (click)="closePriceDetail()">Hủy bỏ</button>
                                                                <button class="min-w-[89px]" type="button" tds-button color="primary" size="sm" (click)="approvePrice(item, index)">Áp dụng</button>
                                                            </div>
                                                        </div>
                                                    </ng-template>
                                                </div>

                                                <!-- ghi chú -->
                                                <span [ngClass]="item.Note? 'text-neutral-1-600 rounded-full bg-neutral-3-50 px-2' : 'text-info-500'" tds-popover popoverTrigger="click" [popoverContent]="popoverAddNote"
                                                    [popoverAutoClose]="true" [popoverBackdrop]="true" popoverPlacement="left" showMore [length]="15" [text]="item.Note || 'Ghi chú'">
                                                </span>

                                                <ng-template #popoverAddNote>
                                                    <div class="mb-2">
                                                        <tds-form-field>
                                                            <input tdsInput autocomplete="off" placeholder="Ghi chú" [(ngModel)]="item.Note" [ngModelOptions]="{standalone: true}"/>
                                                        </tds-form-field>
                                                    </div>
                                                </ng-template>
                                            </div>
                                        </div>
                                    </td>

                                    <!-- Số lượng -->
                                    <td width="30%">
                                        <div class="flex gap-x-2 items-center">
                                            <button type="button" class="tdsi-minus-fill text-white p-0.5 bg-neutral-1-200 rounded-full hover:bg-primary-1" [disabled]="item.Quantity == 1" (click)="minus(item, index)"></button>

                                            <tds-form-field class="w-[50px] hover:bg-primary-1 bg-opacity-10 rounded">
                                                <!-- <tds-input-number autocomplete="off" placeholder="Số lượng" [min]="1" [step]="1" [formatter]="numberWithCommas"
                                                    [parser]="parserComas" [(ngModel)]="item.Quantity" [ngModelOptions]="{standalone: true}" disabled="true">
                                                </tds-input-number> -->
                                                <input tdsInput autocomplete="off" class="text-center font-semibold text-neutral-1-900" placeholder="Số lượng" [(ngModel)]="item.Quantity" [ngModelOptions]="{standalone: true}" disabled="true" />
                                            </tds-form-field>
                                            <button type="button" class="tdsi-plus-fill text-white p-0.5 bg-neutral-1-200 rounded-full hover:bg-primary-1" (click)="plus(item, index)"></button>
                                        </div>
                                    </td>

                                    <!-- Xóa sản phẩm -->
                                    <td class="text-center h-full">
                                        <button type="button" (click)="onRemoveProduct(item, index)">
                                            <i class="tdsi-trash-line text-error-500 text-xl cursor-pointer"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </tds-table>
                        <ng-template #emptyData>
                            <div class="py-3 px-6 flex-auto">
                                <div class="flex flex-col gap-4 p-4 items-center bg-white h-full">
                                    <img src="../../../assets/imagesv2/shop-empty.svg" alt="" class="w-[110px] h-[82px]">
                                    <span class="text-neutral-1-400 font-normal">Chưa có sản phẩm nào</span>
                                </div>
                            </div>
                        </ng-template>
                    </div>
                    <div class="w-ful h-full p-3 pb-4" *ngIf="!isEnableCreateOrder && quickOrderModel.Details && quickOrderModel.Details.length > 0">
                        <div class="bg-neutral-2-50 flex justify-between rounded-xl gap-x-4 p-4">
                            <label>Tổng</label>
                            <span class="col-span-2 text-right">{{ quickOrderModel.TotalAmount || 0 | numberCustom }}</span>
                        </div>
                    </div>

                    <!-- Tổng số lượng và tổng tiền -->
                    <div class="w-ful h-full p-3 pb-4" *ngIf="isEnableCreateOrder && saleModel">
                        <div class="bg-neutral-2-50 rounded-xl grid 2xl:grid-cols-6 xl:grid-cols-3 gap-y-4 gap-x-3 p-4 items-center">

                            <label>Tổng</label>
                            <span class="col-span-2 text-right">{{ quickOrderModel.TotalAmount || 0 | numberCustom }}</span>

                            <label class="font-semibold">Tổng tiền</label>
                            <span class="text-header-1 font-semibold col-span-2 text-right">{{ saleModel.AmountTotal | numberCustom }}</span>

                            <label *ngIf="saleConfig?.SaleSetting?.GroupDiscountTotal">Giảm giá</label>
                            <div *ngIf="saleConfig?.SaleSetting?.GroupDiscountTotal" class="bg-white col-span-2 inline-flex rounded border border-neutral-2-200 pl-3">
                                <span class="flex flex-auto items-center h-8">{{saleModel.DecreaseAmount + saleModel.DiscountAmount || 0 | numberCustom}}</span>

                                <span class="flex items-center justify-center h-8 w-8"
                                    tds-popover popoverTrigger="click" [popoverContent]="tmpDiscount" [popoverAutoClose]="true" [popoverBackdrop]="true">
                                    <i class="tdsi-discount-fill text-primary-1 hover:opacity-70 text-xl cursor-pointer"></i>
                                </span>

                                <ng-template #tmpDiscount>
                                    <div class="flex flex-col gap-y-2">
                                        <div class="flex items-center">
                                            <tds-label class="w-[35%] font-normal text-sm">Chiếc khấu (%) </tds-label>

                                            <tds-form-field class="w-[35%]">
                                                <tds-input-number autocomplete="off"  [min]="0" [max]="100" [step]="1"
                                                    (ngModelChange)="changeDiscount($event)" [(ngModel)]="saleModel.Discount" [ngModelOptions]="{standalone: true}">
                                                </tds-input-number>
                                                <span tdsSuffix><span class="font-semibold font-sans text-primary-1">%</span></span>
                                            </tds-form-field>

                                            <div class="w-[30%] flex justify-end text-primary-1 font-semibold">
                                                <span> -{{ saleModel.DiscountAmount | numberCustom  }}đ </span>
                                            </div>
                                        </div>

                                        <div class="flex items-center">
                                            <tds-label class="w-[35%] font-normal text-sm">Giảm tiền</tds-label>
                                            <tds-form-field class="w-[35%]">
                                                <tds-input-number autocomplete="off" placeholder="0" [min]="0" [step]="1000"
                                                    (ngModelChange)="changeDecreaseAmount($event)" [(ngModel)]="saleModel.DecreaseAmount" [ngModelOptions]="{standalone: true}">
                                                </tds-input-number>
                                            </tds-form-field>

                                            <div class="w-[30%] flex justify-end text-primary-1 font-semibold">
                                                <span> -{{ saleModel.DecreaseAmount }}đ </span>
                                            </div>
                                        </div>
                                    </div>
                                </ng-template>
                            </div>

                            <label>Tiền cọc</label>
                            <tds-form-field class="col-span-2">
                                <tds-input-number [min]="0" [step]="1000" autocomplete="off" placeholder="0" [formatter]="numberWithCommas" [parser]="parserComas"
                                    (ngModelChange)="changeAmountDeposit($event)" [(ngModel)]="saleModel.AmountDeposit" [ngModelOptions]="{standalone: true}">
                                </tds-input-number>
                            </tds-form-field>

                            <label *ngIf="saleConfig?.SaleSetting?.GroupFastSaleTax">Thuế</label>
                            <div *ngIf="saleConfig?.SaleSetting?.GroupFastSaleTax" class="bg-white col-span-2 inline-flex rounded border border-neutral-2-200 pl-3">
                                <span class="flex flex-auto items-center h-8">{{ saleModel.Tax?.Amount || 0 | numberCustom }}</span>

                                <span  class="flex items-center justify-center h-8 w-8">
                                    <i class="tdsi-revenue-fill text-primary-1 hover:opacity-70 text-xl cursor-pointer" (click)="showModalTax()"></i>
                                </span>
                            </div>

                            <label>Thanh toán</label>
                            <tds-form-field class="col-span-2">
                                <tds-input-number [min]="0" [step]="1000" autocomplete="off" placeholder="0" [required]='true' [formatter]="numberWithCommas" [parser]="parserComas"
                                    [(ngModel)]="saleModel.PaymentAmount" [ngModelOptions]="{standalone: true}" [max]="saleModel.AmountTotal">
                                </tds-input-number>
                            </tds-form-field>
                        </div>
                    </div>
                </tds-collapse-panel>
            </tds-collapse>

            <!-- Checkbox tạo hóa đơn bán hàng -->
            <div class="py-4 bg-primary-3 px-6 mt-1">
                <tds-checkbox [(ngModel)]="isEnableCreateOrder" [ngModelOptions]="{standalone: true}" (change)="onEnableCreateOrder($event)">
                    <span class="font-semibold">Tạo hoá đơn bán hàng</span>
                </tds-checkbox>
            </div>

            <!-- Giao hàng -->
            <tds-collapse *ngIf="isEnableCreateOrder && saleModel" [expandIconPosition]="'right'" class="bg-white collapse-content-bg-white mt-1">
              <tds-collapse-panel [header]="headerShip" tdsClass="w-full rounded-b-xl bg-white p-4" [active]="true" [expandedIcon]="'tdsi-arrow-right-line'">
                  <ng-template #headerShip>
                    <span class="text-header-1 font-semibold text-neutral-1-900 font-sans mr-2">Giao hàng</span>
                  </ng-template>
                  <div class="grid gap-2 items-start w-full" *ngIf="saleModel">

                      <div class="w-full flex flex-col gap-y-2">
                          <div class="flex items-center">
                            <tds-label>Đối tác giao hàng</tds-label>
                        </div>

                          <div class="col-span-2" *ngIf="lstCarrier">
                              <tds-form-field>
                                  <tds-select valueField="Id" textField="Name" placeholder='Chọn đối tác giao hàng'
                                      [valuePrimitive]="false" [allowClear]="true" disabledField="isActive"
                                      [data]="lstCarrier" [ngModel]="saleModel.Carrier"
                                      [ngModelOptions]="{standalone: true}" [allowClear]="true"
                                      (ngModelChange)="onChangeCarrierV2($event)">
                                  </tds-select>
                              </tds-form-field>
                          </div>
                      </div>

                      <!-- thông tin dịch vụ -->
                      <div class="grid gap-y-4" *ngIf="saleModel.Carrier">

                        <!-- không có dịch vụ -->
                        <div class="w-full" *ngIf="shipServices && shipServices.length == 0 && shipExtraServices && shipExtraServices.length == 0">
                            <span class="text-body-2 italic">Chưa có dịch vụ nào</span>
                        </div>

                        <!-- danh sách dịch vụ -->
                        <div class="col-span-3 flex flex-row items-center" *ngIf="shipServices && shipServices.length > 0">
                            <tds-label class="w-1/4">Dịch vụ<span class="text-error-400">*</span></tds-label>

                            <tds-form-field class="w-3/4">
                                <tds-select valueField="ServiceId" textField="ServiceName"
                                    (ngModelChange)="onSelectShipServiceId($event)" placeholder='Chọn dịch vụ'
                                    disabledField="isActive" [valuePrimitive]="false"
                                    [ngModel]="saleModel.Ship_ServiceId" [ngModelOptions]="{standalone: true}"
                                    [data]="shipServices" [allowClear]="true">

                                    <ng-template tds-label-tmp let-item="item">  {{item.data.ServiceName}}
                                        <span *ngIf="item.data.TotalFee > 0">: {{item.data.TotalFee | numberCustom}}</span>
                                    </ng-template>

                                </tds-select>
                            </tds-form-field>
                        </div>

                        <div class="col-span-3 flex flex-row items-center" *ngIf="insuranceInfo">
                            <tds-label class="w-1/4">Giá trị hàng hóa</tds-label>

                            <div class="flex flex-row items-center gap-x-2 w-3/4">
                              <tds-form-field class="flex flex-auto">
                                  <tds-input-number [min]='0' [step]="1000" placeholder="Nhập phí" [formatter]="numberWithCommas" [parser]="parserComas"
                                    (ngModelChange)="changeShip_InsuranceFee($event)"
                                    [ngModel]="saleModel.Ship_InsuranceFee" [ngModelOptions]="{standalone: true}">
                                  </tds-input-number>
                              </tds-form-field>

                              <button tds-button-icon tds-tooltip tooltipTitle="Gán bằng tổng giá trị hoá đơn" color="primary"
                                  class="flex items-center justify-center" (click)="signAmountTotalToInsuranceFee()">
                                  <i class="tdsi-in-out-fill text-xl"></i>
                              </button>
                            </div>
                        </div>

                        <ng-container *ngFor="let item of configsProviderDataSource">
                            <div class="col-span-3 flex flex-row items-center" *ngIf="!item.IsHidden">
                                <tds-label class="w-1/4">{{item.DisplayName}}<span class="text-error-400">*</span></tds-label>
                                <tds-form-field class="w-3/4">
                                    <tds-select valueField="Id" textField="Name" placeholder='Chọn option'
                                        [data]="item.ConfigsValue" [ngModel]="item.ConfigValue" [allowClear]="true"
                                        [ngModelOptions]="{standalone: true}" [allowClear]="item.InputType == 'combo_box'">
                                    </tds-select>
                                </tds-form-field>
                            </div>
                        </ng-container>
                      </div>

                      <div class="grid grid-cols-3 gap-y-4 gap-x-6">
                        <!-- phí ship đối tác -->
                        <div class="col-span-3 w-full flex flex-row items-center" >
                            <tds-label class="pr-4">Phí ship (đối tác)</tds-label>

                            <div class="col-span-2 flex-auto flex items-center">
                              <div class="px-4">
                                  <span class="border rounded-md py-1 px-2 text-primary-1">{{saleModel.CustomerDeliveryPrice || 0 | numberCustom }}đ</span>
                              </div>

                              <div class="px-4 border-l">
                                  <button *ngIf="!saleModel.TrackingRef && isEnableCalcFee" tds-button-icon color="info" size="sm"  (click)="calcFee()" title="Tính lại tiền ship" type="button">
                                      <span class="flex items-center justify-center">
                                          <i class=" tdsi-reload-fill"></i>
                                      </span>
                                  </button>
                              </div>
                            </div>
                        </div>

                        <div class="col-span-3 w-full flex flex-col">
                            <div class="flex flex-row items-center gap-x-2 w-full">
                              <tds-form-field class="flex flex-auto">
                                <tds-label class="pr-3">Khối lượng ship(g)</tds-label>
                                <tds-input-number [min]="0" [step]="1" [(ngModel)]="saleModel.ShipWeight" [formatter]="numberWithCommas" [parser]="parserComas"
                                    (tdsBlur)="changeShipWeight()" [ngModelOptions]="{standalone: true}">
                                </tds-input-number>
                              </tds-form-field>
                            </div>
                        </div>

                        <div class="col-span-3 w-full flex flex-col">
                            <div class="flex flex-row items-center gap-x-2 w-full">
                              <tds-form-field class="flex flex-auto">
                                <tds-label class="pr-3">Phí giao hàng</tds-label>
                                <tds-input-number [min]="0" [step]="1000" [(ngModel)]="saleModel.DeliveryPrice" [formatter]="numberWithCommas" [parser]="parserComas"
                                    (ngModelChange)="changeDeliveryPrice($event)"[ngModelOptions]="{standalone: true}">
                                </tds-input-number>
                              </tds-form-field>
                            </div>
                        </div>

                        <div class="col-span-3 w-full flex flex-col">
                            <div class="flex flex-row items-center gap-x-2 w-full">
                              <tds-form-field class="flex flex-auto">
                                <tds-label class="pr-3">Giao hàng thu tiền</tds-label>
                                <tds-input-number [min]="0" [step]="1000" [(ngModel)]="saleModel.CashOnDelivery" [formatter]="numberWithCommas" [parser]="parserComas"
                                    (ngModelChange)="changeCashOnDelivery($event)" [ngModelOptions]="{standalone: true}">
                                </tds-input-number>
                              </tds-form-field>
                            </div>
                        </div>

                        <div class="col-span-3 w-full flex flex-col">
                            <div class="flex flex-row items-center gap-x-2 w-full">
                              <tds-form-field class="flex flex-auto">
                                <tds-label class="pr-3">Ghi chú giao hàng</tds-label>
                                <textarea class="resize-none no-scrollbar" rows="2" tdsInput autocomplete="off" [(ngModel)]="saleModel.DeliveryNote" [ngModelOptions]="{standalone: true}" placeholder="Nhập ghi chú" >
                                </textarea>
                              </tds-form-field>
                            </div>
                        </div>

                        <!-- ship extras service -->
                        <div *ngIf="shipExtraServices && shipExtraServices.length > 0" class="col-span-3">
                            <div class="grid grid-cols-3 gap-y-4 gap-x-6">
                                <div *ngFor="let child of shipExtraServices; let i=index">
                                    <tds-checkbox [ngModel]="child.IsSelected" [ngModelOptions]="{standalone: true}" (ngModelChange)="changeIsSelectedEx($event, i)">
                                        <div class="flex flex-row items-center w-full">

                                            <span class="mr-2">{{child.Name}}</span>
                                            <div *ngIf="saleModel.Carrier!.DeliveryType === 'ViettelPost' && child.Id == 'XMG' && child.IsSelected == true">
                                                <button type="button" style="border-bottom: dashed 2px #2395FF;" tds-popover
                                                    popoverTrigger="click" (click)="openPopoverShipExtraMoney(child.ExtraMoney)"
                                                    [(popoverVisible)]="visibleShipExtraMoney"
                                                    [popoverContent]="popoverContentShip_ExtraMoney"
                                                    [popoverFooter]="popoverFooterShip_ExtraMoney" [popoverAutoClose]="true"
                                                    [popoverBackdrop]="true" popoverPlacement="right">
                                                    {{(child.ExtraMoney | number) || 0}}đ
                                                </button>

                                                <!-- popover button Thuế -->
                                                <ng-template #popoverContentShip_ExtraMoney>
                                                    <div class="flex gap-x-2">
                                                        <tds-form-field>
                                                            <tds-input-number [min]='0' [step]="1000" [(ngModel)]="extraMoney"
                                                                [formatter]="numberWithCommas" [parser]="parserComas" [ngModelOptions]="{standalone: true}">
                                                            </tds-input-number>
                                                        </tds-form-field>
                                                    </div>
                                                </ng-template>

                                                <ng-template #popoverFooterShip_ExtraMoney>
                                                    <div class="flex justify-end gap-x-2 mt-2">
                                                        <button tds-button-icon color="primary" type="button" (click)="changeShipExtraMoney($event)">
                                                            <span class="flex items-center">
                                                              <i class="tdsi-checkbox-check-fill"></i>
                                                            </span>
                                                        </button>

                                                        <button tds-button-icon color="secondary" type="button" (click)="closePopoverShipExtraMoney()">
                                                            <span class="flex items-center">
                                                                <i class="tdsi-close-fill"></i>
                                                            </span>
                                                        </button>
                                                    </div>
                                                </ng-template>

                                            </div>
                                        </div>
                                    </tds-checkbox>

                                    <span class="text-body-2 text-primary" *ngIf="child.Fee">{{ child.Fee || 0 | numberCustom }}</span>
                                </div>
                            </div>
                        </div>
                      </div>
                  </div>
              </tds-collapse-panel>
          </tds-collapse>

          <!-- Button Footer conversation all, message, inbox-->
          <div class="flex gap-x-3 py-3 px-6 bg-white mt-1" *ngIf="type != 'post'">
              <button tds-button class="min-w-[100px]" type="button" color="primary" (click)="onSave()">Lưu nháp</button>
              <button *ngIf="isEnableCreateOrder" tds-button class="min-w-[100px]" type="button" color="info" (click)="onSave('SaveAndOpen')">Xác nhận</button>

              <button *ngIf="!isEnableCreateOrder" tds-button class="min-w-[100px]" type="button" color="info" (click)="onSave('SaveAndOpen', 'print')">Lưu và in</button>

              <div class="gap-x-2 xl:flex 2xl:hidden">
                <button *ngIf="isEnableCreateOrder" tds-button-icon color="primary" type="button" color="secondary" (click)="onSave('SaveAndPrint', 'print')" tds-tooltip="In hóa đơn">
                  <i class="tdsi-paper-fill text-neutral-1-500 text-lg leading-none"></i>
                </button>


                <button *ngIf="isEnableCreateOrder" tds-button-icon color="primary"  type="button" color="secondary" (click)="onSave('SaveAndPrint','printShip')" tds-tooltip="In phiếu ship">
                  <i class="tdsi-truck-fill text-neutral-1-500 text-lg leading-none"></i>
                </button>
              </div>

              <div class="gap-x-2 xl:hidden 2xl:flex">
                <button *ngIf="isEnableCreateOrder" tds-button class="min-w-[100px]" type="button" color="secondary" (click)="onSave('SaveAndPrint', 'print')">
                  <span class="flex items-center">
                      <i class="tdsi-paper-fill text-neutral-1-500 text-lg leading-none mr-2"></i>In hóa đơn
                  </span>
                </button>
                <button *ngIf="isEnableCreateOrder" tds-button class="min-w-[100px]" type="button" color="secondary" (click)="onSave('SaveAndPrint','printShip')">
                    <span class="flex items-center">
                        <i class="tdsi-truck-fill text-neutral-1-500 text-lg leading-none mr-2"></i>In phiếu ship
                    </span>
                </button>
              </div>
          </div>

          <!-- Button Footer conversation post-->
          <div class="flex gap-x-3 py-3 px-6 bg-white mt-1" *ngIf="type == 'post'">
            <button tds-button class="min-w-[100px]" type="button" color="primary" (click)="onInsertFromPost()">Lưu</button>

            <button tds-button class="min-w-[100px]" type="button" color="primary" (click)="onInsertFromPost('SaveAndPrint', 'print')">
               Lưu và in
            </button>

            <button *ngIf="isEnableCreateOrder" tds-button class="min-w-[100px]" type="button" color="secondary" (click)="onInsertFromPost('SaveAndPrint','printShip')">
                <span class="flex items-center">
                    <i class="tdsi-truck-fill text-neutral-1-500 text-lg leading-none mr-2"></i>In phiếu ship
                </span>
            </button>
          </div>

          <!-- Khoản trắng ở cuối giao diện -->
          <div class="flex-auto bg-white mt-1"></div>
        </div>
    </div>
</tds-spin>
