<tds-spin  [spinning]="isLoading">
  <div class="w-full h-full bg-neutral-3-200">
    <div class="bg-white pt-4">
        <tds-page-header title="Kênh kết nối">
            <tds-page-header-extra>
                <button tds-button color="primary" class="mr-2" (click)="mergePage()">
                    <span class="flex items-center">
                      <i class="tdsi-copy-fill text-lg leading-none mr-2"></i>Gộp Page
                    </span>
                </button>

                <tds-button-group class="mr-2">
                    <button tds-button color="secondary" tds-dropdown trigger="click" [tdsDropdownMenu]="menu" (click)="onClickDropdown($event)" placement ="bottomRight">
                        <span class="text-neutral-1-900 flex  items-center justify-center text-body-2 font-semibold">
                            {{currentFilter.name}} <i class="tdsi-arrow-down-fill text-base leading-none ml-1.5 text-neutral-1-900"></i>
                        </span>
                    </button>
                    <tds-dropdown-menu #menu="tdsDropdownMenu">
                        <div class="w-full">
                            <ng-template ngFor let-item [ngForOf]="listFilter">
                                <div tds-dropdown-item (click)="onClickFieldListAll(item)" *ngIf="item.id != 4">
                                    <a class="text-primary-1 flex items-center">
                                        <div class="pl-2 text-neutral-1-900">{{item.name}}</div>
                                    </a>
                                </div>
                            </ng-template>
                        </div>
                    </tds-dropdown-menu>
                </tds-button-group>

                <tds-form-field class="w-[368px]">
                    <input class="placeholder-neutral-1-400" #innerText placeholder="Tìm kiếm..." tdsInput />
                    <span tdsPrefix ><i class="text-neutral-1-500 tdsi-search-fill text-base"></i></span>
                </tds-form-field>

            </tds-page-header-extra>
        </tds-page-header>
    </div>
    <div class="mx-auto p-4 flex flex-col gap-4">
      <div *ngIf="data && data.length > 0 || dataSearch" class="flex gap-x-4 w-full">

        <!-- Col Left -->
        <div class="w-3/4 gap-y-4 flex flex-col">
            <div *ngFor="let team of (dataSearch || data); let index = index" @eventFadeState>
                <tds-collapse [expandIconPosition]="'right'" class="bg-white rounded-xl w-full">
                    <tds-collapse-panel  [header]="header" [active]="getIsIconCollapse(team.Id)" [disabled]=false
                        [expandedIcon]="expandedIcon" bordered="false" (activeChange)="onChangeCollapse(team.Id, $event)">

                        <!-- Header -->
                        <ng-template #header>
                          <div class="flex gap-4 items-center bg-neutral-3-500 ">
                              <div class="relative">
                                  <tpage-avatar-facebook [size]="'xl'" [fbid]="team?.Facebook_ASUserId" [token]="team?.Facebook_UserToken">
                                  </tpage-avatar-facebook>
                                  <span class="absolute right-0 bottom-0">
                                      <span *ngIf="!team.Active"><img style="filter: grayscale(1)" src="../../../assets/imagesv2/facebook/icon-facebook.svg"></span>
                                      <span *ngIf="team.Active"><img src="../../../assets/imagesv2/facebook/icon-facebook.svg"></span>
                                  </span>
                              </div>
                              <div class="flex flex-col gap-1">
                                  <div class="flex gap-2 items-center">
                                      <div class="text-title-1 font-sans font-semibold"> {{team?.Name}} </div>
                                  </div>
                                  <div *ngIf="team.Active" class="font-regular font-sans text-xs ">
                                      <p *ngIf="!lstData[team.Id]?.data || lstData[team.Id].data.length < 1" class="text-neutral-1-400">
                                          <span style="color: #929DAA; font-size: 12px;">Chưa có trang nào được kết nối</span>
                                          <span class="font-semibold text-success-400 ml-2">Kết nối trang</span>
                                      </p>
                                  </div>
                                  <div *ngIf="!team.Active" class="text-body-2 font-regular font-sans ">
                                      <p class="text-neutral-1-400" style="color: #929DAA; font-size: 12px;">Tài khoản đang ẩn</p>

                                      <p *ngIf="!lstData[team.Id]?.data || lstData[team.Id].data.length < 1" class="text-neutral-1-400">
                                          <span style="color: #929DAA; font-size: 12px;">Chưa có trang nào được kết nối</span>
                                          <span class="font-semibold text-success-400 ml-2">Kết nối trang</span>
                                      </p>
                                  </div>
                              </div>
                          </div>
                        </ng-template>

                      <!-- Header Icon -->
                      <ng-template #expandedIcon>
                        <div class="flex gap-4">
                            <div class="border border-neutral-2-200 border-solid rounded-md" (click)="onActive(team.Id, true)" tds-tooltip [tooltipTitle]="'Ẩn/ Hiện User'">
                                <div *ngIf="!team.Active" class="tdsi-eye-open-fill p-2 text-neutral-1-500"></div>
                                <div *ngIf="team.Active" class="tdsi-eye-close-fill p-2 text-neutral-1-500"></div>
                            </div>
                            <div class="border border-neutral-2-200 border-solid rounded-md" (click)="unConnected(team.Id, team.Facebook_PageName)"
                                tds-tooltip [tooltipTitle]="'Hủy kết nối'">
                                <div class="tdsi-break-link-fill p-2 text-neutral-1-500"></div>
                            </div>
                            <div class="border border-neutral-2-200 border-solid rounded-md">
                                <div *ngIf="!getIsIconCollapse(team.Id)" class="tdsi-arrow-up-line p-2 text-neutral-1-500"></div>
                                <div *ngIf="getIsIconCollapse(team.Id)" class="tdsi-arrow-down-line p-2 text-neutral-1-500"></div>
                            </div>
                        </div>
                      </ng-template>

                      <div *ngIf="((lstData[team.Id].data.length > 0) || (lstData[team.Id].notConnected.length > 0)); else notPageConnected" class="flex flex-col w-full gap-4">
                        <!-- Page đã kết nối -->
                          <div *ngFor="let child of lstData[team.Id].data">
                            <div class="flex justify-between items-center pb-4 border-b">
                              <div class="flex gap-4 items-center">
                                  <div class="relative">
                                      <tpage-avatar-facebook [fbid]="child?.ChannelId" [token]="child?.Facebook_PageToken" [size]="'lg'">
                                      </tpage-avatar-facebook>
                                      <div class="absolute bottom-0 right-0 rounded-full bg-white flex items-center justify-center">
                                        <span><img src="../../../assets/imagesv2/conversation/union.svg"></span>
                                    </div>
                                  </div>

                                  <div>
                                      <div class="text-neutral-1-900 font-sans font-semibold text-sm">{{ child.Name }}</div>
                                      <div class="flex gap-2 items-center">

                                          <div class="tdsi-success-fill text-primary-1 text-xl"></div>
                                          <div class="text-body-2 text-neutral-1-900 font-regular"> {{child.Active ? 'Đã kết nối' : 'Đóng kết nối'}}</div>

                                          <div class="text-success-400 flex items-center gap-x-1 cursor-pointer"
                                              *ngIf="userFBLogin?.id && userFBLogin?.id == team?.Facebook_UserId && team.Active"
                                              (click)="refreshPageToken(team.Id, child.ChannelId)">

                                              <span class="tdsi-undo-line flex text-sm"></span>
                                              <span class="flex text-xs">Cập nhật token</span>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                              <div class="flex gap-1 items-center">
                                  <div class="flex gap-2">
                                      <button tds-button color="secondary" class="!rounded-full border-0" (click)="onActive(child.Id, false)">
                                        <div class="text-neutral-1-900 flex items-center gap-x-2" *ngIf="child.Active">
                                          <i class="tdsi-eye-close-fill text-neutral-1-500 text-base"></i>
                                          <span class="text-sm font-semibold">Ẩn Page</span>
                                        </div>
                                        <div class="text-neutral-1-900 flex items-center gap-x-2" *ngIf="!child.Active">
                                          <span class="text-sm text-neutral-400 font-normal">
                                            Đã ẩn trang
                                          </span>
                                          <span class="text-sm font-semibold text-[#2B88FB]">
                                            Hiện trang
                                          </span>
                                        </div>
                                      </button>
                                  </div>
                                  <span class="text-neutral-2-200"> | </span>
                                  <button tds-button color="secondary" class="!rounded-full border-0"
                                    (click)="unConnected(child.Id, child.Facebook_PageName)">
                                      <span class="flex items-center">
                                        <i class="tdsi-break-link-fill text-lg leading-none mr-2 text-neutral-1-500"></i>Hủy kết nối
                                      </span>
                                  </button>
                              </div>
                            </div>
                          </div>

                        <!-- Page chưa kết nối -->
                          <div *ngIf="lstData[team.Id].notConnected < 1; else templatePageNotConnect">
                              <span class="cursor-pointer text-success-400 text-xs" (click)="loadPageNotConnect(team)">Xem thêm Page chưa kết nối</span>
                          </div>

                          <ng-template #templatePageNotConnect>
                            <div *ngFor="let pageNot of lstData[team.Id].notConnected as lstPageNotConnects; let index = index"
                              class="flex justify-between items-center" [ngClass]="index == lstPageNotConnects.length - 1 ? '' : 'border-b border-neutral-2-200 border-solid pb-4'">
                              <div class="flex gap-4 items-center" *ngIf="pageNot">
                                  <div class="mr-3 relative">
                                      <tds-avatar size="lg" class="bg-accent-4 text-white" tdsSrc="{{ pageNot?.picture?.data?.url || 'error-link'}}">
                                      </tds-avatar>
                                      <div class="absolute bottom-0 right-0 rounded-full bg-white flex items-center justify-center">
                                        <span><img src="../../../assets/imagesv2/conversation/union.svg"></span>
                                    </div>
                                  </div>
                                  <div>
                                      <div class="text-body-2 text-neutral-1-900 font-sans font-semibold"> {{ pageNot.name }} </div>
                                      <div class="flex gap-2 items-center">
                                          <div class="tdsi-link-fill text-neutral-1-500 text-xl"></div>
                                          <div class="text-neutral-1-500 text-body-2 font-regular">Chưa kết nối</div>
                                      </div>
                                  </div>
                              </div>
                              <div class="flex gap-3 items-center">
                                  <button tds-button color="primary" (click)="showModalAddPage(pageNot, team)">Kết nối</button>
                              </div>
                            </div>
                          </ng-template>
                      </div>

                      <!-- Chưa có Page nào được kết nối -->
                      <ng-template #notPageConnected>
                        <div class="flex justify-center w-full">
                          <div class="w-64 flex flex-col gap-y-4 justify-center">
                            <div class="flex justify-center">
                              <img src="../../../assets/imagesv2/facebook/flag.png" class="w-[90px] h-[69px]">
                            </div>
                            <div class="text-body-2 text-center text-neutral-1-300">Tài khoản chưa có trang Facebook nào</div>
                            <div class="flex justify-center">
                              <button tds-button color="success" (click)="loadPageNotConnect(team)">
                                <div class="flex items-center gap-x-2">
                                  <i class="tdsi-break-link-fill text-lg leading-none flex"></i> <p>Kết nối trang</p>
                                </div>
                            </button>
                            </div>
                          </div>
                        </div>
                      </ng-template>
                    </tds-collapse-panel>
                </tds-collapse>
            </div>
        </div>

        <!-- Col Right -->
        <div class="w-1/4 flex flex-col gap-y-4">
          <div class="bg-white rounded-xl w-full p-4 flex flex-col gap-y-4" *ngIf="!userFBLogin || !userFBLogin.id; else userLoggedFacebook">
            <p class="text-lg font-semibold">Kết nối tài khoản</p>
            <img src="../../../assets/imagesv2/conversation/img-connect-1.svg" />
            <span class="text-sm font-normal text-center">
              Kết nối tài khoản Facebook của bạn để đồng bộ
              tin nhắn, bình luận, bài viết về TPage
            </span>
            <button size="xl" class="flex py-[9px] px-[17px] bg-blue-600 rounded-md justify-center" (click)="facebookSignIn()">
              <span class="flex items-center text-white text-sm gap-x-2">
                <i class="tdsi-facebook-2-fill text-body-1 leading-none"></i> <span class="font-semibold text-sm">Kết nối với facebook</span>
              </span>
            </button>
          </div>

          <ng-template #userLoggedFacebook>
            <div class="bg-white rounded-xl w-full p-4">
              <div class="bg-neutral-3-500 w-full flex items-center flex-wrap">
                  <div class="flex items-center w-full">
                     <div class="relative">
                        <tds-avatar [size]="'xl'" [tdsSrc]="userFBLogin?.picture?.data.url" [shape]="'circle'"></tds-avatar>
                        <span class="absolute bottom-0 right-0 w-[24px] h-[24px] block">
                            <img src="../../../assets/imagesv2/conversation/facebook-circle.svg">
                        </span>
                     </div>
                     <div class="text-title-1 font-sans font-semibold ml-4">{{userFBLogin?.name}}</div>
                  </div>
                  <div class="w-full" style="margin-top: 30px">
                    <div *ngIf="!isUserConnectChannel" class="w-full grid ">
                        <button  type="button" tds-button color="primary" (click)="onFacebookConnected()"
                        tds-tooltip tooltipTitle="Thêm page vào kênh kết nối">Thêm vào TPage</button>
                    </div>
                    <div *ngIf="isUserConnectChannel" class="w-full grid mt-2">
                        <button type="button" tds-button color="info" (click)="facebookSignOut()"
                        tds-tooltip tooltipTitle="Đăng xuất khỏi Facebook">Đăng xuất</button>
                    </div>
                  </div>
              </div>
            </div>
          </ng-template>

          <div class="bg-white rounded-xl w-full p-4 gap-y-4">
            <div class="flex gap-x-2 items-center">
                <p class="text-lg font-semibold">Thông tin chi tiết</p>
                <i class="tdsi-information-fill text-neutral-1-500 flex"></i>
            </div>
            <span class="flex text-sm font-normal"> Các trang có lượt tương tác & hoạt động tốt nhất gần đây. </span>
          </div>
        </div>
      </div>

      <!-- Data Empty -->
      <div *ngIf="!data || data.length < 1 && !isLoadChannel">
        <div class="rounded-2xl bg-cover background-content" style="background-image: url(../../../assets/imagesv2/facebook/background-facebook.png);">
          <div class="text-white p-11">
            <p class="title">Kết nối T-Page với tài khoản Facebook của bạn</p>
            <p class="text-sm mt-[17px]" >
              Kết nối tài khoản Facebook của bạn để đồng bộ <br>
              tin nhắn, bình luận, bài viết về T-page
            </p>
            <button tds-button color="secondary" size="xl" class="flex mt-[43px] py-[9px] px-[17px]" (click)="facebookSignIn()">
              <span class="flex items-center text-blue-600 text-sm gap-x-2">
                <img src="../../../assets/imagesv2/conversation/facebook.svg">Kết nối với facebook
              </span>
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>
</tds-spin>
