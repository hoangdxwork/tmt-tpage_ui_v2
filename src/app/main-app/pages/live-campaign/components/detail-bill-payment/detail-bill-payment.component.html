<div class="w-full h-full bg-white rounded-xl pb-2">
  <div class="flex flex-col h-full">
    <div class="p-4 font-semibold text-xl flex gap-x-2 justify-end">
      <tds-form-field>
        <input tdsInput placeholder="Tìm kiếm" autocomplete="off" (keyup.enter)="onSearch($event)"/>
        <span tdsPrefix><i class="text-neutral-1-500 tdsi-search-fill"></i></span>
      </tds-form-field>
      <bill-filter-options (onLoadOption)="onLoadOption($event)"></bill-filter-options>
    </div>

    <div class="h-full text-body-2 text-neutral-1-900">
      <tds-table #table
        [showSizeChanger]="true"
        [frontPagination]="false"
        [(pageSize)]="pageSize"
        [(pageIndex)]="pageIndex"
        [listData]="lstOfData"
        [scroll]="{y:'auto'}"
        [loading]="isLoading"
        [total]="count"
        [scroll]="{y:'auto'}"
        (clickRefresh)="refreshData()"
        (queryParams)="onQueryParamsChange($event)">
        <thead>
          <tr>
            <th [width]="'3.5%'">STT</th>
            <th [width]="'10%'">Hình thanh toán</th>
            <th [width]="'9%'">Số HĐ</th>
            <th [width]="'8%'">Khách hàng</th>
            <th [width]="'6%'">Tiền cọc</th>
            <th [width]="'6%'">Còn nợ</th>
            <th [width]="'6%'">Tổng tiền</th>
            <th [width]="'7%'">Tiền thu hộ</th>
            <th [width]="'7%'">Trạng thái</th>
            <th [width]="'10%'">Nhân viên</th>
            <th [width]="'9%'">Ngày cập nhật</th>
            <th [width]="'16%'">Thao tác</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let bill of table.data; let index=index">
            <td>
              {{index + 1}}
            </td>
            <!-- Hình thanh toán -->
            <td>
              <!-- {{bill.IRAttachmentUrl}} -->
            </td>
            <!-- Số HĐ -->
            <td>
              <div class="flex flex-col gap-y-2">
                <span class="text-xs text-error-400" *ngIf="!bill.IsDeposited">Chưa xác nhận cọc</span>
                <span class="text-xs text-accent-9" *ngIf="bill.IsDeposited">Đã xác nhận cọc</span>
                <span class="font-semibold">{{bill.Number}}</span>

                <!-- Nhãn -->
                <div class="flex items-center gap-x-1 w-full">
                  <div *ngIf="bill.Tags" class="flex flex-wrap gap-x-2 gap-y-1 items-center w-fit">
                    <div *ngFor="let item of bill.Tags | prettyjson">
                      <tds-tag class="truncate" status='primary'>{{item.Name}}</tds-tag>
                    </div>
                  </div>

                  <button (click)="openTag(bill.Id, bill.Tags)" tds-button-icon tds-popover
                    [popoverVisible]="indClickTag == bill.Id" popoverTrigger="click" [popoverFooter]="footerAddTag"
                    [popoverContent]="contentAddtag" [popoverBackdrop]="true" popoverPlacement="left" color="secondary" size="sm"
                    class=" border-0">
                    <div class="w-5 h-5 relative">
                      <i class="tdsi-tag-fill text-base leading-4 select-all absolute top-0 left-0"></i>
                      <svg class="border border-white bg-white rounded-full absolute bottom-0 right-0" width="12" height="12" viewBox="0 0 11 11" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M6.00263 0.185353C5.78089 0.14704 5.55607 0.129611 5.3311 0.133295C3.96134 0.134421 2.64803 0.680863 1.67966 1.65259C0.711296 2.62431 0.167057 3.94186 0.166496 5.3158C0.162824 5.54146 0.180199 5.76697 0.218396 5.98938C0.342953 6.94846 0.732804 7.85338 1.34378 8.60162C1.95476 9.34986 2.76244 9.91151 3.67532 10.2229C4.5882 10.5344 5.56979 10.5831 6.50889 10.3637C7.44798 10.1443 8.30703 9.66541 8.98873 8.98138C9.67042 8.29736 10.1475 7.4355 10.3659 6.49346C10.5843 5.55142 10.5354 4.56685 10.2246 3.65129C9.91374 2.73574 9.3535 1.92579 8.60732 1.31322C7.86114 0.70065 6.95883 0.309939 6.00263 0.185353ZM8.09029 5.79283H5.80879V8.08342H4.85553V5.79283H2.57403V4.83665H4.85764V2.53756H5.81091V4.83878H8.09452L8.09029 5.79283Z" fill="#28A745"/>
                      </svg>
                    </div>
                  </button>

                  <!-- button thêm nhãn -->
                  <ng-template #contentAddtag>
                    <div class="w-96">
                      <tds-form-field>
                        <tds-select valueField="Id" textField="Name" placeholder='Chọn các tag' [(ngModel)]="modelTags"
                          [allowClear]="true" [valuePrimitive]="false" [data]="lstTags" [autoClose]="true" mode="multiple">
                        </tds-select>
                      </tds-form-field>
                    </div>
                  </ng-template>

                  <ng-template #footerAddTag>
                    <div class="flex justify-end pt-2">
                      <button tds-button-icon color="secondary" class="mr-2" size="sm" (click)="closeTag()">
                        <span class="flex items-center">
                          <i class="tdsi-close-fill"></i>
                        </span>
                      </button>
                      <button tds-button-icon size="sm" (click)="assignTags(bill.Id, modelTags)">
                        <span class="flex items-center">
                          <i class="tdsi-tick-fill"></i>
                        </span>
                      </button>
                    </div>
                  </ng-template>
                </div>
              </div>
            </td>
            <!-- Khách hàng -->
            <td>
              <div class="flex flex-col gapy-2">
                <span> {{bill.PartnerDisplayName}} </span>
                <span class="text-sm text-neutral-1-500">{{bill.PartnerPhone}} </span>
              </div>
            </td>
            <!-- Tiền cọc -->
            <td>
              {{bill.AmountDeposit || 0 | number}}
            </td>
            <!-- Còn nợ -->
            <td>
              {{bill.Residual || 0 | number}}
            </td>
            <!-- Tổng tiền -->
            <td>
              {{bill.AmountTotal || 0 | number}}
            </td>
            <!-- Tiền thu hộ -->
            <td>
              {{bill.CashOnDelivery || 0| number}}
            </td>
            <!-- Trạng thái -->
            <td>
              <div class="w-full">
                <tds-tag [status]="getColorStatusText(bill.State)" size="sm" type="outline">{{bill.ShowState}}</tds-tag>
                <p *ngIf="bill.PaymentMessageCount" class="text-neutral-1-400 text-xs pt-2">Đã gửi yêu cầu thanh toán</p>
              </div>
            </td>
            <!-- Nhân viên -->
            <td>
              {{bill.UserName}}
            </td>
            <!-- Ngày cập nhật -->
            <td>
              {{bill.DateCreated | date: 'dd/MM/yyyy'}}
            </td>
            <!-- Thao tác -->
            <td>
              <div class="flex gap-x-2 items-center">
                <button tds-button-icon color="secondary" size="sm">
                  <span class="flex items-center">
                    <i class="tdsi-messenger-fill"></i>
                  </span>
                </button>
                <button tds-button-icon color="secondary" size="sm" (click)="onEdit(bill.Id)">
                  <span class="flex items-center">
                    <i class="tdsi-edit-fill"></i>
                  </span>
                </button>
                <button tds-button class="w-[100px] hidden show-payment" color="primary" type="button" (click)="onPayment(bill.Id)">
                  Thanh toán
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </tds-table>
    </div>
  </div>
</div>
