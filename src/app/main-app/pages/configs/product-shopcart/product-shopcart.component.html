<div class="w-full h-full pb-4 px-4">
    <div class="flex flex-col w-full h-full bg-white rounded-xl">
        <div class="flex flex-row items-center justify-between px-4 py-3">
            <div class="flex flex-row items-center">
                <tds-avatar class="bg-primary-1 text-white" icon="tdsi-variant-fill"></tds-avatar>
                <span class="text-neutral-1-900 text-header-1 font-semibold pl-2.5">SẢN PHẨM GIỎ HÀNG</span>
            </div>
        </div>
        <div class="flex flex-row w-full items-center justify-between px-4 py-2.5" *ngIf="configCart?.IsShopCart">
            <div class="flex justify-start text-title-1 font-semibold">Danh sách sản phẩm</div>
            <div class="flex flex-row items-center justify-end w-4/5">
                <!-- <div class="w-1/4 flex flex-row items-center justify-between mr-2">
                    <span class="font-semibold mr-1">Loại sản phẩm: </span>
                    <tds-form-field class="flex flex-auto">
                        <tds-select valueField="Id" textField="Name" placeholder='Chọn sản phẩm' [(ngModel)]="cateId"
                            [ngModelOptions]="{ standalone: true }" [data]="lstCateg" [allowClear]="true"
                            (selectChange)="onChangeCategory($event)">
                        </tds-select>
                    </tds-form-field>
                </div>

                <div class="w-1/4 flex flex-row items-center justify-between mr-2">
                    <span class="font-semibold mr-1">Sắp xếp: </span>
                    <tds-form-field class="flex flex-auto">
                        <tds-select valueField="Value" textField="Name" placeholder='Chọn giá trị sắp xếp'
                            [(ngModel)]="sort" [ngModelOptions]="{ standalone: true }" [data]="sortList"
                            [allowClear]="true" (selectChange)="onChangeSort($event)">
                        </tds-select>
                    </tds-form-field>
                </div> -->
                <tds-button-group class="mr-2">
                    <button tds-button color="secondary" tds-dropdown trigger="click" [tdsDropdownMenu]="menu"
                        [placement]="'bottomRight'">
                        <span class="flex items-center">
                            Thao tác <i class="tdsi-arrow-down-fill text-lg leading-none ml-2"></i>
                        </span>
                    </button>
                    <tds-dropdown-menu #menu="tdsDropdownMenu">
                        <div  class="w-full">
                            <div tds-dropdown-item class="px-3 py-4" (click)="deleteProductOnShopCart()">
                                <a class="text-neutral-1-900 text-body-2 font-regular">Xóa nhiều</a>
                            </div>
                        </div>
                    </tds-dropdown-menu>
                </tds-button-group>

                <button tds-button-icon color="secondary" tds-dropdown trigger="click" [tdsDropdownMenu]="filterMenu"
                    size="md" class="relative mr-2" tds-tooltip tooltipTitle="Lọc dữ liệu" [autoClose]="false" [(visible)]="isVisible" (tdsDropdownOutsideClick)="closeMenu()">
                    <span class="flex items-center">
                        <i class="tdsi-filter-2-line text-lg text-neutral-1-500 leading-none"></i>
                    </span>
                    <span *ngIf="isActive" class="tdsi-success-fill absolute text-[#28A745] text-body-2 top-[-11px] right-[-6px]" style="font-size: 22px"></span>
                </button>

                <tds-dropdown-menu #filterMenu="tdsDropdownMenu">
                    <div class="max-w-[420px] min-w-[300px] p-4">
                        <!-- category -->
                        <div class="w-full mb-4">
                            <p class="mb-2 font-semibold text-[#5A6271] size-[14px]">Loại sản phẩm</p>
                            <div class="w-full">
                            <tds-form-field>
                                <tds-select valueField="Id" textField="Name" [allowClear]="true"
                                    placeholder='Chọn thẻ' [(ngModel)]="cateId" [data]="lstCateg">
                                </tds-select>
                            </tds-form-field>
                            </div>
                        </div>
                        <!-- sort -->
                        <div class="w-full mb-4">
                            <p class="mb-2 font-semibold text-[#5A6271] size-[14px]">Sắp xếp</p>
                            <div class="w-full">
                            <tds-form-field>
                                <tds-select valueField="Value" textField="Name" [allowClear]="true"
                                    placeholder='Sắp xếp' [(ngModel)]="sort" [data]="sortList">
                                </tds-select>
                            </tds-form-field>
                            </div>
                        </div>
                        <div class="w-full flex align-center justify-between">
                            <button tds-button color="primary" size="sm" (click)="onCancel()">
                                <span class="flex items-center">
                                    <i class="tdsi-close-fill text-sm leading-none mr-2"></i> Bỏ lọc
                                </span>
                            </button>
                            <div class="flex items-center">
                            <button tds-button color="secondary" size="sm"  (click)="closeMenu()">Đóng</button>
                            <button tds-button color="primary"  class="ml-2" size="sm" (click)="onApply()">Áp dụng</button>
                            </div>
                        </div>
                    </div>
                  </tds-dropdown-menu>
                <tds-form-field class="w-1/4">
                    <input tdsInput class="text-neutral-1-900" [(ngModel)]="searchText"
                        [tdsInputDebounce]="750" (inputKeyup)="onSearch($event)" placeholder="Tìm kiếm sản phẩm"
                        autocomplete="off" [ngModelOptions]="{standalone: true}" />
                    <span tdsPrefix><i class="text-neutral-1-500 tdsi-search-fill"></i></span>
                    <span *ngIf="searchText" tdsSuffix>
                      <i class="text-neutral-1-500 tdsi-close-fill desktop:text-body-2 laptop:text-caption-1 text-caption-1 mr-2" (click)="closeSearchProduct()" ></i>
                    </span>
                </tds-form-field>
            </div>
        </div>

        <div class="w-full flex-auto pb-2.5 text-body-2" *ngIf="configCart?.IsShopCart">
            <tds-table #rowSelectionTable [listData]="lstOfData" [showSizeChanger]="true" [frontPagination]="false"
                [loading]="isLoading" [scroll]="{y:'auto', x: 'auto'}" [pageSize]="pageSize" [pageIndex]="pageIndex"
                [total]="count" (clickRefresh)="refreshData()" (queryParams)="onQueryParamsChange($event)">
                <thead>
                    <tr class="text-neutral-1-900 text-body-2 font-semibold">
                        <th width="44px" [tdsLeft]="true" [align]="'center'" class="border-r"></th>
                        <th width="44px" class="hover:bg-neutral-3-100 border-r" [checked]="checked" [tdsLeft]="true"
                            [indeterminate]="indeterminate" (checkedChange)="onAllChecked($event)">
                        </th>
                        <th width="80px" class="border-r" [tdsLeft]="true">Ảnh</th>
                        <th width="280px" [tdsLeft]="true" class="border-r">Tên</th>
                        <th width="100px" class="border-r">Đơn vị</th>
                        <!-- <th width="150px" class="border-r" [align]="'right'">Giá bán</th> -->
                        <th width="150px" class="border-r">
                          <div class="flex justify-end gap-x-1">
                            <span>Giá bán</span>
                            <span class=" flex flex-col p-0.5 cursor-pointer" (click)="onChangeFilterPrice()">
                              <i [ngClass]="filterPrice | sortDateClass" class="text-primary-1 tdsi-sort-up-down-fill active text-base leading-4"></i>
                            </span>
                          </div>
                        </th>
                        <th width="150px" class="border-r" [align]="'right'">Số lượng</th>
                        <!-- <th width="168px" class="border-r" [align]="'center'">Ngày tạo</th> -->
                        <th width="168px" class="border-r">
                          <div class="flex gap-x-1">
                            <span>Ngày tạo</span>
                            <span class=" flex flex-col p-0.5 cursor-pointer" (click)="onChangeFilterDate()" tds-tooltip [tooltipTitle]="filterDate | sortDateName">
                              <i [ngClass]="filterDate | sortDateClass" class="text-primary-1 tdsi-sort-up-down-fill active text-base leading-4"></i>
                            </span>
                          </div>
                        </th>
                        <th width="120px" class="border-r" [align]="'center'">Hiệu lực</th>
                        <th width="100px" [tdsRight]="true" [align]="'center'">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    <ng-template ngFor let-data let-i="index" [ngForOf]="rowSelectionTable.data" let-odd='odd'>
                        <tr [ngClass]="{'tds-row-selected':setOfCheckedId.has(data.Id)}">
                            <td [tdsLeft]="true" [expand]="expandSet.has(data.Id)" class="border-r justify-center"
                              (expandChange)="onExpandChange(data.Id, $event)">
                            </td>
                            <td [checked]="setOfCheckedId.has(data.Id)" [tdsLeft]="true" class="border-r"
                                (checkedChange)="onItemChecked(data.Id, $event)"></td>
                            <td [tdsLeft]="true" class="border-r">
                                <tds-avatar class="rounded-lg" [shape]="'square'" [size]="44"
                                    [tdsSrc]="data.ImageUrl"
                                    [isAvatar]="false"></tds-avatar>
                            </td>
                            <td class="border-r" [tdsLeft]="true">{{ data.NameGet }}</td>
                            <td class="border-r">{{ data.UOMName }}</td>
                            <td class="border-r" [align]="'right'">{{ (data.Price | numberCustom) || 0 }} đ</td>

                            <td class="border-r" [align]="'right'">
                                {{ (data?.ShopQuantity | numberCustom) || 0 }}
                                <!-- <div class="flex flex-row items-center justify-end">
                                    <span tds-tooltip tooltipTitle="{{ data.ShopQuantity | numberCustom }}" class="truncate mr-2">{{ data.ShopQuantity }}</span>
                                    <div class="text-info-400 hover:bg-info-100 active:bg-info-100 rounded-md w-[26px] h-[26px]"
                                        tds-popover [popoverVisible]="indClickQuantity == data.Id" popoverTrigger="click"
                                        [popoverFooter]="footerQuantity" [popoverContent]="contentQuantity"
                                        [popoverBackdrop]="true" popoverPlacement="bottom" [popoverAutoClose]="false"
                                        tds-tooltip tooltipTitle="Chỉnh sửa số lượng"
                                        (click)="openQuantityPopover(data)">
                                        <span class="flex items-center justify-center">
                                            <i class="tdsi-edit-1-line text-base"></i>
                                        </span>
                                    </div>
                                    button thêm nhãn
                                    <ng-template #contentQuantity>
                                        <div class="w-[304px]">
                                            <tds-form-field>
                                                <tds-input-number [min]='0' [step]="1" [(ngModel)]="currentQuantity"
                                                    (ngModelChange)="changeQuantity($event)"
                                                    [ngModelOptions]="{standalone: true}">
                                                </tds-input-number>
                                            </tds-form-field>
                                        </div>
                                    </ng-template>

                                    <ng-template #footerQuantity>
                                        <div class="flex justify-end pt-2">
                                            <button tds-button-icon type="button" color="secondary" class="mr-2" size="sm"
                                                (click)="closeQuantityPopover()">
                                                <span class="flex items-center">
                                                    <i class="tdsi-close-fill"></i>
                                                </span>
                                            </button>
                                            <button tds-button-icon type="button"  size="sm" color="primary"
                                                (click)="saveChangeQuantity(data)">
                                                <span class="flex items-center">
                                                    <i class="tdsi-tick-fill"></i>
                                                </span>
                                            </button>
                                        </div>
                                    </ng-template>
                                </div> -->
                            </td>
                            <td class="border-r">{{ data.DateCreated | yiDateTimeFormat }}</td>
                            <td class="border-r" [align]="'center'">
                                <span class="flex items-center justify-center">
                                    <i class="{{ data.Active ? 'tdsi-success-fill text-success-400':'tdsi-error-fill text-error-400' }} text-xl"></i>
                                </span>
                            </td>
                            <td [tdsRight]="true" class="text-center">
                                <button tds-button-icon color="secondary" type="button" size="sm" tds-tooltip="Xóa" (click)="onDelete(data)">
                                    <span class="flex items-center">
                                        <i class="tdsi-trash-fill text-neutral-1-500 text-xl leading-none"></i>
                                    </span>
                                </button>
                            </td>
                        </tr>
                        <tr [expand]="expandSet.has(data.Id)" class="border-b border-neutral-2-100 text-neutral-1-900 bg-light-50 w-full">
                          <product-shopcart-detail class="w-full p-3 block" *ngIf="expandSet.has(data.Id)" (onLoadOption)="reload($event)" [id]="data.Id"></product-shopcart-detail>
                      </tr>
                    </ng-template>
                </tbody>
            </tds-table>
        </div>

        <div *ngIf="!configCart?.IsShopCart" class="p-4">
            <tds-alert type="info" message="Không thể xem chi tiết giỏ hàng"
                description='Vui lòng vào "Cấu hình giỏ hàng" và mở hiệu lực "Xem danh sách sản phẩm trong giỏ hàng"'
                [footer]="footerTemplate" showIcon>
            </tds-alert>

            <ng-template #footerTemplate>
                <div class="w-full">
                    <button tds-button class="mr-2" size="sm" [routerLink]="'/configs/facebook-cart'">
                        Cấu hình giỏ hàng
                    </button>
                </div>
            </ng-template>
        </div>
    </div>
</div>
