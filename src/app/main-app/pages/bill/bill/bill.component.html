<div class="w-full h-full flex flex-col text-body-2">
  <div class="p-4 w-full bg-white">
    <div class="w-full flex justify-between">
      <h1 class="flex cursor-pointer items-center group whitespace-pre-wrap font-semibold">
        <span class="text-neutral-1-900 text-header-1 font-semibold font-sans">Phiếu bán hàng</span>
      </h1>
      <div class="flex gap-x-2">
        <action-dropdown [type]="'all'" [filterObj]="filterObj" [lstOfData]="lstOfData"
          [setOfCheckedId]=[setOfCheckedId]></action-dropdown>
      </div>
    </div>
  </div>
  <div class="p-4 h-full">
    <div class="bg-white w-full h-full rounded-md border border-neutral-200 flex flex-col">
      <div class="flex items-center justify-between w-full" [ngClass]="(setOfCheckedId.size > 0) || isTabNavs ? 'py-[10.5px]' : ''">
        <div *ngIf="setOfCheckedId.size > 0" class="flex flex-row items-center justify-start gap-x-2 ml-2">
          <div class="flex items-center gap-x-4 px-2 pr-4">
              <div class="text-neutral-1-500 text-body-2">{{setOfCheckedId.size}} dòng được chọn</div>
              <div class="flex gap-1 items-center rounded-md bg-neutral-3-50 pl-1.5 pr-2.5 cursor-pointer">
                <i class="tdsi-close-fill text-base text-neutral-1-500"></i>
                <div class="text-body-2 font-semibold text-neutral-1-700" (click)="removeCheckedRow()">Bỏ chọn</div>
              </div>
          </div>

          <action-dropdown [filterObj]="filterObj" [lstOfData]="lstOfData" [setOfCheckedId]=[setOfCheckedId]>
          </action-dropdown>
        </div>
        <div *ngIf="setOfCheckedId.size == 0" class="flex flex-row items-center justify-start">
          <tds-filter-status [(ngModel)]="tabIndex" (selectChange)="onSelectChange($event)" [disabled]="isTabNavs">
            <ng-template ngFor let-item [ngForOf]="tabNavs" let-i="index">
                <tds-filter-status-item [name]='item.Name | getStatusName:filterStatus' [count]='item.Total' [value]="item.Index">
                </tds-filter-status-item>
            </ng-template>
          </tds-filter-status>
        </div>
        <!-- TODO: Thao tác -->
        <div class="flex flex-row items-center justify-end gap-x-2 pr-4">
          <action-dropdown *ngIf="setOfCheckedId.size == 0" [filterObj]="filterObj" [lstOfData]="lstOfData" [setOfCheckedId]=[setOfCheckedId]>
          </action-dropdown>

          <div class="xl:hidden 2xl:flex gap-x-2">
            <tds-form-field>
              <tds-select
                valueField="Id" textField="Name" class="xl:w-[100px] 2xl:w-[190px]"
                placeholder="Chọn đối tác GH" [valuePrimitive]="false" (selectChange)="onChangeDeliveryId($event)" [(ngModel)]="carrierId"
                disabledField="isActive" [data]="lstCarriers" [allowClear]="true">
              </tds-select>
            </tds-form-field>
          </div>

          <tds-form-field class="flex flex-auto xl:w-[150px] 2xl:w-[190px]">
              <input tdsInput placeholder="Tên, Địa chỉ, SĐT,..." autocomplete="off" #innerText />
              <span tdsPrefix><i class="text-neutral-1-500 tdsi-search-fill"></i></span>
          </tds-form-field>

          <filter-options [lstTags]="lstTags" [summaryStatus]="summaryStatus" (onLoadOption)="onLoadOption($event)"
              [filterObj]="filterObj" [lstCarriers]="lstCarriers"></filter-options>
          <config-column [columns]="hiddenColumns" (columnsChange)="columnsChange($event)"></config-column>
        </div>
      </div>
      <div #widthTable class="flex-auto w-full pb-4" >
        <tds-table #rowSelectionTable [showSizeChanger]="true" [frontPagination]="false" [listData]="lstOfData"
          [(pageSize)]="pageSize" [(pageIndex)]="pageIndex" [total]="count" [scroll]="{y:'auto', x: 'auto'}"
          [loading]="isLoading" (clickRefresh)="refreshData()" (queryParams)="onQueryParamsChange($event)">
          <thead>
            <tr>
              <th width="44px" [tdsLeft]="true" [align]="'center'" class="border-r"></th>
              <th width="42px" [tdsLeft]="true" [(checked)]="checked" [indeterminate]="indeterminate"
                (checkedChange)="onAllChecked($event)" class="border-r"></th>
              <th width="240px" [tdsLeft]="true" *ngIf="isHidden('PartnerDisplayName')" class="border-r">Khách hàng</th>
              <th width="180px" *ngIf="isHidden('LiveCampaignName')" class="border-r">Chiến dịch live</th>
              <th width="180px" *ngIf="isHidden('DateInvoice')" [align]="'center'" class="border-r">Ngày bán</th>
              <th width="160px" *ngIf="isHidden('Number')" class="border-r">Số HĐ</th>
              <th width="160px" *ngIf="isHidden('CarrierName')" class="border-r">Đối tác GH</th>
              <th width="170px" *ngIf="isHidden('TrackingRef')" class="border-r">Mã vận đơn</th>
              <th width="120px" *ngIf="isHidden('AmountTotal')" [align]="'right'" class="border-r">Tổng tiền</th>
              <th width="180px" *ngIf="isHidden('CashOnDelivery')" [align]="'right'" class="border-r">Tiền thu hộ</th>
              <th width="120px" *ngIf="isHidden('Residual')" [align]="'right'" class="border-r">Còn nợ</th>
              <th width="140px" *ngIf="isHidden('CustomerDeliveryPrice')" [align]="'right'" class="border-r">Phí ship đối tác</th>
              <th width="140px" *ngIf="isHidden('DeliveryPrice')" [align]="'right'" class="border-r">Phí giao hàng</th>
              <th width="120px" *ngIf="isHidden('ShowState')" class="border-r">Trạng thái</th>
              <th width="150px" *ngIf="isHidden('ShipPaymentStatus')" class="border-r">Trạng thái GH</th>
              <th width="120px" *ngIf="isHidden('PrintShipCount')" class="border-r" [align]="'center'">Số lần in ship</th>
              <th width="120px" *ngIf="isHidden('PrintDeliveryCount')" class="border-r" [align]="'center'">Số lần in HĐ</th>
              <th width="140px" *ngIf="isHidden('ShowShipStatus')" class="border-r">Đối soát GH</th>
              <th width="140px" *ngIf="isHidden('DateCreated')" [align]="'center'" class="border-r">
                <div class="flex gap-x-1 items-center justify-center">
                  <span>Ngày tạo đơn</span>
                  <span class=" flex flex-col p-0.5 cursor-pointer" (click)="onChangeFilterDate()" tds-tooltip [tooltipTitle]="filterDate | sortDateName">
                    <i [ngClass]="filterDate | sortDateClass" class="text-primary-1 tdsi-sort-up-down-fill active text-base leading-4"></i>
                  </span>
                </div>
              </th>
              <th width="180px" *ngIf="isHidden('CreateByName')" class="border-r">Người lập</th>
              <th width="160px" *ngIf="isHidden('CRMTeamName')" class="border-r">Thông tin</th>
              <th width="180px" *ngIf="isHidden('IsRefund')" [align]="'center'" class="border-r">Đơn hàng trả</th>
              <th width="180px" *ngIf="isHidden('UserName')" class="border-r">Nhân viên</th>
              <th width="140px" [tdsRight]="true" [align]="'center'">Thao tác</th>
            </tr>
          </thead>
          <tbody>
            <ng-template ngFor let-data [ngForOf]="rowSelectionTable.data" let-odd='odd'>
              <tr class="text-body-2 text-neutral-900 font-regular" [ngClass]="{'tds-row-selected':setOfCheckedId.has(data.Id)}">
                <td [tdsLeft]="true" [expand]="expandSet.has(data.Id)" class="border-r text-center"
                  (expandChange)="onExpandChange(data.Id, $event)">
                </td>
                <td [tdsLeft]="true" [checked]="setOfCheckedId.has(data.Id)"
                  (checkedChange)="onItemChecked(data.Id, $event)" class="border-r">
                </td>
                <td [tdsLeft]="true" *ngIf="isHidden('PartnerDisplayName')" class="relative border-r">
                  <div class="w-full">
                    <p class="w-full">{{data.PartnerDisplayName}}</p>
                    <p class="text-[#929DAA]">{{data.Phone}}</p>
                    <div class="absolute bottom-0 right-[4px] text-primary-1">
                      <span *ngIf="data.PrintDeliveryCount > 0" class="tdsi-print-fill text-[15px]"
                        tds-tooltip tooltipTitle="Đã in phiếu giao hàng"></span>
                      <span *ngIf="data.PrintShipCount > 0" class="tdsi-order-fill text-[16px]"
                        tds-tooltip tooltipTitle="Đã in phiếu ship"></span>
                    </div>
                  </div>
                </td>

                <td *ngIf="isHidden('LiveCampaignName')" class="border-r">
                  <div class="w-full">
                    <span>{{data.LiveCampaignName}}</span>
                  </div>
                </td>

                <td *ngIf="isHidden('DateInvoice')" [align]="'center'" class="border-r">
                  <div class="w-full">
                    <span>{{data.DateInvoice | yiDateTimeFormat}}</span>
                  </div>
                </td>
                <td *ngIf="isHidden('Number')" class="border-r">
                  <div class="w-full flex font-semibold text-center pb-2 cursor-pointer" (click)="onView(data)">
                    <span [ngClass]="data.Number ? 'text-info-400' : 'text-error-500'">{{data.Number || 'N/A'}}</span>
                  </div>
                  <!-- Nhãn -->
                  <div class="flex items-center gap-x-1 w-full">
                    <div class="flex flex-wrap items-center w-fit">
                      <div *ngFor="let item of data.Tags | prettyjson">
                        <tds-tag [tds-tooltip]="item.Name" class="mr-1 mb-1 cursor-pointer" status='primary'>{{ (item.Name || '') | truncateString }}</tds-tag>
                      </div>
                      <button (click)="openTag(data.Id, data.Tags)" tds-button-icon tds-popover tds-tooltip="Thêm nhãn"
                        [popoverVisible]="indClickTag == data.Id" popoverTrigger="click" [popoverFooter]="footerAddTag"
                        [popoverAutoClose]="false" [popoverContent]="contentAddtag" [popoverBackdrop]="true"
                        popoverPlacement="left" color="custom" size="sm" class="bg-transparent border-0 focus:ring-transparent">
                        <div class="w-5 h-5 relative">
                          <i class="tdsi-tag-fill text-neutral-1-500 text-base leading-4 select-all absolute top-0 left-0"></i>
                          <svg class="border border-white bg-white rounded-full absolute bottom-0 right-0" width="12"
                            height="12" viewBox="0 0 11 11" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                              d="M6.00263 0.185353C5.78089 0.14704 5.55607 0.129611 5.3311 0.133295C3.96134 0.134421 2.64803 0.680863 1.67966 1.65259C0.711296 2.62431 0.167057 3.94186 0.166496 5.3158C0.162824 5.54146 0.180199 5.76697 0.218396 5.98938C0.342953 6.94846 0.732804 7.85338 1.34378 8.60162C1.95476 9.34986 2.76244 9.91151 3.67532 10.2229C4.5882 10.5344 5.56979 10.5831 6.50889 10.3637C7.44798 10.1443 8.30703 9.66541 8.98873 8.98138C9.67042 8.29736 10.1475 7.4355 10.3659 6.49346C10.5843 5.55142 10.5354 4.56685 10.2246 3.65129C9.91374 2.73574 9.3535 1.92579 8.60732 1.31322C7.86114 0.70065 6.95883 0.309939 6.00263 0.185353ZM8.09029 5.79283H5.80879V8.08342H4.85553V5.79283H2.57403V4.83665H4.85764V2.53756H5.81091V4.83878H8.09452L8.09029 5.79283Z"
                              fill="#28A745" />
                          </svg>
                        </div>
                      </button>
                    </div>

                    <!-- button thêm nhãn -->
                    <ng-template #contentAddtag>
                      <div class="w-[304px]">
                        <tds-form-field>
                          <tds-select valueField="Id" textField="Name" placeholder='Chọn các tag'
                            [(ngModel)]="modelTags" [allowClear]="true" [valuePrimitive]="false" [data]="lstTags"
                            [autoClose]="true" mode="multiple">
                          </tds-select>
                        </tds-form-field>
                      </div>
                    </ng-template>
                    <ng-template #footerAddTag>
                      <div class="flex justify-end pt-2">
                        <button tds-button-icon color="secondary" class="mr-2" size="sm" (click)="closeTag()">
                          <span class="flex items-center">
                            <i class="tdsi-close-fill"></i>
                          </span>
                        </button>
                        <button tds-button-icon size="sm" color="primary" (click)="assignTags(data.Id, modelTags)">
                          <span class="flex items-center">
                            <i class="tdsi-tick-fill"></i>
                          </span>
                        </button>
                      </div>
                    </ng-template>
                  </div>
                </td>
                <td *ngIf="isHidden('CarrierName')" class="border-r">
                  <div class="w-full">
                    <span>{{data.CarrierName}}</span>
                  </div>
                </td>
                <td *ngIf="isHidden('TrackingRef')" class="border-r">
                  <div class="w-full" (click)="onOpenTrackingUrl(data)">
                    <div class="text-info-400 cursor-pointer font-semibold">{{data.TrackingRef}}</div>
                  </div>
                </td>
                <td *ngIf="isHidden('AmountTotal')" [align]="'right'" class="border-r">
                  <div class="w-full">
                    <span>{{data.AmountTotal || 0 | numberCustom }} đ</span>
                  </div>
                </td>
                <td *ngIf="isHidden('CashOnDelivery')" [align]="'right'" class="border-r">
                  <div class="w-full">
                    <span>{{data.CashOnDelivery || 0 | numberCustom }} đ</span>
                  </div>
                </td>
                <td *ngIf="isHidden('Residual')" [align]="'right'" class="border-r">
                  <div class="w-full">
                    <span>{{data.Residual || 0 | numberCustom }} đ</span>
                  </div>
                </td>
                <td *ngIf="isHidden('CustomerDeliveryPrice')" [align]="'right'" class="border-r">
                  <div class="w-full">
                    <span>{{data.CustomerDeliveryPrice || 0 | numberCustom }} đ</span>
                  </div>
                </td>
                <td *ngIf="isHidden('DeliveryPrice')" [align]="'right'" class="border-r">
                  <div class="w-full">
                    <span>{{data.DeliveryPrice || 0 | numberCustom }} đ</span>
                  </div>
                </td>
                <td *ngIf="isHidden('ShowState')" class="border-r !px-0 !pl-3">
                  <div class="w-full">
                    <tds-tag *ngIf="data.State ==='draft'" status='secondary' type="outline">{{data.ShowState}}
                    </tds-tag>
                    <tds-tag *ngIf="data.State ==='paid'" status='primary' type="outline">{{data.ShowState}}</tds-tag>
                    <tds-tag *ngIf="data.State ==='open'" status='info' type="outline">{{data.ShowState}}</tds-tag>
                    <tds-tag *ngIf="data.State ==='cancel'" status='error' type="outline">{{data.ShowState}}</tds-tag>
                    <p *ngIf="data.PaymentMessageCount" class="text-neutral-1-400 text-xs pt-2">Đã gửi yêu cầu thanh
                      toán</p>
                  </div>
                </td>
                <td *ngIf="isHidden('ShipPaymentStatus')" class="border-r">
                  <div class="w-full">
                    <span class="text-info-400 font-semibold">{{data.ShipPaymentStatus}}</span>
                  </div>
                </td>
                <td *ngIf="isHidden('PrintShipCount')" class="border-r text-center">
                  <div class="w-full">
                    <span>{{data.PrintShipCount || 0 | numberCustom }}</span>
                  </div>
                </td>
                <td *ngIf="isHidden('PrintDeliveryCount')" class="border-r text-center">
                  <div class="w-full">
                    <span>{{data.PrintDeliveryCount || 0 | numberCustom }}</span>
                  </div>
                </td>
                <td *ngIf="isHidden('ShowShipStatus')" class="border-r">
                  <div class="w-full">
                    <span tds-popover [popoverVisible]="indClickStatus == data.Id" popoverTrigger="click"
                      [popoverFooter]="footerShipStatus" [popoverContent]="contentShipStatus" [popoverBackdrop]="true"
                      popoverPlacement="bottom" [popoverAutoClose]="false"
                      class="text-info-400 cursor-pointer border-b border-info-400 border-dashed"
                      (click)="openShipStatus(data,data.Id)">
                      {{data.ShowShipStatus}}
                    </span>
                    <!-- button thêm nhãn -->
                    <ng-template #contentShipStatus>
                      <div class="w-[304px]">
                        <tds-form-field>
                          <tds-select valueField="value" textField="text" placeholder='Chọn đối soát GH'
                            [(ngModel)]="currentStatus" [allowClear]="true" [valuePrimitive]="false"
                            [data]="lstShipStatus" (ngModelChange)="changeShipStatus($event)">
                          </tds-select>
                        </tds-form-field>
                      </div>
                    </ng-template>
                    <ng-template #footerShipStatus>
                      <div class="flex justify-end pt-2">
                        <button tds-button-icon color="secondary" class="mr-2" size="sm" (click)="closeShipStatus()">
                          <span class="flex items-center">
                            <i class="tdsi-close-fill"></i>
                          </span>
                        </button>
                        <button tds-button-icon size="sm" color="primary" (click)="assignShipStatus(data.Id)">
                          <span class="flex items-center">
                            <i class="tdsi-tick-fill"></i>
                          </span>
                        </button>
                      </div>
                    </ng-template>
                  </div>
                </td>
                <td *ngIf="isHidden('DateCreated')" class="border-r">
                  <div class="w-full">
                    <span>{{data.DateCreated | yiDateTimeFormat}}</span>
                  </div>
                </td>
                <td *ngIf="isHidden('CreateByName')" class="border-r">
                  <div class="w-full">
                    <span>{{data.CreateByName}}</span>
                  </div>
                </td>
                <td *ngIf="isHidden('CRMTeamName')" class="border-r">
                  <div class="w-full flex">
                    <span *ngIf="data.CRMTeamName" [ngClass]="data.CRMTeamId | getTeamIcon:lstOfTeam"></span>
                    <span class="ml-1">{{data.CRMTeamName}}</span>
                  </div>
                </td>
                <td *ngIf="isHidden('IsRefund')" [align]="'center'" class="border-r">
                  <div class="w-full">
                    <span
                      [ngClass]="data.IsRefund ? 'tdsi-success-fill text-success-400' : 'tdsi-error-fill text-error-400'"
                      class="text-xl leading-5"></span>
                  </div>
                </td>
                <td *ngIf="isHidden('UserName')" class="border-r">
                  <div class="w-full">
                    <span>{{data.UserName}}</span>
                  </div>
                </td>
                <td [tdsRight]="true" [align]="'center'" class="border-r !px-2">
                  <div class="flex items-center justify-center gap-x-2">
                    <button tds-button-icon color="secondary" size="sm" tds-tooltip="Gửi tin nhắn" (click)="openMiniChat(data)">
                      <span class="flex items-center">
                        <i class="tdsi-messenger-fill text-neutral-1-500"></i>
                      </span>
                    </button>
                    <button tds-button-icon type="button" color="secondary" size="sm" tds-tooltip="Chỉnh sửa" (click)="onView(data)">
                      <span class="flex items-center">
                        <i class="tdsi-edit-fill text-neutral-1-500"></i>
                      </span>
                    </button>
                    <button tds-button-icon color="secondary" size="sm" tds-tooltip="Xóa" (click)="onDelete(data)">
                      <span class="flex items-center">
                        <i class="tdsi-trash-fill text-neutral-1-500"></i>
                      </span>
                    </button>
                  </div>
                </td>
              </tr>
              <tr [expand]="expandSet.has(data.Id)" class="border-b border-neutral-2-100 text-neutral-1-900 bg-light-50 w-full">
                  <app-bill-expand class="w-full p-3 block" *ngIf="expandSet.has(data.Id)" [dataItem]="data"></app-bill-expand>
              </tr>
            </ng-template>
          </tbody>
        </tds-table>
      </div>
    </div>
  </div>
  <tds-drawer [visible]="isOpenDrawer"
    [bodyStyle]="{'background-color':'rgb(235 237 239)','overflow':'hidden','display': 'flex','flex-direction': 'column','padding': '0'}"
    [placement]="'right'" [title]="titleMessage" (onClose)="closeDrawer()" [width]="'50vw'">
    <ng-template #titleMessage>
      <span class="flex w-full items-center text-title-1 font-semibold text-neutral-900">
        Gửi tin nhắn Facebook
      </span>
    </ng-template>
    <ng-container *tdsDrawerContent>
      <div class="w-full h-full flex flex-col overflow-hidden text-body-2">
        <div *ngIf="orderMessage" class="flex flex-col gap-y-4 p-4 bg-white">
          <div class="flex justify-between items-center">
            <div *ngIf="mappingTeams.length > 0" class="flex gap-3 items-center">
              <tpage-avatar-facebook
                [fbid]="currentMappingTeam?.team?.ChannelId || currentMappingTeam?.team?.Facebook_ASUserId"
                [token]="currentMappingTeam?.team?.Facebook_PageToken || currentMappingTeam?.team?.Facebook_UserToken || currentMappingTeam?.team?.ChannelToken">
              </tpage-avatar-facebook>
              <button type="button">
                <span class="flex items-center">
                  {{ currentMappingTeam?.team?.Name || 'Hãy chọn kênh' }}
                </span>
              </button>
              <!-- <tds-button-group>
                <button tds-dropdown trigger="click" type="button" [tdsDropdownMenu]="menu1">
                  <span class="flex items-center">
                    {{currentMappingTeam?.team?.Name || 'Hãy chọn kênh'}}
                    <i class="tdsi-arrow-down-fill text-lg leading-none ml-2"></i>
                  </span>
                </button>
                <tds-dropdown-menu #menu1="tdsDropdownMenu">
                  <div class="w-full">
                    <div tds-dropdown-item *ngFor="let item of mappingTeams" (click)="selectMappingTeam(item)">
                      <a> {{ item.team?.Name }} </a>
                    </div>
                  </div>
                </tds-dropdown-menu>
              </tds-button-group> -->
            </div>
            <div class="flex gap-x-2">
              <button tds-button color="info" (click)="showMessageModal(orderMessage)">
                <span class="flex items-center">
                  <i class="tdsi-message-fill text-lg leading-none mr-2"></i>Gửi tin nhắn nhanh
                </span>
              </button>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-x-9 gap-y-3">
            <div class="flex gap-x-1">
              <span class="w-1/3">Số HĐ</span>
              <span class="w-2/3 font-semibold">{{orderMessage.Number?orderMessage.Number:'...' || 'N/A'}}</span>
            </div>
            <div class="flex gap-x-1">
              <span class="w-1/3">Tổng tiền</span>
              <span class="w-2/3 font-semibold">{{orderMessage.AmountTotal?orderMessage.AmountTotal:0 | numberCustom }}</span>
            </div>
            <div class="flex gap-x-1">
              <span class="w-1/3">Ngày bán</span>
              <span class="w-2/3 font-semibold">{{orderMessage.DateInvoice | date:'dd/MM/yyyy'}}</span>
            </div>
            <div class="flex gap-x-1">
              <span class="w-1/3">Kênh bán hàng</span>
              <span class="w-2/3 font-semibold">{{orderMessage.CRMTeamName?orderMessage.CRMTeamName:'...' ||
                'N/A'}}</span>
            </div>
            <div class="flex gap-x-1">
              <span class="w-1/3">Đối tác GH</span>
              <span class="w-2/3 font-semibold">{{orderMessage.CarrierName?orderMessage.CarrierName:'...' }}</span>
            </div>
            <div class="flex gap-x-1">
              <span class="w-1/3">Trạng thái</span>
              <span class="w-2/3 font-semibold">{{orderMessage.ShowState?orderMessage.ShowState:'...'}}</span>
            </div>
          </div>
        </div>
        <div class="w-full h-full flex overflow-hidden bg-neutral-3-200" cdkScrollable>
          <div *ngIf="currentConversation && currentMappingTeam?.team" class="w-full">
            <shared-tds-conversations class="flex w-full h-full" [team]="currentMappingTeam?.team"
              [data]="currentConversation" [type]="'all'">
            </shared-tds-conversations>
          </div>
        </div>
      </div>
    </ng-container>
  </tds-drawer>
</div>
