<div class="w-full h-full flex flex-col text-body-2">
  <div class="p-4 w-full bg-white">
    <div class="w-full flex justify-between">
      <h1 class="flex cursor-pointer items-center group whitespace-pre-wrap font-semibold">
        <span class="text-neutral-1-900 text-header-1 font-semibold font-sans">Phiếu bán hàng</span>
      </h1>
      <div class="flex gap-x-2">
        <button tds-button color="primary" size="md" (click)="onCreate()">
          <span class="flex items-center">
            <i class="tdsi-plus-circle-fill text-lg leading-none mr-2"></i>Thêm mới
          </span>
        </button>
      </div>
    </div>
  </div>
  <div class="p-4 h-full">
    <div class="bg-white w-full h-full rounded-md border border-neutral-200 flex flex-col">
      <div class="flex  justify-between">
        <tds-filter-status [ngModel]='tabIndex' (selectChange)="onSelectChange($event)">
          <ng-template ngFor let-item [ngForOf]="tabNavs" let-i="index">
            <tds-filter-status-item [name]='item.Name' [count]='item.Total' [value]="item.Index">
            </tds-filter-status-item>
          </ng-template>
        </tds-filter-status>

        <!-- TODO: Thao tác -->
        <div class="flex items-center gap-x-2 pr-4">
          <action-dropdown [filterObj]="filterObj" [lstOfData]="lstOfData" [setOfCheckedId]=[setOfCheckedId]></action-dropdown>
          <tds-form-field class="w-full">
            <input tdsInput placeholder="Tìm kiếm" autocomplete="off" #innerText/>
            <span tdsPrefix><i class="text-neutral-1-500 tdsi-search-fill"></i></span>
          </tds-form-field>
          <filter-options (onLoadOption)="onLoadOption($event)"></filter-options>
          <config-column [columns]="hiddenColumns" (columnsChange)="columnsChange($event)"></config-column>
        </div>
      </div>
      <div #WidthTable class="flex-auto w-full py-4" *ngIf="lstOfData">
        <tds-table #rowSelectionTable
          [showSizeChanger]="true"
          [frontPagination]="false"
          [listData]="lstOfData"
          [(pageSize)]="pageSize"
          [(pageIndex)]="pageIndex"
          [total]="count" [scroll]="{y:'auto', x: 'auto'}" [loading]="isLoading"
          (clickRefresh)="refreshData()" (queryParams)="onQueryParamsChange($event)">
          <thead>
            <tr>
              <th class="text-center" width="50px"></th>
              <th [(checked)]="checked" [indeterminate]="indeterminate" width="50px" class="text-center"
                (checkedChange)="onAllChecked($event)"></th>
              <th class="text-center" width="140px">Thao tác</th>
              <th *ngIf="isHidden('Number')" width="280px">Số HĐ</th>
              <th *ngIf="isHidden('PartnerDisplayName')" width="280px">Khách hàng</th>
              <th *ngIf="isHidden('CRMTeamName')" width="280px">Kênh kết nối</th>
              <th *ngIf="isHidden('DateInvoice')" class="text-center" width="240px">Ngày hóa đơn</th>
              <th *ngIf="isHidden('DateCreated')" class="text-center" width="240px">Ngày tạo</th>
              <th *ngIf="isHidden('AmountTotal')" class="text-right" width="240px">Tổng tiền</th>
              <th *ngIf="isHidden('Residual')" class="text-right" width="240px">Còn nợ</th>
              <th *ngIf="isHidden('ShowState')" width="240px">Trạng thái</th>
              <th *ngIf="isHidden('CarrierName')" width="240px">Đối tác GH</th>
              <th *ngIf="isHidden('TrackingRef')" width="240px">Mã vận đơn</th>
              <th *ngIf="isHidden('UserName')" width="240px">Nhân viên</th>
              <th *ngIf="isHidden('CreateByName')" width="240px">Người lập</th>
              <th *ngIf="isHidden('ShipPaymentStatus')" width="240px">Trạng thái GH</th>
              <th *ngIf="isHidden('CashOnDelivery')" class="text-right" width="240px">Tiền thu hộ</th>
              <th *ngIf="isHidden('CustomerDeliveryPrice')" lass="text-right" width="240px">Phí ship GH</th>
              <th *ngIf="isHidden('IsRefund')" class="text-center" width="160px">Đơn hàng trả</th>
            </tr>
          </thead>
          <tbody>
            <ng-template ngFor let-data [ngForOf]="rowSelectionTable.data" let-odd='odd'>
              <tr class="text-body-2 text-neutral-900 font-regular"
                [ngClass]="setOfCheckedId.has(data.Id)?'bg-[#F2FCF5]':''">

                <td [expand]="expandSet.has(data.Id)" class="text-center"
                  (expandChange)="onExpandChange(data.Id, $event)">
                </td>
                <td [checked]="setOfCheckedId.has(data.Id)" (checkedChange)="onItemChecked(data.Id, $event)"
                  class="text-center">
                </td>
                <td>
                  <div class="flex gap-x-2">
                    <button tds-button-icon color="secondary" size="sm">
                      <span class="flex items-center">
                        <i class="tdsi-messenger-fill"></i>
                      </span>
                    </button>
                    <button tds-button-icon type="button" color="secondary" size="sm" (click)="onView(data)">
                      <span class="flex items-center">
                        <i class="tdsi-edit-fill"></i>
                      </span>
                    </button>
                    <button tds-button-icon color="secondary" size="sm" (click)="onDelete(data)">
                      <span class="flex items-center">
                        <i class="tdsi-trash-fill"></i>
                      </span>
                    </button>
                  </div>
                </td>
                <td *ngIf="isHidden('Number')">
                  <div class="w-full flex ">
                    <span [ngClass]="data.Number ? '' : 'text-error-500'">{{data.Number || 'N/A'}}</span>
                  </div>
                  <!-- Nhãn -->
                  <div class="flex w-full gap-x-2 items-center">
                    <div class="flex w-full flex-wrap gap-2">
                      <tds-tag class="truncate" *ngFor="let item of data.Tags | prettyjson" status='primary'>
                        {{item.Name}}</tds-tag>
                    </div>
                    <button (click)="openTag(data.Id, data.Tags)" tds-button-icon tds-popover
                      [popoverVisible]="indClickTag == data.Id" popoverTrigger="click" [popoverFooter]="footerAddTag"
                      [popoverContent]="contentAddtag" [popoverBackdrop]="true" popoverPlacement="left" color="secondary" size="sm"
                      class=" border-0">
                      <div class="w-5 h-5 relative">
                        <i class="tdsi-tag-fill text-base leading-4 select-all absolute top-0 left-0"></i>
                        <svg class="border border-white bg-white rounded-full absolute bottom-0 right-0" width="12" height="12" viewBox="0 0 11 11" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6.00263 0.185353C5.78089 0.14704 5.55607 0.129611 5.3311 0.133295C3.96134 0.134421 2.64803 0.680863 1.67966 1.65259C0.711296 2.62431 0.167057 3.94186 0.166496 5.3158C0.162824 5.54146 0.180199 5.76697 0.218396 5.98938C0.342953 6.94846 0.732804 7.85338 1.34378 8.60162C1.95476 9.34986 2.76244 9.91151 3.67532 10.2229C4.5882 10.5344 5.56979 10.5831 6.50889 10.3637C7.44798 10.1443 8.30703 9.66541 8.98873 8.98138C9.67042 8.29736 10.1475 7.4355 10.3659 6.49346C10.5843 5.55142 10.5354 4.56685 10.2246 3.65129C9.91374 2.73574 9.3535 1.92579 8.60732 1.31322C7.86114 0.70065 6.95883 0.309939 6.00263 0.185353ZM8.09029 5.79283H5.80879V8.08342H4.85553V5.79283H2.57403V4.83665H4.85764V2.53756H5.81091V4.83878H8.09452L8.09029 5.79283Z" fill="#28A745"/>
                        </svg>
                      </div>
                    </button>
                    <!-- button thêm nhãn -->
                    <ng-template #contentAddtag>
                      <div class="w-96">
                        <tds-form-field>
                          <tds-select valueField="Id" textField="Name" placeholder='select item' [(ngModel)]="modelTags"
                            [allowClear]="true" [valuePrimitive]="false" [data]="lstDataTag" mode="multiple">
                          </tds-select>
                        </tds-form-field>
                      </div>
                    </ng-template>
                    <ng-template #footerAddTag>
                      <div class="flex justify-end pt-2">
                        <button tds-button-icon color="secondary" class="mr-2" size="sm" (click)="closeTag()">
                          <span class="flex items-center">
                            <i class="tdsi-close-fill"></i>
                          </span>
                        </button>
                        <button tds-button-icon size="sm" (click)="assignTags(data.Id, modelTags)">
                          <span class="flex items-center">
                            <i class="tdsi-tick-fill"></i>
                          </span>
                        </button>
                      </div>
                    </ng-template>
                  </div>
                </td>
                <td *ngIf="isHidden('PartnerDisplayName')" class="relative">
                  <div class="w-full">
                    <p>{{data.PartnerDisplayName}}</p>
                    <p class="text-[#929DAA]">{{data.Phone}}</p>
                    <div class="absolute bottom-0 right-[4px] text-primary-1">
                      <span *ngIf="data.PrintDeliveryCount > 0" class="tdsi-print-fill text-[15px]"
                        title="Đã in phiếu giao hàng"></span>
                      <span *ngIf="data.PrintShipCount > 0" class="tdsi-shipper-line text-[16px]"
                        title="Đã in phiếu ship"></span>
                    </div>
                  </div>
                </td>
                <td *ngIf="isHidden('CRMTeamName')">
                  <div class="w-full flex">
                    <span class="text-[#0184FF] tdsi-facebook-1-fill text-[20px]"></span>
                    <span class="ml-1">{{data.CRMTeamName}}</span>
                  </div>
                </td>
                <td *ngIf="isHidden('DateInvoice')" class="text-center">
                  <div class="w-full">
                    <span>{{data.DateInvoice | date:"dd-MM-yyyy HH:mm"}}</span>
                  </div>
                </td>
                <td *ngIf="isHidden('DateCreated')" class="text-center">
                  <div class="w-full">
                    <span>{{data.DateCreated | date:"dd-MM-yyyy HH:mm"}}</span>
                  </div>
                </td>
                <td *ngIf="isHidden('AmountTotal')" class="text-right">
                  <div class="w-full">
                    <span>{{data.AmountTotal || 0 | number :'1.0-3'}} đ</span>
                  </div>
                </td>
                <td *ngIf="isHidden('Residual')" class="text-right">
                  <div class="w-full">
                    <span>{{data.Residual || 0 | number :'1.0-3'}} đ</span>
                  </div>
                </td>
                <td *ngIf="isHidden('ShowState')">
                  <div class="w-full">
                    <p>{{data.ShowState}}</p>
                    <p *ngIf="data.PaymentMessageCount" class="text-[#929DAA]  text-[12px]">
                      Đã gửi y/c thanh toán</p>
                  </div>
                </td>
                <td *ngIf="isHidden('CarrierName')">
                  <div class="w-full">
                    <span>{{data.CarrierName}}</span>
                  </div>
                </td>
                <td *ngIf="isHidden('TrackingRef')">
                  <div class="w-full">
                    <span>{{data.TrackingRef}}</span>
                  </div>
                </td>
                <td *ngIf="isHidden('UserName')">
                  <div class="w-full">
                    <span>{{data.UserName}}</span>
                  </div>
                </td>
                <td *ngIf="isHidden('CreateByName')">
                  <div class="w-full">
                    <span>{{data.CreateByName}}</span>
                  </div>
                </td>
                <td *ngIf="isHidden('ShipPaymentStatus')">
                  <div class="w-full">
                    <span>{{data.ShipPaymentStatus}}</span>
                  </div>
                </td>
                <td *ngIf="isHidden('CashOnDelivery')" class="text-right">
                  <div class="w-full">
                    <span>{{data.CashOnDelivery || 0 | number: '1.0-3'}} đ</span>
                  </div>
                </td>
                <td *ngIf="isHidden('CustomerDeliveryPrice')" class="text-right">
                  <div class="w-full">
                    <span>{{data.CustomerDeliveryPrice ||0 | number: '1.0-3'}} đ</span>
                  </div>
                </td>
                <td *ngIf="isHidden('IsRefund')" class="text-center">
                  <div class="w-full">
                    <span
                      [ngClass]="data.IsRefund ? 'tdsi-success-fill text-success-400' : 'tdsi-error-fill text-error-400'"
                      class="text-xl leading-5"></span>
                  </div>
                </td>
              </tr>
              <tr [expand]="expandSet.has(data.Id)"  class="border-b border-neutral-2-100 text-neutral-1-900 bg-gray-200 w-full">
                <div #BillOrderLines [ngStyle]="{'max-width.px': widthCollapse, 'margin-left.px': marginLeftCollapse}">
                  <app-bill-expand [billData]="data" *ngIf="expandSet.has(data.Id)"></app-bill-expand>
                </div>
              </tr>
            </ng-template>
          </tbody>
        </tds-table>
      </div>
    </div>
  </div>
</div>
