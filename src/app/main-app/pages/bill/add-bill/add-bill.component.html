<tds-spin [spinning]="isLoading" class="w-full h-full" [tip]="tipLoading">
  <form [formGroup]="_form" class="flex flex-col w-full h-full" *ngIf="dataModel">
    <div class="bg-white flex justify-between items-center mb-4">
      <div class="flex flex-col gap-y-1">
          <tds-breadcrumb tds-page-header-breadcrumb>
              <tds-breadcrumb-item (click)="directPage('bill')">Phiếu bán hàng</tds-breadcrumb-item>
              <tds-breadcrumb-item>{{ breadcrumb }}</tds-breadcrumb-item>
          </tds-breadcrumb>
          <div class="pl-4 pb-2.5">
              <span class="text-header-1 text-neutral-1-900 font-semibold" *ngIf="path == 'create'">Thêm mới phiếu bán hàng</span>
              <span class="text-header-1 text-neutral-1-900 font-semibold" *ngIf="path == 'edit'">Chỉnh sửa phiếu bán hàng</span>
              <span class="text-header-1 text-neutral-1-900 font-semibold" *ngIf="path == 'copy'">Sao chép phiếu bán hàng</span>
          </div>
      </div>

      <div class="flex gap-x-2">
          <!-- <button tds-button color="info" *ngIf="dataModel.State == 'draft'" type="button"
            (click)="applyPromotion('coupon')">Áp dụng coupon</button>

          <button tds-button color="info" *ngIf="dataModel.State == 'draft'" type="button"
            (click)="applyPromotion('promotion')">Áp dụng khuyến mãi</button> -->

          <button tds-button color="info" *ngIf="dataModel.State == 'draft'" type="button"
            (click)="onSave('SaveAndPrint', 'print')">Xác nhận và in (F9)</button>

          <button tds-button color="info" *ngIf="dataModel.State == 'draft'" type="button"
            (click)="onSave('SaveAndPrint', 'printShip')">Xác nhận và in ship</button>

          <button tds-button color="info" *ngIf="dataModel.State == 'draft'" type="button"
            (click)="onSave('SaveAndOpen')">Xác nhận và xem (F8)</button>

          <button tds-button color="primary" type="button" (click)="onSave()">Lưu lại</button>

          <button tds-button color="secondary" type="button" class="mr-4" (click)="onBack()">Quay lại</button>
      </div>
    </div>

    <div class="flex flex-col h-full gap-y-4 px-4 pb-4" *ngIf="dataModel">
      <div class="divide-y divide-transparent">
          <tds-tabset class="w-full bg-white rounded-t-xl" [(selectedIndex)]="selectedIndex" [ngClass]="selectedIndex == 1 ? '' : 'rounded-b-xl'">
              <tds-tab title="Thông tin">
                <!-- tab thông tin -->
                <div class="grid grid-cols-3 grid-rows-3 2xl:gap-x-8 xl:gap-x-4 xl:gap-y-4 xl:text-caption-1 2xl:text-body-2 text-neutral-1-900">
                  <div class="flex col-span-1 row-span-2">
                    <div class="w-1/3 h-[32px] flex items-center">
                      <span class="font-semibold">Khách hàng</span>
                    </div>

                    <div class="w-2/3 flex flex-col gap-y-2" *ngIf="dataModel.State === 'draft'">
                      <tds-form-field>
                          <tds-select valueField="Id" textField="DisplayName" [valuePrimitive]="false"
                            placeholder='Chọn tên khách hàng' formControlName="Partner" (onSearch)="onSearchPartner($event)"
                            (selectChange)="selectChangePartner($event)"
                            [data]="(lstCustomers | async) || []" [allowClear]="true">

                            <ng-template tds-label-tmp let-item="item">
                              {{item.data.DisplayName || item.data.Name}}
                            </ng-template>

                            <ng-template tds-option-tmp let-label='label' let-item="item" let-value='value' let-selected="selected">
                              <div class="flex flex-col gap-y-2.5">
                                  <span class="font-semibold" [ngClass]="{'text-primary-1':selected}">{{ item.DisplayName || item.Name }}</span>
                                  <div class="flex gap-x-1">
                                    <div *ngIf="item.Street"
                                      class="tdsi-pin-fill text-body-2 leading-none text-white bg-base-orange-500 p-0.5 rounded-md">
                                    </div>
                                    <div *ngIf="item.Phone" class="flex items-center justify-center">
                                      <span
                                        class="tdsi-call-fill text-body-2 leading-none text-white bg-base-green-400 p-0.5 rounded-md"></span>
                                      <span class="ml-1">{{ item.Phone }}</span>
                                    </div>
                                    <span *ngIf="!item.Phone && !item.Address">--</span>
                                  </div>
                              </div>
                            </ng-template>
                          </tds-select>
                      </tds-form-field>
                      <div class="flex justify-between">
                        <div>
                            <tds-button-group *ngIf="_form.controls['Partner']?.value">
                              <button tds-dropdown trigger="click" type="button" [tdsDropdownMenu]="menu1">
                                  <span class="flex items-center font-semibold"
                                    [ngStyle]="{'color': onCurrentStatus(_form.controls['Partner'].value?.StatusText, lstPartnerStatus) }">
                                    {{_form.controls["Partner"].value ? _form.controls["Partner"].value.StatusText : "N/A" }}
                                    <i class="tdsi-arrow-down-fill text-lg leading-none ml-2"></i>
                                  </span>
                              </button>
                              <tds-dropdown-menu #menu1="tdsDropdownMenu">
                                  <div class="w-full min-w-[100px] overflow-auto max-h-[300px] tds-panel-scroll">
                                      <div tds-dropdown-item *ngFor="let item of lstPartnerStatus" (click)="selectStatus(item)">
                                          <a [ngStyle]="{'color': item.value }"> {{ item.text }} </a>
                                      </div>
                                  </div>
                              </tds-dropdown-menu>
                            </tds-button-group>
                        </div>

                        <div class="flex gap-x-2">
                          <button tds-button-icon color="secondary" type="button" tds-tooltip tooltipTitle="Sửa khách hàng"
                              *ngIf="_form.controls['Partner'].value" (click)="editPartner(_form.controls['Partner'].value)">
                              <span class="flex items-center">
                                <i class="tdsi-edit-fill text-neutral-1-500"></i>
                              </span>
                          </button>
                          <button tds-button-icon color="primary" type="button" tds-tooltip tooltipTitle="Thêm khách hàng"
                              (click)="createPartner()">
                              <span class="flex items-center">
                                <i class="tdsi-plus-fill"></i>
                              </span>
                          </button>
                          <button tds-button-icon color="secondary" type="button" tds-tooltip tooltipTitle="Tìm kiếm khách hàng" (click)="showModalSearchPartner()">
                              <span class="flex items-center">
                                <i class="tdsi-search-fill text-neutral-1-500"></i>
                              </span>
                          </button>
                        </div>
                      </div>
                    </div>

                    <div class="w-2/3 flex flex-col" *ngIf="dataModel.State != 'draft'">
                        <a class="font-semibold hover:underline hover:cursor-pointer text-info-500 h-[32px] flex items-center"
                          (click)="editPartner(_form.controls['Partner'].value)">
                          <p class="max-w-[200px] truncate" tds-tooltip tooltipTitle="Chỉnh sửa khách hàng">
                            {{_form.controls['Partner'].value ? _form.controls['Partner'].value.DisplayName : 'N/A' }}
                          </p>
                        </a>
                        <div>
                          <tds-button-group *ngIf="_form.controls['Partner']?.value">
                            <button tds-dropdown trigger="click" type="button" [tdsDropdownMenu]="menu1">
                                <span class="flex items-center font-semibold"
                                  [ngStyle]="{'color': onCurrentStatus(_form.controls['Partner'].value?.StatusText, lstPartnerStatus) }">
                                  {{_form.controls["Partner"].value ? _form.controls["Partner"].value.StatusText : "N/A" }}
                                  <i class="tdsi-arrow-down-fill text-lg leading-none ml-2"></i>
                                </span>
                            </button>
                            <tds-dropdown-menu #menu1="tdsDropdownMenu">
                                <div class="w-full">
                                    <div tds-dropdown-item *ngFor="let item of lstPartnerStatus" (click)="selectStatus(item)">
                                        <a [ngStyle]="{'color': item.value }"> {{ item.text }} </a>
                                    </div>
                                </div>
                            </tds-dropdown-menu>
                          </tds-button-group>
                        </div>
                    </div>
                  </div>

                  <div class="col-span-1 flex gap-x-6 items-center">
                      <div class="w-1/3">
                        <span class="font-semibold">Bảng giá</span>
                      </div>

                      <div class="w-2/3" *ngIf="dataModel.State == 'draft'">
                        <tds-form-field>
                          <tds-select valueField="Id" textField="Name" (selectChange)="onChangePriceList($event)"
                            placeholder='Chọn bảng giá' formControlName="PriceList" [valuePrimitive]="false"
                            [data]="(lstPrices | async) || []" [allowClear]="true">
                          </tds-select>
                        </tds-form-field>
                      </div>

                      <div class="w-2/3" *ngIf="dataModel.State != 'draft'">
                        <span>
                          {{_form.controls['PriceList'].value ? _form.controls['PriceList'].value.Name : 'N/A' }}
                        </span>
                      </div>
                  </div>

                  <div class="col-span-1 flex gap-x-6 items-center">
                      <div class="w-1/3">
                        <span class="font-semibold">Người giao hàng</span>
                      </div>
                      <div class="w-2/3">
                        <tds-form-field>
                          <input tdsInput autocomplete="off" placeholder="Nhập tên người giao hàng" formControlName="Deliver" />
                        </tds-form-field>
                      </div>
                  </div>

                  <div class="col-span-1 flex gap-x-6 items-center">
                      <div class="w-1/3">
                        <span class="font-semibold">Số tiền trả</span>
                      </div>
                      <div class="w-2/3" *ngIf="dataModel.State == 'draft'">
                        <tds-form-field>
                          <tds-input-number [formatter]="numberWithCommas"
                          [parser]="parserComas" [min]='0' [step]="1000" formControlName="PaymentAmount" [max]="_form.controls['AmountTotal'].value"></tds-input-number>
                        </tds-form-field>
                      </div>
                      <div class="w-2/3" *ngIf="dataModel.State != 'draft'">
                        <span>
                          {{ _form.controls['PaymentAmount'].value ?  (_form.controls['PaymentAmount'].value | numberCustom ) : 0 }} đ
                        </span>
                      </div>
                  </div>

                  <div class="col-span-1 flex gap-x-6 items-center">
                      <div class="w-1/3">
                          <span class="font-semibold">Kho hàng</span>
                      </div>
                      <div class="w-2/3" *ngIf="dataModel.State == 'draft'">
                          <tds-form-field>
                            <tds-select valueField="Id" textField="NameGet" (selectChange)="onChangeWarehouse($event)"
                              placeholder='Chọn bảng giá' formControlName="Warehouse" [valuePrimitive]="false"
                              [data]="(lstWareHouses | async) || []" [allowClear]="true">
                            </tds-select>
                          </tds-form-field>
                      </div>
                      <div class="w-2/3" *ngIf="dataModel.State != 'draft'">
                        <span>
                          {{_form.controls['Warehouse'].value ? _form.controls['Warehouse'].value.NameGet : 'N/A' }}
                        </span>
                      </div>
                  </div>

                  <div class="col-span-1 flex items-center">
                    <div class="w-1/3">
                      <span class="font-semibold">Doanh số</span>
                    </div>
                    <div class="w-2/3">
                      <div >{{ (_form.controls['Revenue'].value || 0) | numberCustom  }} đ</div>
                    </div>
                  </div>

                  <div class="col-span-1 flex gap-x-6 items-center">
                    <div class="w-1/3">
                      <span class="font-semibold">Phương thức</span>
                    </div>
                    <div class="w-2/3" *ngIf="dataModel.State == 'draft'">
                      <tds-form-field>
                        <tds-select valueField="Id" textField="Name" (selectChange)="onChangePayment($event)"
                          placeholder='Chọn tên phương thức' formControlName="PaymentJournal" [valuePrimitive]="false"
                          [data]="(lstPaymentJournals | async) || []" [allowClear]="true">
                        </tds-select>
                      </tds-form-field>
                    </div>

                    <div class="w-2/3" *ngIf="dataModel.State != 'draft'">
                      <span *ngIf="_form.controls['PaymentJournal'].value">
                        {{_form.controls['PaymentJournal'].value.Name }} ({{_form.controls["PaymentJournal"].value.Type}})
                      </span>
                    </div>
                  </div>

                  <div class="col-span-1 flex gap-x-6 items-center">
                    <div class="w-1/3">
                      <span class="font-semibold">Kênh</span>
                    </div>

                    <div class="w-2/3" *ngIf="dataModel.State == 'draft'">
                      <tds-form-field>
                        <tds-select valueField="Id" textField="Name" (selectChange)="onChangeTeam($event)"
                          placeholder='Chọn kênh' formControlName="Team" [valuePrimitive]="false"
                          [data]="(lstTeams | async) || []" [allowClear]="true">
                        </tds-select>
                      </tds-form-field>
                    </div>

                    <div class="w-2/3" *ngIf="dataModel.State != 'draft'">
                      <span *ngIf="_form.controls['Team'].value">
                        {{_form.controls['Team'].value.Name }} - {{_form.controls["Team"].value.Facebook_PageName || 'N/A'}}
                      </span>
                    </div>
                  </div>
                </div>
              </tds-tab>
              <!-- tab thông tin giao hàng -->
              <tds-tab title="Thông tin giao hàng">
                <div class="grid grid-cols-3 2xl:gap-x-8 xl:gap-x-4 xl:gap-y-4 xl:text-caption-1 2xl:text-body-2 text-neutral-1-900">
                  <div class="grid grid-cols-3 2xl:gap-x-8 xl:gap-x-4 items-center">
                    <span class="col-span-1 w-full font-semibold">Đối tác giao hàng</span>

                    <div class="col-span-2 w-full flex flex-row gap-x-2">
                      <tds-form-field class="flex flex-auto">
                          <tds-select valueField="Id" textField="Name" (ngModelChange)="onChangeCarrierV2($event)"
                            formControlName="Carrier" placeholder='Chọn đối tác giao hàng' [valuePrimitive]="false"
                            [data]="lstCarriers" [allowClear]="true">
                          </tds-select>
                      </tds-form-field>
                      <!-- <button tds-button-icon tds-tooltip tooltipTitle="Tính" color="primary"
                          class="flex items-center justify-center" >
                          <i class="tdsi-truck-fill text-xl"></i>
                        </button> -->
                    </div>

                    <!-- <tds-label class="col-span-2 w-full" *ngIf="dataModel.State == 'open' || dataModel.State == 'cancel'">
                      {{_form.controls['Carrier'].value ? _form.controls['Carrier'].value.Name : '' }}
                    </tds-label> -->
                  </div>

                  <div class="grid grid-cols-3 2xl:gap-x-8 xl:gap-x-4 items-center">
                      <span class="col-span-1 w-full font-semibold">Phí giao hàng</span>
                      <tds-form-field class="col-span-2 w-full">
                          <tds-input-number [min]='0' [step]="1000" [formatter]="numberWithCommas"
                            [parser]="parserComas" placeholder="Nhập phí" formControlName="DeliveryPrice" (ngModelChange)="changeDeliveryPrice($event)">
                          </tds-input-number>
                      </tds-form-field>

                      <!-- <tds-label class="col-span-2 w-full" *ngIf="dataModel.State == ('open' || 'cancel')">
                        {{_form.controls['DeliveryPrice'].value ? _form.controls['DeliveryPrice'].value : 0 | numberCustom }}
                      </tds-label> -->
                  </div>

                  <div class="grid grid-cols-3 2xl:gap-x-8 xl:gap-x-4 items-center">
                      <span class="col-span-1 w-full font-semibold">Tiền cọc</span>
                      <tds-form-field class="col-span-2 w-full">
                          <tds-input-number [min]='0' [step]="1000"
                            [formatter]="numberWithCommas"
                            [parser]="parserComas" placeholder="Nhập tiền cọc" formControlName="AmountDeposit" (ngModelChange)="changeAmountDeposit($event)">
                          </tds-input-number>
                      </tds-form-field>

                      <!-- <tds-label class="col-span-2 w-full" *ngIf="dataModel.State == ('open' || 'cancel')">
                        {{_form.controls['AmountDeposit'].value ? _form.controls['AmountDeposit'].value : 0 | numberCustom }}
                      </tds-label> -->
                  </div>

                  <div class="grid grid-cols-3 2xl:gap-x-8 xl:gap-x-4 items-center">
                    <span class="col-span-1 w-full font-semibold">Giao hàng thu tiền</span>
                    <div class="col-span-2 w-full">
                      <tds-form-field>
                        <tds-input-number [min]='0' [step]="1000"
                          [formatter]="numberWithCommas"
                          [parser]="parserComas" placeholder="Nhập tiền" formControlName="CashOnDelivery">
                        </tds-input-number>
                      </tds-form-field>
                    </div>

                    <!-- <div class="col-span-2 w-full" *ngIf="dataModel.State == 'cancel'">
                      <span class="font-semibold">
                        {{_form.controls['CashOnDelivery'].value ? _form.controls['CashOnDelivery'].value : 0 | numberCustom }}
                      </span>
                    </div> -->
                  </div>

                  <div class="grid grid-cols-3 2xl:gap-x-8 xl:gap-x-4 items-center">
                      <span class="col-span-1 w-full font-semibold">Khối lượng ship (g)</span>
                      <tds-form-field class="col-span-2 w-full">
                        <tds-input-number [min]='0' [step]="100" [formatter]="numberWithCommas" [parser]="parserComas"
                            formControlName="ShipWeight" placeholder="Nhập khối lượng" (tdsBlur)="changeShipWeight()">
                        </tds-input-number>
                      </tds-form-field>

                      <!-- <tds-label class="col-span-2 w-full" *ngIf="dataModel.State == ('open' || 'cancel')">
                        {{_form.controls['ShipWeight'].value ? _form.controls['ShipWeight'].value : 0 | numberCustom }}
                      </tds-label> -->
                  </div>

                  <div class="grid grid-cols-3 2xl:gap-x-8 xl:gap-x-4 items-center">
                      <span class="col-span-1 w-full font-semibold">Ghi chú giao hàng</span>
                      <tds-form-field class="col-span-2 w-full">
                        <input tdsInput autocomplete="off" placeholder="Nhập ghi chú" formControlName="DeliveryNote" />
                      </tds-form-field>
                  </div>

                  <div class="grid grid-cols-3 2xl:gap-x-8 xl:gap-x-4 items-center" *ngIf="_form.controls['TrackingRef'].value">
                    <span class="col-span-1 w-full font-semibold">Mã vận đơn</span>
                    <div class="col-span-2 w-full">
                        <span class="font-semibold">{{_form.controls['TrackingRef'].value ? _form.controls['TrackingRef'].value : ''}} </span>
                        <span class="text-primary-1"
                          *ngIf="_form.controls['Carrier'].value && _form.controls['Carrier'].value?.DeliveryType == 'GHN' && _form.controls['TrackingRef'].value"
                          (click)="openTrackingOrderGHN()" title="Theo dõi đơn hàng">
                        </span>
                        <span class="text-primary-1"
                          *ngIf="_form.controls['Carrier'].value && _form.controls['Carrier'].value?.DeliveryType == 'AhaMove' && _form.controls['TrackingRef'].value"
                          (click)="openTrackingOrderAhaMove()" title="Theo dõi đơn hàng">
                        </span>
                    </div>
                  </div>
                </div>
              </tds-tab>
              <!-- tab thông tin người nhận -->
              <!-- *ngIf="this.roleConfigs && this.roleConfigs.GroupFastSaleReceiver == true" -->
              <tds-tab title="Thông tin người nhận">
                <div class="grid grid-cols-2 gap-x-8 gap-y-4 xl:text-caption-1 2xl:text-body-2 text-neutral-1-900">
                  <div class="col-span-1 flex flex-col gap-y-4">
                    <div class="flex 2xl:gap-x-6 xl:gap-x-4 items-center">
                      <span class="col-span-1 w-1/4 font-semibold">Tên người nhận</span>
                      <tds-form-field class="w-3/4">
                        <input tdsInput autocomplete="off" placeholder="Nhập tên người nhận"
                          formControlName="ReceiverName" />
                      </tds-form-field>
                    </div>
                    <div class="flex 2xl:gap-x-6 xl:gap-x-4 items-center">
                      <span class="col-span-1 w-1/4 font-semibold">Điện thoại</span>
                      <tds-form-field class="w-3/4" [color]="_form.controls['ReceiverPhone'].invalid && _form.controls['ReceiverPhone'].touched ? 'error' : 'default'">
                        <input tdsInput autocomplete="off" placeholder="Nhập số điện thoại" formControlName="ReceiverPhone"/>
                        <tds-error *ngIf="_form.controls['ReceiverPhone'].invalid">Số điện thoại không hợp lệ</tds-error>
                      </tds-form-field>
                    </div>

                    <div class="flex 2xl:gap-x-6 xl:gap-x-4 items-center">
                      <span class="col-span-1 w-1/4 font-semibold">Ghi chú</span>
                      <tds-form-field class="w-3/4">
                        <input tdsInput autocomplete="off" placeholder="Ghi chú"
                          formControlName="ReceiverNote" />
                      </tds-form-field>
                    </div>
                  </div>

                  <div class="col-span-1 flex flex-col gap-y-4" formGroupName="Ship_Receiver">
                    <div class="flex 2xl:gap-x-6 xl:gap-x-4 items-center">
                      <span class="col-span-1 w-1/4 font-semibold">Tìm kiếm địa chỉ</span>
                      <div class="w-3/4 flex gap-x-2">
                        <tds-form-field class="w-full">
                          <input tdsInput placeholder="Tìm kiếm địa chỉ ..." [(ngModel)]="innerText" [ngModelOptions]="{standalone: true}"/>
                        </tds-form-field>
                        <button tds-button-icon color="primary" type="button" tds-tooltip [tooltipTitle]="innerText ? 'Kiểm tra địa chỉ' : 'Tìm kiếm địa chỉ'" (click)="showModalSuggestAddress()">
                            <span class="flex items-center">
                              <i class="tdsi-location-fill"></i>
                            </span>
                        </button>
                      </div>
                    </div>

                    <div class="flex 2xl:gap-x-6 xl:gap-x-4 items-center">
                      <span class="col-span-1 w-1/4 font-semibold">Tỉnh/Thành phố:</span>
                      <div class="w-3/4 flex gap-x-2">
                        <tds-form-field class="w-full">
                          <tds-select valueField="code" textField="name" placeholder='Tỉnh/Thành' [valuePrimitive]="false"
                            (onSearch)="handleCityFilter($event)" formControlName="City" disabledField="isActive" [data]="lstCity"
                            [allowClear]="true" (selectChange)="changeCity($event)">
                          </tds-select>
                        </tds-form-field>
                      </div>
                    </div>

                    <div class="flex 2xl:gap-x-6 xl:gap-x-4 items-center">
                      <span class="col-span-1 w-1/4 font-semibold">Quận/Huyện:</span>
                      <div class="w-3/4 flex gap-x-2">
                        <tds-form-field class="w-full">
                          <tds-select valueField="code" textField="name" placeholder='Quận/Huyện' [valuePrimitive]="false"
                            (onSearch)="handleFilterDistrict($event)" formControlName="District" disabledField="isActive"
                            [data]="lstDistrict" [allowClear]="true" (selectChange)="changeDistrict($event)">
                          </tds-select>
                        </tds-form-field>
                      </div>
                    </div>

                    <div class="flex 2xl:gap-x-6 xl:gap-x-4 items-center">
                      <span class="col-span-1 w-1/4 font-semibold">Phường/Xã thị trấn:</span>
                      <div class="w-3/4 flex gap-x-2">
                        <tds-form-field class="w-full">
                          <tds-select valueField="code" textField="name" placeholder='Phường/Xã' [valuePrimitive]="false"
                            (onSearch)="handleFilterWard($event)" formControlName="Ward" disabledField="isActive" [data]="lstWard"
                            [allowClear]="true" (selectChange)="changeWard($event)">
                          </tds-select>
                        </tds-form-field>
                      </div>
                    </div>

                    <div class="flex 2xl:gap-x-6 xl:gap-x-4 items-center">
                      <span class="col-span-1 w-1/4 font-semibold">Địa chỉ giao hàng:</span>
                      <div class="w-3/4 flex gap-x-2">
                        <tds-form-field class="w-full">
                          <input tdsInput placeholder="Số nhà, đường" formControlName="Street" (change)="changeStreet($event)"/>
                        </tds-form-field>
                      </div>
                    </div>
                  </div>
                </div>
              </tds-tab>
              <!-- tab thông tin khác -->
              <tds-tab title="Thông tin khác">
                <div class="grid grid-cols-3 2xl:gap-x-8 xl:gap-x-4 xl:gap-y-4 xl:text-caption-1 2xl:text-body-2 text-neutral-1-900">
                  <div class=" col-span-1 flex gap-x-6 items-center">
                    <div class="w-1/3">
                      <span class="font-semibold">Người bán</span>
                    </div>
                    <div class="w-2/3" *ngIf="dataModel.State == 'draft'">
                      <tds-form-field>
                        <tds-select valueField="Id" textField="Name" (selectChange)="onChangeUser($event)"
                          placeholder='Chọn người bán' formControlName="User" [valuePrimitive]="false"
                          [data]="(lstUser | async) || []" [allowClear]="true">
                        </tds-select>
                      </tds-form-field>
                    </div>
                    <div class="w-2/3" *ngIf="dataModel.State !== 'draft'">
                      <span>{{_form.controls['User'].value ? _form.controls['User'].value.Name : ''}}
                      </span>
                    </div>
                  </div>
                  <div class=" col-span-1 flex gap-x-6 items-center">
                    <div class="w-1/3">
                      <span class="font-semibold">Số hóa đơn đỏ</span>
                    </div>
                    <div class="w-2/3">
                      <tds-form-field>
                        <input tdsInput autocomplete="off" placeholder="Nhập số hóa đơn đỏ" formControlName="NumberOrder" />
                      </tds-form-field>
                    </div>
                  </div>
                  <div class=" col-span-1 flex gap-x-6 items-center">
                    <div class="w-1/3">
                      <span class="font-semibold">Tham chiếu</span>
                    </div>
                    <div class="w-2/3">
                      <span>{{_form.controls['Reference'].value || 'N/A'}}</span>
                    </div>
                  </div>
                  <div class=" col-span-1 flex gap-x-6 items-center">
                    <div class="w-1/3">
                      <span class="font-semibold">Seri</span>
                    </div>
                    <div class="w-2/3">
                      <tds-form-field>
                        <input tdsInput autocomplete="off" placeholder="Nhập Seri" formControlName="Seri" />
                      </tds-form-field>
                    </div>
                  </div>

                  <div class=" col-span-1 flex gap-x-6 items-center">
                    <div class="w-1/3">
                      <span class="font-semibold">Ngày hóa đơn </span>
                    </div>
                    <div class="w-2/3" *ngIf="dataModel.State == 'draft'">
                      <tds-date-picker formControlName="DateInvoice"></tds-date-picker>
                    </div>
                    <div class="w-2/3" *ngIf="dataModel.State != 'draft'">
                      <span *ngIf="_form.controls['DateInvoice']?.value">{{ _form.controls['DateInvoice'].value | date:'dd/MM/yyyy HH:mm' }} </span>
                    </div>
                  </div>
                  <div class=" col-span-1 flex gap-x-6 items-center">
                    <div class="w-1/3">
                      <span class="font-semibold">Trạng thái</span>
                    </div>
                    <div class="w-2/3">
                      <span>{{ showStatus(_form.controls['State'].value) }}</span>
                    </div>
                  </div>
                  <div class=" col-span-1 flex gap-x-6 items-center">
                    <div class="w-1/3">
                      <span class="font-semibold">Ghi chú ĐH</span>
                    </div>
                    <div class="w-2/3">
                      <tds-form-field>
                        <input tdsInput autocomplete="off" placeholder="Nhập ghi chú" formControlName="Comment" />
                      </tds-form-field>
                    </div>
                  </div>
                  <div class="col-span-1 flex gap-x-6 items-center">
                    <div class="w-1/3">
                      <span class="font-semibold">Ngày hóa đơn đỏ</span>
                    </div>
                    <div class="w-2/3" *ngIf="dataModel.State == 'draft'">
                      <tds-date-picker formControlName="DateOrderRed"></tds-date-picker>
                    </div>
                    <div class="w-2/3" *ngIf="dataModel.State != 'draft'">
                      <span class="font-semibold" *ngIf="_form.controls['DateOrderRed'].value">{{
                        _form.controls['DateOrderRed'].value | date:"dd-MM-yyyy HH:mm" }} </span>
                    </div>
                  </div>
                  <div class=" col-span-1 flex gap-x-6 items-center">
                    <div class="w-1/3">
                      <span class="font-semibold">Nợ cũ</span>
                    </div>
                    <div class="w-2/3">
                      <span>{{ _form.controls['PreviousBalance'].value || 0 | numberCustom }} đ</span>
                    </div>
                  </div>
                </div>
              </tds-tab>
          </tds-tabset>
          <!-- collapse dịch vụ đối tác -->
          <div *ngIf="selectedIndex == 1">
            <tds-collapse accordion="true" [bordered]="false">
              <tds-collapse-panel header="Dịch vụ của đối tác" [tdsClass]="'w-full rounded-b-xl bg-white p-4'"
                [tdsHeaderClass]="'bg-neutral-3-50 p-3'" [active]="true" [expandedIcon]="'tdsi-arrow-right-line'">
                <div class="grid grid-cols-2 gap-x-8 items-start w-full">
                  <!-- thông tin dịch vụ -->
                  <div class="grid grid-col-4 gap-y-4">

                    <!-- không có dịch vụ -->
                    <div class="w-full" *ngIf="shipServices && shipServices.length == 0 && shipExtraServices && shipExtraServices.length == 0">
                      <span class="text-body-2 italic">Chưa có dịch vụ nào</span>
                    </div>

                    <!-- danh sách dịch vụ -->
                    <div class="col-span-3 flex flex-row items-center" *ngIf="shipServices && shipServices.length > 0">
                      <tds-label class="w-1/4">Dịch vụ<span class="text-error-400">*</span></tds-label>

                      <tds-form-field class="w-3/4">
                        <tds-select valueField="ServiceId" textField="ServiceName"
                          (selectChange)="onSelectShipServiceId($event)" placeholder='Chọn dịch vụ' formControlName="Ship_ServiceId"
                          [data]="shipServices" [allowClear]="false">

                          <ng-template tds-label-tmp let-item="item"> {{ item.data.ServiceName }}
                            <span *ngIf="item.data.TotalFee > 0">: {{ item.data.TotalFee | numberCustom }}</span>
                          </ng-template>

                        </tds-select>
                      </tds-form-field>
                    </div>

                    <div class="col-span-3 flex flex-row items-center" *ngIf="insuranceInfo">
                      <tds-label class="w-1/4">Giá trị hàng hóa</tds-label>
                      <div class="flex flex-row items-center gap-x-2 w-3/4">
                          <tds-form-field class="flex flex-auto">
                            <tds-input-number [min]='0' [step]="1000" [formatter]="numberWithCommas" [parser]="parserComas"
                              placeholder="Nhập phí" formControlName="Ship_InsuranceFee" (ngModelChange)="changeShip_InsuranceFee($event)">
                            </tds-input-number>
                          </tds-form-field>

                          <button tds-button-icon tds-tooltip tooltipTitle="Gán bằng tổng giá trị hoá đơn" color="primary"
                            class="flex items-center justify-center" (click)="signAmountTotalToInsuranceFee()">
                            <i class="tdsi-in-out-fill text-xl"></i>
                          </button>
                      </div>
                    </div>

                    <ng-container *ngFor="let item of configsProviderDataSource">
                      <div class="col-span-3 flex flex-row items-center" *ngIf="!item.IsHidden">
                        <tds-label class="w-1/4">{{item.DisplayName}}<span class="text-error-400">*</span></tds-label>

                        <tds-form-field class="w-3/4">
                          <tds-select valueField="Id" textField="Name" placeholder='Chọn option'
                            [data]="item.ConfigsValue" [(ngModel)]="item.ConfigValue" [allowClear]="false"
                            [ngModelOptions]="{standalone: true}" [allowClear]="item.InputType == 'combo_box'">
                          </tds-select>
                        </tds-form-field>
                      </div>
                    </ng-container>
                  </div>
                  <div class="grid grid-cols-3 gap-y-4 gap-x-6">
                    <!-- phí ship đối tác -->
                    <div class="col-span-3 w-full flex flex-row items-center" *ngIf="_form.controls['Carrier'].value">
                      <span class="pr-4">Phí ship (đối tác)</span>
                      <div class="col-span-2 flex-auto flex items-center">
                        <div class="px-4">
                          <span class="border rounded-md py-1 px-2 text-primary-1">{{_form.controls["CustomerDeliveryPrice"].value || 0 | numberCustom }} đ</span>
                        </div>

                        <div class="px-4 border-l">
                          <button *ngIf="!_form.controls['TrackingRef'].value && this.isEnableCalcFee" tds-button-icon color="info" size="sm"
                            (click)="calcFee()" tds-tooltip tooltipTitle="Tính lại tiền ship" type="button">
                            <span class="flex items-center justify-center">
                              <i class=" tdsi-reload-fill"></i>
                            </span>
                          </button>
                        </div>
                      </div>

                    </div>

                    <!-- ship extras service -->
                    <div *ngIf="shipExtraServices && shipExtraServices.length > 0" class="col-span-3">
                      <div class="grid grid-cols-3 gap-y-4 gap-x-6">
                        <div *ngFor="let service of shipExtraServices; let i=index">

                          <tds-checkbox [(ngModel)]="service.IsSelected" [ngModelOptions]="{standalone: true}">
                            <div class="flex flex-row items-center w-full">

                              <span class="mr-2">{{ service.Name }}</span>
                              <div *ngIf="_form.controls['Carrier'].value?.DeliveryType === 'ViettelPost' && service.Id == 'XMG' && service.IsSelected == true">

                                <button type="button" style="border-bottom: dashed 2px #2395FF;" tds-popover
                                  popoverTrigger="click" (click)="openPopoverShipExtraMoney(service.ExtraMoney)"
                                  [(popoverVisible)]="visibleShipExtraMoney"
                                  [popoverContent]="popoverContentShip_ExtraMoney"
                                  [popoverFooter]="popoverFooterShip_ExtraMoney" [popoverAutoClose]="true"
                                  [popoverBackdrop]="true" popoverPlacement="right">
                                  {{(service.ExtraMoney | numberCustom) || 0}}đ
                                </button>

                                <!-- popover button Thuế -->
                                <ng-template #popoverContentShip_ExtraMoney>
                                  <div class="flex gap-x-2">
                                    <tds-form-field>
                                      <tds-input-number [min]='0' [step]="1000" [(ngModel)]="extraMoney" [formatter]="numberWithCommas" [parser]="parserComas"
                                        (ngModelChange)="changeExtramoney($event)"
                                        [ngModelOptions]="{standalone: true}">
                                      </tds-input-number>
                                    </tds-form-field>
                                  </div>
                                </ng-template>

                                <ng-template #popoverFooterShip_ExtraMoney>
                                  <div class="flex justify-end gap-x-2 mt-2">
                                    <button tds-button-icon color="primary" type="button"
                                      (click)="changeShipExtraMoney($event)">
                                      <span class="flex items-center"> <i class="tdsi-checkbox-check-fill"></i></span>
                                    </button>

                                    <button tds-button-icon color="secondary" type="button"
                                      (click)="closePopoverShipExtraMoney()">
                                      <span class="flex items-center"> <i class="tdsi-close-fill"></i></span>
                                    </button>
                                  </div>
                                </ng-template>
                              </div>
                            </div>
                          </tds-checkbox>
                          <span class="text-body-2 text-primary" *ngIf="service.Fee"> {{ service.Fee | numberCustom }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </tds-collapse-panel>
            </tds-collapse>
          </div>
      </div>

      <!-- Danh sách sản phẩm -->
      <div class="h-full w-full" *ngIf="dataModel && dataModel.State != 'draft'">
          <div class="h-full w-full">
              <div class="rounded-xl pt-2 px-3 bg-white h-full flex flex-auto gap-y-2 text-body-2 text-neutral-1-900">
                <tds-table templateMode #TableAddBill [listData]="_form['controls'].OrderLines.value"
                    [scroll]="{y:'auto', x:'auto'}" [showPagination]="false" >
                  <thead>
                    <tr>
                      <th>STT</th>
                      <th>Sản Phẩm</th>
                      <th>Số lượng</th>
                      <th>Đơn giá</th>
                      <th *ngIf="saleConfig?.SaleSetting?.GroupPriceRecent == true">Giá gần đây</th>
                      <th *ngIf="saleConfig?.SaleSetting?.GroupDiscountPerSOLine == 1">Giảm giá</th>
                      <th *ngIf="saleConfig?.SaleSetting?.GroupWeightPerSOLine == 1">KL(g)</th>
                      <th>Thành tiền</th>
                    </tr>
                  </thead>
                  <tbody>
                    <ng-template ngFor let-data let-i="index" [ngForOf]="TableAddBill.data">
                      <tr>
                        <!-- STT -->
                        <td>{{ i + 1 }}</td>
                        <!-- Sản phẩm -->
                        <td>
                          <div class="flex flex-col">
                            <span class="font-semibold">{{ data.ProductNameGet }}</span>
                            <span class="text-neutral-1-400">Đơn vị: {{ data.ProductUOMName }}</span>
                            <!-- Nhập ghi chú -->
                            <span class="text-neutral-1-400" tds-popover popoverTrigger="click"
                              [popoverContent]="popoverAddNote" [popoverAutoClose]="true" [popoverBackdrop]="true"
                              popoverPlacement="left">
                              <i class="tdsi-edit-fill mr-2"></i> {{ data.Note || 'Chưa có ghi chú' }}
                            </span>
                            <a class="inline-block" *ngIf="saleConfig?.SaleSetting?.GroupAddStaffInvoiceDetail == true">
                              <span class="text-info-500 font-semibold">
                                <i class="tdsi-user-fill mr-2 "></i> {{ data.User?.Name || 'Chưa chọn nhân viên' }}
                              </span>
                            </a>
                            <ng-template #popoverAddNote>
                              <div class="mb-2">
                                <tds-form-field>
                                  <input tdsInput autocomplete="off" placeholder="Nhập ghi chú" [(ngModel)]="data.Note" [ngModelOptions]="{standalone: true}" />
                                </tds-form-field>
                              </div>
                            </ng-template>
                          </div>
                        </td>
                        <!-- Số lượng -->
                        <td> {{ data.ProductUOMQty || 0 | numberCustom }}</td>
                        <!-- Đơn giá -->
                        <td> {{ data.PriceUnit || 0 | numberCustom }}</td>
                        <!-- Giá gần đây -->
                        <td *ngIf="saleConfig?.SaleSetting?.GroupPriceRecent == true" class="text-center">
                          {{ data.PriceRecent || 0 | numberCustom }}
                        </td>
                        <!-- Giảm giá -->
                        <td *ngIf="saleConfig?.SaleSetting?.GroupDiscountPerSOLine == 1">
                          <span color="secondary">
                            <span class="underline decoration-dotted text-neutral-1-400" *ngIf="data.Type === 'percent'">
                              {{ data.Discount || 0 | numberCustom }}%
                            </span>
                            <span class="underline decoration-dotted text-neutral-1-400" *ngIf="data.Type === 'fixed'">
                              {{ data.Discount_Fixed || 0 | numberCustom  }} đ
                            </span>
                          </span>
                        </td>
                        <!-- Khối lượng -->
                        <td *ngIf="saleConfig?.SaleSetting?.GroupWeightPerSOLine == 1">{{ data.Weight >= 0 ? (data.Weight * 1000)*(data.ProductUOMQty || 0) : 0 }}</td>
                        <!-- Thành tiền -->
                        <td>{{ data.PriceTotal || 0 | numberCustom  }}</td>
                      </tr>
                    </ng-template>
                    <tr class="hover:bg-white border-b-0">
                      <td colspan="9">
                        <div class="flex w-full justify-end">
                          <div class="w-1/3 flex justify-end">
                            <div class="w-full grid grid-cols-3 gap-2 text-right font-semibold">
                              <div><span class="font-regular">Tổng số lượng</span></div>
                              <div class="col-span-2"><span>{{ totalQtyLines | numberCustom }}</span></div>

                              <div><span class="font-regular">Tổng tạm tính</span></div>
                              <div class="col-span-2"><span>{{ totalAmountLines | numberCustom  }} đ</span></div>

                              <div><span>Giảm giá</span></div>
                              <div class="col-span-2">
                                <span>{{ (_form.controls["DecreaseAmount"].value + _form.controls["DiscountAmount"].value) || 0 | numberCustom }} đ</span>
                              </div>

                              <div><span>Thuế</span></div>
                              <div class="col-span-2 flex items-center justify-end">
                                <span>{{ _form.controls["AmountTax"].value || 0 | numberCustom }}đ</span> -
                                <span>{{ _form.controls["Tax"].value ? _form.controls["Tax"].value.Amount : 0 }}%</span>
                              </div>

                              <div><span>Tổng tiền</span></div>
                              <div class="col-span-2"><span>
                                {{ _form.controls["AmountTotal"].value | numberCustom }}đ</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </tds-table>
              </div>
          </div>
      </div>

      <div class="flex gap-x-4 h-full" *ngIf="dataModel && dataModel.State == 'draft'">
          <div class="xl:w-1/3 2xl:w-1/3 h-full">
              <list-product-tmp
                [type]="'order'"
                [priceListItems]="priceListItems"
                [isLoadingProduct]="isLoadingProduct"
                (onLoadProductToOrderLines)="onLoadProductToOrderLines($event)">
              </list-product-tmp>
          </div>

          <div class="xl:w-2/3 2xl:w-2/3 h-full">
            <div class="rounded-xl bg-white flex h-full w-full gap-y-2 py-3 text-body-2 text-neutral-1-900">
              <tds-table templateMode #TableAddBill [scroll]="{y: 'auto', x: 'auto'}" [showPagination]="false">
                <thead>
                  <tr>
                    <th [width]="'50px'" [tdsLeft]="true">STT</th>
                    <th [width]="'240px'" [tdsLeft]="true">Sản Phẩm</th>
                    <th [width]="'120px'">Số lượng</th>
                    <th [width]="'120px'">Đơn giá</th>
                    <!-- <th [width]="'100px'">Giá gần đây</th> -->
                    <th [width]="'100px'" *ngIf="saleConfig?.SaleSetting?.GroupDiscountPerSOLine == 1">Giảm giá</th>
                    <th *ngIf="saleConfig?.SaleSetting?.GroupWeightPerSOLine == 1" [width]="'100px'" class="truncate">KL(g)</th>
                    <th [width]="'100px'">Thành tiền</th>
                    <th [width]="'100px'" [tdsRight]="true">
                      <div class="flex items-center justify-end">
                        <button tds-button-icon color="error" tds-tooltip="Xóa hết" size="sm" type="button" (click)="removeAllOrderLines()">
                          <span class="flex items-center">
                            <i class="tdsi-trash-fill"></i>
                          </span>
                        </button>
                      </div>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let data of _form['controls'].OrderLines.value; let i= index">
                    <td [tdsLeft]="true">{{ i + 1 }}</td>
                    <td [tdsLeft]="true">
                      <div class="flex flex-col">
                        <span class="font-semibold 2xl:max-w-[250px] xl:max-w-[200px] truncate" tds-tooltip="{{ data.ProductNameGet }}">{{ data.ProductNameGet }}</span>
                        <span class="text-neutral-1-400">Đơn vị: {{ data.ProductUOMName }}</span>
                        <span class="text-neutral-1-400 flex" tds-popover popoverTrigger="click"
                          [popoverContent]="popoverAddNote" [popoverAutoClose]="true" [popoverBackdrop]="true"
                          popoverPlacement="left">
                          <i class="tdsi-edit-fill mr-2 mt-1 cursor-pointer"></i>
                          <div class="w-[100px]" showMore [length]="30" [text]="data.Note ||'Nhập ghi chú'">
                          </div>
                        </span>
                        <a class="inline-block" *ngIf="saleConfig?.SaleSetting?.GroupAddStaffInvoiceDetail == true">
                          <span class="text-info-500 font-semibold" tds-popover popoverTrigger="click"
                            [popoverContent]="popoverAddUser" [popoverAutoClose]="true" [popoverBackdrop]="true"
                            popoverPlacement="left">
                            <i class="tdsi-user-fill mr-2 cursor-pointer"></i> {{ data.User?.Name || 'Chọn nhân viên' }}
                          </span>
                        </a>
                      </div>
                      <!-- popover thêm ghi chú mỗi dòng -->
                      <ng-template #popoverAddNote>
                        <div class="mb-2">
                          <tds-form-field class="w-[200px]">
                            <input tdsInput autocomplete="off" placeholder="Nhập ghi chú" [(ngModel)]="data.Note"
                              [ngModelOptions]="{standalone: true}" />
                          </tds-form-field>
                        </div>
                      </ng-template>
                      <!-- popover thêm nhân viên mỗi dòng -->
                      <ng-template #popoverAddUser>
                        <div class="mb-2">
                          <tds-form-field class="w-[200px]">
                            <tds-select valueField="Id" textField="Name"
                              (selectChange)="onAddUserOrderLines($event, i)" placeholder='Chọn nhân viên'
                              [valuePrimitive]="false" [(ngModel)]="data.User" [ngModelOptions]="{standalone: true}"
                              [data]="(lstUser | async) || []" [allowClear]="true">
                            </tds-select>
                          </tds-form-field>
                        </div>
                      </ng-template>
                    </td>
                    <!-- Số lượng -->
                    <td>
                      <tds-input-number [(ngModel)]="data.ProductUOMQty" [min]="1" [step]="1" [formatter]="numberWithCommas" [parser]="parserComas" [autoFocus]="focusField == 'ProductUOMQty'"
                        (ngModelChange)="onChangeQuantity($event, data)" [ngModelOptions]="{standalone: true}">
                      </tds-input-number>
                    </td>
                    <!-- Đơn giá -->
                    <td>
                      <tds-input-number [(ngModel)]="data.PriceUnit" [min]="0" [step]="1000" [formatter]="numberWithCommas" [parser]="parserComas" [autoFocus]="focusField == 'PriceUnit'"
                        (ngModelChange)="onChangePriceUnit($event, data)" [ngModelOptions]="{standalone: true}">
                      </tds-input-number>
                    </td>
                    <!-- Giá gần đây -->
                    <!-- <td class="text-center">{{ data.PriceRecent || 0 | numberCustom }}</td> -->
                    <!-- Giảm giá -->
                    <td *ngIf="saleConfig?.SaleSetting?.GroupDiscountPerSOLine == 1" class="text-center">
                      <div class="relative">
                        <span class="underline decoration-dotted cursor-pointer text-neutral-1-400 hover:text-info-500 hover:decoration-info-500"
                          *ngIf="data.Type === 'percent'" 
                          (click)="openDiscountProductPopover(data)">
                          {{ data.Discount || 0 | numberCustom }} %
                        </span>

                        <span class="underline decoration-dotted cursor-pointer text-neutral-1-400 hover:text-info-500 hover:decoration-info-500"
                          *ngIf="data.Type === 'fixed'" 
                          (click)="openDiscountProductPopover(data)">
                          {{ data.Discount_Fixed || 0 | numberCustom }} đ
                        </span>

                        <!-- popover giảm giá mỗi dòng -->
                        <div class="absolute -left-[300px] -top-[30px] bg-white shadow-lg rounded-xl w-[300px] z-9999 p-4"
                          *ngIf="isOpenDiscount[data.ProductId + '_' + data.ProductUOMId + '_' + data.Id]">
                          <div class="mb-2">
                            <tds-input-number [(ngModel)]="data.Discount" [min]="0" [step]="1" [max]="100"
                              [formatter]="numberWithCommas" [parser]="parserComas"
                              *ngIf="data.Type === 'percent'"
                              (ngModelChange)="changeProductDiscountType(data, $event, 'Discount', i)"
                              [ngModelOptions]="{standalone: true}" [autoFocus]="focusField == 'Discount'">
                            </tds-input-number>
                            <tds-input-number [(ngModel)]="data.Discount_Fixed" [min]="0" [step]="1000" *ngIf="data.Type === 'fixed'"
                              [formatter]="numberWithCommas" [parser]="parserComas"
                              (ngModelChange)="changeProductDiscountType(data, $event, 'Discount_Fixed', i)"
                              [ngModelOptions]="{standalone: true}" [autoFocus]="focusField == 'Discount_Fixed'">
                            </tds-input-number>
                          </div>
                          <div class="flex items-center justify-between w-full">
                            <div class="flex items-center">
                              <button tds-button type="button" style="line-height: 19px;margin-right: 6px"
                                [color]="data.Type == 'percent' ? 'primary' : 'secondary'"
                                (click)="selectProductType(data, 'percent', i)"
                                [ngClass]="data.Type == 'percent' ? 'text-white' : 'text-neutral-1-900'"
                                class="text-body-2 font-regular">
                                <span class="flex items-center"> % </span>
                              </button>
                              <button tds-button type="button"
                                [color]="data.Type == 'fixed' ? 'primary' : 'secondary'"
                                (click)="selectProductType(data, 'fixed', i)"
                                [ngClass]="data.Type == 'fixed' ? 'text-white' : 'text-neutral-1-900'"
                                class="text-body-2 font-regular">
                                <span class="flex items-center"> VNĐ </span>
                              </button>
                            </div>
                            <div>
                              <button tds-button-icon type="button" color="error"
                                (click)="closeDiscountProductPopover(data)">
                                <i class="tdsi-close-fill"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </td>
                    <!-- Khối lượng -->
                    <td *ngIf="saleConfig?.SaleSetting?.GroupWeightPerSOLine == 1">{{ (data.Weight >= 0 ? (data.Weight * 1000)*(data.ProductUOMQty || 0) : 0) | numberCustom }}</td>
                    <td>{{ (data.PriceTotal || 0) | numberCustom }} đ</td>
                    <td [tdsRight]="true">
                      <div class="flex gap-x-2 justify-end">
                        <button tds-button-icon color="primary" size="sm" type="button" tds-tooltip="Sao chép"
                          (click)="copyOrderLine(data, i)">
                          <span class="flex items-center">
                            <i class="tdsi-copy-fill"></i>
                          </span>
                        </button>
                        <button tds-button-icon color="error" size="sm" type="button" tds-tooltip="Xóa"
                          (click)="removeOrderLines(data, i)">
                          <span class="flex items-center">
                            <i class="tdsi-trash-fill"></i>
                          </span>
                        </button>
                      </div>
                    </td>
                  </tr>
                  <tr class="hover:bg-white border-b-0">
                    <td colspan="9">
                      <div class="flex w-full justify-end">
                        <div class="w-[40%] flex justify-end">
                          <div class="w-full grid grid-cols-2 gap-2 text-right font-semibold">
                            <div><span class="font-regular">Tổng số lượng</span></div>
                            <div><span>{{totalQtyLines | numberCustom }}</span></div>

                            <div><span class="font-regular">Tổng tạm tính</span></div>
                            <div><span>{{totalAmountLines | numberCustom  }} đ</span></div>

                            <!-- Giảm giá -->
                            <div *ngIf="saleConfig?.SaleSetting?.GroupDiscountTotal">
                              <button tds-button color="secondary" type="button" tds-popover popoverTrigger="click"
                                (click)="openPopoverDiscount()" [(popoverVisible)]="visiblePopoverDiscount"
                                [popoverContent]="popoverContentDiscount" [popoverFooter]="popoverFooterDiscount"
                                [popoverAutoClose]="true" [popoverBackdrop]="true" popoverPlacement="left">
                                  <span class="flex items-center justify-center">
                                    <i class="tdsi-revenue-fill  text-neutral-1-500 text-lg leading-none mr-2"></i>
                                    Giảm giá
                                  </span>
                              </button>
                            </div>
                            <div *ngIf="saleConfig?.SaleSetting?.GroupDiscountTotal" class="flex items-center justify-end">
                              <span>{{(_form.controls["DecreaseAmount"].value + _form.controls["DiscountAmount"].value || 0) | numberCustom }} đ</span>
                            </div>

                            <!-- Thuế -->
                            <div *ngIf="saleConfig?.SaleSetting?.GroupFastSaleTax">
                              <button tds-button color="secondary" type="button" tds-popover popoverTrigger="click"
                                (click)="openPopoverTax()" [(popoverVisible)]="visiblePopoverTax"
                                [popoverContent]="popoverContentTax" [popoverFooter]="popoverFooterTax"
                                [popoverAutoClose]="true" [popoverBackdrop]="true" popoverPlacement="left">
                                <span class="flex items-center justify-center">
                                  <i class="tdsi-receipt-fill  text-neutral-1-500 text-lg leading-none mr-2"></i>
                                  Thuế
                                </span>
                              </button>
                            </div>

                            <div *ngIf="saleConfig?.SaleSetting?.GroupFastSaleTax" class="flex items-center justify-end">
                              <span>{{ (_form.controls["AmountTax"].value || 0) | numberCustom }}đ</span>
                              <span class="ml-1 mr-1"> - </span>
                              <span>{{ _form.controls["Tax"].value ? _form.controls["Tax"].value.Amount : 0 }}%</span>
                            </div>

                            <div *ngIf="saleConfig?.SaleSetting?.GroupFastSaleTax || saleConfig?.SaleSetting?.GroupDiscountTotal"><span>Tổng tiền</span></div>
                            <div *ngIf="saleConfig?.SaleSetting?.GroupFastSaleTax || saleConfig?.SaleSetting?.GroupDiscountTotal">
                              <span> {{ _form.controls["AmountTotal"].value | numberCustom }} đ</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </tds-table>

              <!-- popover button giảm giá -->
              <ng-template #popoverContentDiscount>
                <div class="w-[376px] grid grid-cols-3 gap-x-6 gap-y-2 text-body-2 to-neutral-1-900 font-semibold">
                  <div>
                    <span>Chiết khấu (%):
                      <span *ngIf="_form.controls['Discount'].value > 0">{{( _form.controls["DiscountAmount"].value) | numberCustom }}đ</span>
                    </span>
                  </div>
                  <div class="col-span-2">
                    <tds-input-number [min]="0" [max]="100" [step]="1" formControlName="Discount" [formatter]="numberWithCommas" [parser]="parserComas"
                      (ngModelChange)="changeDiscount($event)">
                    </tds-input-number>
                  </div>
                  <div>
                    <span>Tiền giảm:
                      <span *ngIf="_form.controls['DecreaseAmount'].value > 0">{{ _form.controls["DecreaseAmount"].value | numberCustom }}đ</span>
                    </span>
                  </div>
                  <div class="col-span-2">
                    <tds-input-number [min]="0" [step]="1000" formControlName="DecreaseAmount" [formatter]="numberWithCommas" [parser]="parserComas"
                      (ngModelChange)="changeDecreaseAmount($event)">
                    </tds-input-number>
                  </div>
                </div>
              </ng-template>
              <ng-template #popoverFooterDiscount>
                <div class="flex justify-end gap-x-2 mt-2">
                  <button tds-button-icon color="secondary" type="button" (click)="closePopoverDiscount()">
                    <span class="flex items-center">
                      <i class="tdsi-close-fill"></i>
                    </span>
                  </button>
                </div>
              </ng-template>

              <!-- popover button Thuế -->
              <ng-template #popoverContentTax>
                <div class="flex gap-x-2">
                  <!-- <button tds-button color="secondary" type="button" (click)="selectTax(null)" [color]="(_form.controls['Tax'].value ? _form.controls['Tax'].value.Amount : 0) == 0 ? 'primary' : 'secondary'">
                                        <span class="flex items-center">Không thuế</span>
                                    </button> -->
                  <button tds-button color="secondary" type="button" (click)="selectTax(tax)" *ngFor="let tax of lstTax"
                    [color]="(_form.controls['Tax'].value ? _form.controls['Tax'].value.Amount : 0) == tax.Amount ? 'primary' : 'secondary'">
                    <span class="flex items-center">{{tax.Name}}</span>
                  </button>
                  <button tds-button color="secondary" type="button" (click)="selectTax(null)" [color]="'secondary'">
                    <span class="flex items-center">Hủy thuế</span>
                  </button>
                </div>
              </ng-template>

              <ng-template #popoverFooterTax>
                <div class="flex justify-end gap-x-2 mt-2">
                  <button tds-button-icon color="secondary" type="button" (click)="closePopoverTax()">
                    <span class="flex items-center">
                      <i class="tdsi-close-fill"></i>
                    </span>
                  </button>
                </div>
              </ng-template>
            </div>
          </div>
      </div>
    </div>
  </form>
</tds-spin>
