<section *ngIf="data && team" class="chat-block text-body-2 text-neutral-1-900 w-full h-full flex flex-col">
    <div #chatHeader class="chat-header flex items-center p-2">
        <div class="flex flex-row justify-between items-center bg-white w-full rounded-xl p-3">
            <div class="flex flex-row items-center">
                <div class="avatar mr-2 relative">
                    <tpage-avatar-facebook [size]="48"
                    [noSeenMessage]="(type == 'all' && data.count_unread_activities > 0) || (type == 'message' && data.count_unread_messages > 0) || (type == 'comment' && data.count_unread_comments > 0)"
                      [shape]="'circle'" [psid]="data.psid"
                      [token]="team?.Facebook_PageToken">
                    </tpage-avatar-facebook>
                    <span *ngIf="getLastActivity()?.type == 2" class="absolute" style="top: 31px;left: 31px;">
                        <svg width="20" height="21" viewBox="0 0 26 27" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M1.6665 13.0152C1.6665 16.3866 3.04389 19.3288 5.30367 21.373L5.36031 23.2061C5.36031 23.2061 5.36031 23.2061 5.36031 23.2061C5.4008 24.5175 6.75463 25.3774 7.96053 24.845C7.96056 24.8449 7.96059 24.8449 7.96062 24.8449C7.96097 24.8448 7.96132 24.8446 7.96168 24.8444L10.0314 23.9321C11.076 24.2135 12.1824 24.3646 13.3332 24.3646C19.857 24.3646 24.9998 19.55 24.9998 13.0179C24.9998 6.4862 19.8573 1.66858 13.3332 1.66858C6.80934 1.66858 1.6665 6.4832 1.6665 13.0152Z" fill="url(#paint0_linear_11437_27281)" stroke="white" stroke-width="2"/>
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M16.4272 6.33233V8.49995L15.1407 8.5033C14.1322 8.5033 13.9379 8.98238 13.9379 9.68259V11.2338H16.3401L16.0285 13.6593H13.9379V19.9712H11.4323V13.6593H9.33466V11.2338H11.4323V9.44472C11.4323 7.36756 12.6983 6.23517 14.5544 6.23517C15.4392 6.23517 16.2027 6.30217 16.4272 6.33233Z" fill="white"/>
                            <defs>
                            <linearGradient id="paint0_linear_11437_27281" x1="8.04667" y1="4.43833" x2="18.8263" y2="22.09" gradientUnits="userSpaceOnUse">
                            <stop stop-color="#005BE6"/>
                            <stop offset="1" stop-color="#63A0FF"/>
                            </linearGradient>
                            </defs>
                        </svg>
                    </span>
                    <!-- icon message -->
                    <span *ngIf="getLastActivity()?.type == 3"  class="absolute" style="top: 31px;left: 31px;">
                        <svg width="20" height="21" viewBox="0 0 26 27" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M1.6665 13.0134C1.6665 16.3847 3.04389 19.327 5.30367 21.3711L5.36031 23.2042C5.36031 23.2042 5.36031 23.2042 5.36031 23.2042C5.4008 24.5156 6.75463 25.3755 7.96053 24.8431C7.96056 24.8431 7.96059 24.843 7.96062 24.843C7.96097 24.8429 7.96132 24.8427 7.96168 24.8426L10.0314 23.9302C11.076 24.2116 12.1824 24.3627 13.3332 24.3627C19.857 24.3627 24.9998 19.5481 24.9998 13.016C24.9998 6.48431 19.8573 1.66669 13.3332 1.66669C6.80934 1.66669 1.6665 6.48131 1.6665 13.0134Z" fill="url(#paint0_radial_11437_25390)" stroke="white" stroke-width="2" />
                            <path d="M6.92785 16.04L10.0612 11.0694C10.5598 10.2774 11.6265 10.0827 12.3758 10.6427L14.8692 12.512C15.0985 12.6827 15.4132 12.6827 15.6398 12.5094L19.0051 9.9547C19.4531 9.61336 20.0398 10.152 19.7411 10.6294L16.6052 15.5974C16.1065 16.3894 15.0398 16.584 14.2905 16.024L11.7972 14.1547C11.5678 13.984 11.2532 13.984 11.0265 14.1574L7.66118 16.712C7.21318 17.0534 6.62651 16.5174 6.92785 16.04Z" fill="white" />
                            <defs>
                            <radialGradient id="paint0_radial_11437_25390" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(6.77317 23.8838) scale(23.2448)">
                                <stop stop-color="#0099FF" />
                                <stop offset="0.317708" stop-color="#5364FF" />
                                <stop offset="0.6098" stop-color="#A033FF" />
                                <stop offset="0.9348" stop-color="#FF91AE" />
                                <stop offset="1" stop-color="#FFA399" />
                            </radialGradient>
                            </defs>
                      </svg>
                    </span>
                </div>
                <div class="user">
                    <label class="text-black text-title-1 font-semibold">{{data.name || data.partner_name}}</label>
                    <div class="flex flex-row">
                        <button
                            tds-button-flat-icon
                            color="primary"
                            trigger="click"
                            tds-dropdown
                            [tdsDropdownMenu]="menu2"
                            [placement]="'bottomRight'">
                            <span class="text-neutral-1-400 text-caption-1 font-regular pr-1">{{ data.assigned_to ? 'Đã gán cho' : 'Gán cuộc hội thoại' }}</span>
                            <span class="text-primary-1 text-caption-1 font-semibold pr-1">{{data.assigned_to ? data.assigned_to?.Name:''}}</span>
                            <i class="tdsi-arrow-down-line"></i>
                        </button>
                        <tds-dropdown-menu #menu2="tdsDropdownMenu">
                        <div class="w-72 max-h-80 overflow-hidden overflow-y-auto tds-custom-scroll py-2 gap-y-2 flex flex-col">
                            <div class="px-4">
                                <tds-form-field class="w-full">
                                    <input tdsInput placeholder="Tìm kiếm" autocomplete="off" [(ngModel)]="keyFilterUser" [ngModelOptions]="{standalone: true}" [tdsInputDebounce]="750" (inputKeyup)="searchUser()"/>
                                    <span tdsPrefix><i class="text-neutral-1-500 tdsi-search-fill"></i></span>
                                </tds-form-field>
                            </div>
                            <div *ngFor="let item of lstUser" (click)="assignUser(item)"
                                class="py-2 px-3 rounded-full cursor-pointer hover:bg-neutral-3-50 flex justify-between items-center" >
                                <div class="flex gap-x-2">
                                    <tds-avatar size="sm" [tdsSrc]="item.Avatar"></tds-avatar>
                                    <span>{{item.Name}}</span>
                                </div>
                                <span class="tdsi-success-fill text-success-500" *ngIf="item.Id == data.assigned_to?.Id"></span>
                            </div>
                        </div>
                        </tds-dropdown-menu>
                    </div>
                </div>
            </div>
            <div class="flex flex-row items-center">
                <button type="button" tds-button-flat-icon color="secondary" rounded="!rounded-full" class="mr-3" (click)="onProductLastV2()">
                    <img src="../../../assets/imagesv2/conversation/box-add.svg" width="21px" height="21px">
                </button>
                <button type="button" tds-button-flat-icon color="secondary" rounded="!rounded-full" class="mr-3" (click)="refreshRead()">
                    <i class="tdsi-reload-fill text-neutral-1-400"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- main -->
    <tds-spin class="flex-auto h-full w-full flex overflow-hidden" [color]="'secondary'" tip="Loading..." [spinning]="isLoadMessage">
        <div class="h-full w-full overflow-y-auto tds-custom-scroll flex flex-col relative delay-100"
            #scrollToIndex yiAutoScroll observe-attributes is-lock="true"
            lock-y-offset="40" scroll-end="true" (onScrollToTop)="loadPrevMessages()">

            <div class="absolute w-full flex justify-center z-10" *ngIf="isNextData">
                <tds-spinner [color]="'secondary'" class="mr-1 w-6 h-6"></tds-spinner>
            </div>

            <div *ngIf="(dataSource$ | async ) && (dataSource$ | async )?.items?.length == 0" class="h-full w-full flex items-center justify-center">
                <tds-empty notFoundContent="Không có nội dung"></tds-empty>
            </div>

            <div *ngIf="(dataSource$ | async ) && (dataSource$ | async )?.items">
              <ng-container *ngFor="let item of (dataSource$ | async)!.items | orderBy:'DateCreated':'asc' | showAvatar | scrollConversation: scrollToIndex as dataOrderBy; let i = index; trackBy: trackByIndex">
                  <div *ngIf="item" @eventFadeState>
                      <div *ngIf="item.is_show_break && i!= 0" class="w-full relative">
                          <div class="date-v3">
                              <span class="text-neutral-1-400 text-[13px]" [innerHTML]="item.DateCreated | yiDateTimeV3"></span>
                              <span class="hr"></span>
                          </div>
                      </div>
                      <!-- Thông tin bài post -->
                      <div *ngIf="item.type == 2 && item.object_id && (dataSource$ | async)?.extras!.posts[item?.object_id] &&
                          (i == 0 || !(i == 0 || (item.object_id == (dataOrderBy[i-1])?.object_id)))" class="px-2">
                          <div class="post-block mb-3 bg-white flex flex-col">
                              <div class="post-body flex flex-row justify-between p-4">
                                  <div class="post-content flex flex-col">
                                      <div class="post-type flex flex-row items-center mb-3">
                                          <tds-avatar
                                              [tdsSrc]="(dataSource$ | async)?.extras!.posts[item?.object_id]?.status_type=='added_video'?'../../../assets/imagesv2/conversation/live-circle.svg':'../../../assets/imagesv2/conversation/facebook-circle.svg'"
                                              [size]="24"
                                              [shape]="'circle'"
                                              [isAvatar]="false"
                                              class="mr-1">
                                          </tds-avatar>
                                          <tds-tag [status]="(dataSource$ | async)?.extras!.posts[item?.object_id]?.status_type=='added_video'?'error':'info'" type="outline" rounded="rounded-full">
                                              <span class="flex items-center py-0.5">
                                                  <span>{{(dataSource$ | async)?.extras!.posts[item?.object_id]?.created_time | date: "dd-MM-yyyy HH:mm"}}</span>
                                              </span>
                                          </tds-tag>
                                      </div>
                                      <div class="post-item">
                                          <div class="w-full block">
                                              <p class="story font-semibold" *ngIf="(dataSource$ | async)?.extras!.posts[item?.object_id]?.story">
                                                  {{(dataSource$ | async)?.extras!.posts[item?.object_id].story}}
                                              </p>
                                              <div class="message font-regular" *ngIf="(dataSource$ | async)?.extras!.posts[item?.object_id]?.message">
                                                  <div [innerHTML]="(dataSource$ | async)?.extras!.posts[item?.object_id].message | safeHtml"></div>
                                              </div>
                                              <p class="description" *ngIf="(dataSource$ | async)?.extras!.posts[item?.object_id]?.description">{{(dataSource$ | async)?.extras!.posts[item?.object_id].description}}</p>
                                          </div>
                                      </div>
                                  </div>
                                  <div class="post-picture" *ngIf="(dataSource$ | async)?.extras!.posts[item?.object_id]?.picture && !checkPostPictureError(item)">
                                      <img tds-image (error)="errorPostPicture(item)"
                                          [tdsSrc]="(dataSource$ | async)?.extras!.posts[item?.object_id].picture"
                                          alt="{{(dataSource$ | async)?.extras!.posts[item?.object_id]?.story}}" class="rounded-xl"/>
                                  </div>
                              </div>
                              <div class="post-footer bg-neutral-3-50 text-neutral-1-600 font-regular flex flex-row items-center justify-between py-1 px-4">
                                  <div class="emotion-count flex flex-row items-center">
                                      <div class="flex flex-row mr-1">
                                          <img src="../../../assets/imagesv2/conversation/like-circle.svg" width="20px" height="20px"
                                              class="rounded-full z-50">
                                          <img src="../../../assets/imagesv2/conversation/love-circle.svg" width="20px" height="20px"
                                              class="rounded-full z-40 -ml-2">
                                      </div>
                                      <span>
                                          {{(dataSource$ | async)?.extras!.posts[item?.object_id]?.count_reactions || 0}}
                                      </span>
                                  </div>
                                  <div class="comment flex flex-row items-center">
                                      <span class="comment-count  mr-4">
                                          {{(dataSource$ | async)?.extras!.posts[item?.object_id]?.count_comments || 0}} Bình luận
                                      </span>
                                      <div class="comment-button">
                                          <button tds-button-flat-icon color="secondary" class="mr-4"
                                              (click)="openPost(item, 'all')">
                                              <i class="tdsi-chart-pie-fill text-xl"></i>
                                          </button>
                                          <button tds-button-flat-icon color="secondary" class="mr-4"
                                              (click)="openPost(item, 'post')">
                                              <i class="tdsi-expand-line text-xl"></i>
                                          </button>
                                          <button tds-button-flat-icon color="secondary">
                                              <a href="https://www.facebook.com/{{item.id}}" target="_blank">
                                                  <i class="tdsi-search-line text-xl"></i>
                                              </a>
                                          </button>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                      <ng-container *ngIf="item && (data.psid || item.psid) && type && team">
                        <tds-conversation-item
                            [team]="team" [psid]="data.psid || item.psid"
                            [data]="item" [index]="i"
                            [type]="type" [partner]="partner"
                            [name]="data.name"
                            [children]="(dataSource$ | async)?.extras!.children[item?.id]">
                        </tds-conversation-item>
                      </ng-container>
                  </div>
              </ng-container>
            </div>
        </div>
    </tds-spin>

    <!-- footer  -->
    <div #chatFooter class="chat-footer w-full flex flex-col px-2 pb-3">
        <div class="w-full pt-2 pb-3 flex items-center gap-x-2">
            <div class="flex gap-x-2.5">
                <tds-avatar tds-popover
                    [popoverContent]="popoverContentOptionSendMessages"
                    popoverTrigger="click"
                    [popoverPlacement]="['topLeft', 'leftTop']"
                    class="bg-white text-neutral-1-400 cursor-pointer" icon="tdsi-three-dots-horizon-fill">
                </tds-avatar>
                <ng-template #popoverContentOptionSendMessages>
                    <div class="w-[336px] flex flex-col gap-y-3">
                        <span class="font-semibold text-title-1">Tuỳ chọn gửi tin nhắn</span>
                        <div class="w-full flex justify-between">
                        <span class="text-neutral-1-400">Nhấn [Enter] để gửi</span>
                        <tds-switch size="md" (change)="changeEnterSend($event)" [checked]="isEnterSend"></tds-switch>
                        </div>
                    </div>
                </ng-template>
                <tds-avatar tds-popover
                    [popoverContent]="popoverContentTagConversat"
                    popoverTrigger="click"
                    [popoverVisible]="isVisbleTag"
                    (popoverVisibleChange)="callbackTag($event)"
                    [popoverPlacement]="['topLeft', 'leftTop']"
                    class="bg-white text-neutral-1-400 cursor-pointer" icon="tdsi-tag-fill">
                </tds-avatar>
                <ng-template #popoverContentTagConversat>
                    <div class="w-[336px] max-h-[500px] flex flex-col gap-y-3">
                        <div class="flex justify-between">
                            <span class="font-semibold text-title-1">Gắn nhãn hội thoại</span>
                            <button tds-button-icon color="secondary" class="!rounded-full"
                                (click)="showModalAddTag()"
                                tds-tooltip
                                tooltipTitle="Thêm nhãn mới">
                                <span class="flex items-center">
                                    <i class="tdsi-plus-fill"></i>
                                </span>
                            </button>
                        </div>
                        <tds-form-field class="w-full">
                            <input tdsInput placeholder="Tìm kiếm nhãn" autocomplete="off" [(ngModel)]="keyFilterTag" [ngModelOptions]="{standalone: true}" [tdsInputDebounce]="750" (inputKeyup)="searchTag()"/>
                            <span tdsPrefix><i class="text-neutral-1-500 tdsi-search-fill"></i></span>
                        </tds-form-field>
                        <div class="flex-auto flex flex-wrap gap-2.5 overflow-hidden overflow-y-auto tds-custom-scroll">
                            <span *ngFor="let item of lstOfTag" (click)="onSelectTag(item)"
                                class="cursor-pointer px-2 py-0.5 rounded text-white text-caption-2 font-semibold flex items-center gap-x-2 hover:opacity-100"
                                [ngClass]="data?.keyTags && data?.keyTags[item.Id]?'tdsi-tick-fill opacity-100':'opacity-40'"
                                [ngStyle]="{'background-color': [item.ColorClassName]}" >
                                <span class="font-sans">{{item.Name}}</span>
                            </span>
                        </div>
                    </div>
                </ng-template>
            </div>
            <div class="flex-auto flex gap-2.5 ">
                <div *ngFor="let item of data.tags | slice:0:6" (click)="onRemoveTag(item)" class="relative group text-caption-2 flex items-center max-w-[96px] truncate">
                    <div class="cursor-pointer w-full px-3 py-1 rounded-md font-semibold text-white text-center truncate group-hover:opacity-10"
                        [ngStyle]="{'background-color': [item.color_class]}">
                        {{item.name}}
                    </div>
                    <button
                        class="group-hover:text-accent-3 font-semibold absolute group-hover:flex w-full items-center justify-center hidden truncate">
                        Gỡ nhãn
                    </button>
                </div>
                <div class="px-1 py-0.5 text-info-500 bg-[#E5F2FF] text-caption-2 rounded cursor-pointer" *ngIf="data.tags && data.tags.length - 6 > 0" tds-popover
                    [popoverContent]="popoverContentTag"
                    popoverPlacement="topRight">
                    +{{data.tags.length - 6}}
                </div>
                <ng-template #popoverContentTag>
                    <div class="flex gap-1 flex-wrap items-center max-w-[336px]">
                        <div *ngFor="let tag of data.tags |  slice:6:data.tags.length" (click)="onRemoveTag(tag)" class="relative group flex items-center text-caption-2 font-regular text-neutral-1-900 rounded truncate">
                            <div class="cursor-pointer w-full px-3 py-1 rounded-md font-semibold text-white text-center truncate group-hover:opacity-10"
                            [ngStyle]="{'background-color': [tag.color_class]}">
                            {{tag.name}}
                        </div>
                        <button
                            class="group-hover:text-accent-3 font-semibold absolute group-hover:flex w-full items-center justify-center hidden truncate">
                            Gỡ nhãn
                        </button>
                        </div>
                    </div>
                </ng-template>
            </div>
        </div>
        <!-- editer+toolbars -->
        <tds-spin [spinning]="isLoadingImage">
        <div class="flex flex-col w-full px-4 bg-white rounded-xl relative">
            <div [ngClass]="isLoadingSendMess?'!cursor-wait':'hidden'" class="absolute top-0 left-0 z-10 w-full h-full opacity-100">
            </div>
            <!-- upload-wall -->
            <div [ngClass]="uploadedImages.length>0?'translate-y-0 py-4 border-b':'translate-y-full h-0 '"
                class=" border-neutral-2-300 ease-in-out duration-300 max-h-40 overflow-hidden flex">
                <div class="overflow-hidden overflow-y-auto tds-custom-scroll flex justify-between w-full h-full">
                    <upload-pictures-wall
                    [isArray]="true"
                    [data]="uploadedImages"
                    (onLoadImage)="onLoadImage($event)">
                    </upload-pictures-wall>
                    <div class="p-1">
                        <button tds-button-icon color="secondary" size="sm" class="!rounded-full" (click)="closeImages()">
                            <span class="flex items-center">
                                <i class="tdsi-close-fill"></i>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="w-full pt-4 flex flex-row">
                <textarea tdsInput placeholder="Nhập nội dung tin nhắn, nhấn [Enter] để gửi"
                    [(ngModel)]="messageModel" [ngModelOptions]="{standalone: true}"
                    (keydown.enter)="onEnter($event)" class="h-16 resize-none !p-0 !m-0 no-scrollbar">
                </textarea>
                <div>
                    <button tds-button type="button" color="primary" class="!rounded-full ml-2" [size]="'lg'"(click)="onClickSender()">
                        <span class="flex items-center px-6">
                            <i class="tdsi-send-fill text-lg leading-none mr-2"></i> Gửi
                        </span>
                    </button>
                </div>
            </div>
            <!-- toolbar -->
            <div class="w-full flex justify-end items-center">
                <a class="p-2" type="button" (click)="sendIconLike()">
                    <div class="tdsi-like-line text-neutral-1-400 text-xl cursor-pointer"></div>
                </a>
                <a class="tdsi-emotion-line text-neutral-1-400 text-xl cursor-pointer p-2" type="button"
                    tds-popover popoverTrigger="click"
                    [popoverContent]="infoEmojiMart"
                    [popoverAutoClose]="true"
                    [popoverBackdrop]="true"
                    popoverPlacement="top">
                    <ng-template #infoEmojiMart>
                        <div (loadEmojiMart)="loadEmojiMart($event)" icon-emoji-mart></div>
                    </ng-template>
                </a>
                <tds-upload
                    (uploadChange)="handleChange($event)"
                    listType="picture"
                    [customRequest]="handleUpload"
                    [showUploadList]="false">
                    <a type="button"
                    [ngClass]="displayDropZone?'absolute w-full h-full inset-0 bg-white border-dashed border-2 border-primary-1 rounded-xl z-50 flex justify-center items-center':''"
                    class="p-2" title="Hình ảnh">
                        <div *ngIf="!displayDropZone; else dropZone"
                        class="tdsi-image-line text-neutral-1-400 text-xl cursor-pointer">
                        </div>
                        <ng-template #dropZone>
                            <div class="flex flex-col gap-y-2.5 items-center">
                                <span class="text-header-1 text-primary-1 font-semibold">Xem trước khi gửi</span>
                                <span class="text-body-1 text-neutral-1-500">Thả ảnh vào đây để xem trước khi gửi</span>
                            </div>
                        </ng-template>
                  </a>
                </tds-upload>

                <div class="p-2">
                    <div class="tdsi-product-line text-neutral-1-400 text-xl cursor-pointer"></div>
                </div>
                <div class="p-2">
                    <quick-reply-button (onQuickReplySelected)="onQuickReplySelected($event)"></quick-reply-button>
                </div>
                <div class="p-2">
                    <div class="tdsi-paper-fill text-neutral-1-400 text-xl cursor-pointer" (click)="showModalListBill()"></div>
                </div>
                <div class="p-2">
                    <div class="tdsi-images-fill text-neutral-1-400 text-xl cursor-pointer" (click)="showImageStore()"></div>
                </div>
            </div>
        </div>
        </tds-spin>
    </div>
</section>


