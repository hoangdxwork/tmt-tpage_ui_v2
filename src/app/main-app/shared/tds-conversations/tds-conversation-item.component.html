<div *ngIf="data && team" class="px-2">
	<!--Lọc theo Messages-->
	<div *ngIf="data.type != 2" class="{{data.is_admin ? 'is_admin' : 'is_client'}}">
      <div class="chat-body w-full">
          <div *ngIf="!data.is_admin" class="mr-2">
              <tpage-avatar-facebook [shape]="'circle'" [size]="36"
                [psid]="data.from_id" [token]="team?.Facebook_PageToken">
              </tpage-avatar-facebook>
          </div>

          <!-- Tin nhắn văn bản -->
          <div *ngIf="data.message_formatted" class="message-inner {{data.error_message ? 'error' : ''}}"
              tds-tooltip tooltipTitle="{{data.DateCreated | yiDateTimeFormat}}">
              <div [innerHTML]="data.message_formatted | formatIconLike | safeHtml" #contentMessage></div>
          </div>

          <!-- Tin nhắn hình ảnh -->
          <div *ngIf="data.message?.attachments">
            <div *ngFor="let att of data.message.attachments.data">
                <a *ngIf="att.image_data" (click)="open_gallery(send_picture, att)">
                    <show-attachment [type]="att.mime_type" [url]="att.image_data?.url" (onError)="isErrorAttachment(att, data)">
                    </show-attachment>
                </a>
                <a *ngIf="att.video_data" (click)="open_gallery(send_picture, att)">
                    <show-attachment [type]="att.mime_type" [url]="att.video_data?.url"  (onError)="isErrorAttachment(att, data)"
                       [width]="'320px'" [height]="'240px'" [isMuted]="false"></show-attachment>
                </a>
                <a *ngIf="att.file_url" container="body" (click)="open_gallery(send_picture, att)">
                    <show-attachment [type]="att.mime_type" [url]="att.file_url" (onError)="isErrorAttachment(att, data)">
                    </show-attachment>
                </a>
                <a *ngIf="isErrorAttachment(att, data)" tds-tooltip tooltipTitle="Ảnh đã hết hạn" (click)="refreshAttachment(att)"></a>
            </div>
          </div>

          <!-- Tin nhắn không tải được -->
          <div *ngIf="!data.message_formatted && !data.message?.attachments" class="message-inner !text-accent-3 !bg-accent-3 !bg-opacity-20"
            tds-tooltip tooltipTitle="{{data.DateCreated | yiDateTimeFormat}}">
              Không tải được tin nhắn! </div>

          <!-- Tin nhắn lỗi -->
          <div *ngIf="data.error_message || data.status == enumActivityStatus.fail" class="select-message">
              <a *ngIf="!checkErrorMessage(data.error_message)" tds-tooltip tooltipTitle="{{data.error_message}}">
                  <span class="tdsi-info-line" ></span>
              </a>
              <a *ngIf="checkErrorMessage(data.error_message)" tds-tooltip tooltipTitle="{{data.error_message}}" (click)="retryMessage()">
                  <span class="tdsi-reload-fill"></span>
              </a>
          </div>

          <!-- Chọn số điện thoại, địa chỉ, ghi chú -->
          <div *ngIf="!data.message?.attachments" class="select-icon">
            <div class="select-order flex flex-row items-center w-fit h-full px-3">
				<span tds-tooltip tooltipTitle="Chọn làm số điện thoại"
					class="h-5 w-5 bg-green-400 flex items-center justify-center rounded-md cursor-pointer mr-1.5"
					(click)="selectOrder('phone')">
					<i class="tdsi-call-fill text-xs text-white"></i>
				</span>
				<span tds-tooltip tooltipTitle="Chọn làm địa chỉ"
					class="h-5 w-5 bg-orange-500 flex items-center justify-center rounded-md cursor-pointer mr-1.5"
					(click)="selectOrder('address')">
					<i class="tdsi-pin-fill text-xs text-white"></i>
				</span>
				<span tds-tooltip tooltipTitle="Chọn làm ghi chú"
					class="h-5 w-5 bg-blue-500 flex items-center justify-center rounded-md cursor-pointer"
					(click)="selectOrder('note')">
					<i class="tdsi-note-2-fill text-xs text-white"></i>
				</span>
			</div>
          </div>
      </div>

      <!-- Đang gửi -->
      <span *ngIf="data.status == enumActivityStatus.sending" class="chat-by mr-2">
          <span class="tdsi-send-fill"></span> Đang gửi...
      </span>
      <!-- Người gửi -->
      <span *ngIf="data.CreatedBy && data.status != enumActivityStatus.sending" class="chat-by">
          Được gửi bởi <span class="text-info-500"> {{data.CreatedBy.Name}}</span>
      </span>
  </div>

	<!--Lọc theo comments-->
	<div *ngIf="data.comment" class="log-comment w-full mb-3 {{ data.is_admin ? 'is_admin' : 'is_client' }}">
		<div class="w-full flex flex-row">
			<!-- Avatar Facebook_PageId -->
			<div class="mr-2">
          <tpage-avatar-facebook [shape]="'circle'" [size]="36"
            [psid]="!data.is_admin ? data.from_id : team.Facebook_PageId" [token]="team?.Facebook_PageToken">
          </tpage-avatar-facebook>
			</div>
			<!-- comment block -->
			<div class="flex flex-col w-full commnent-block">
				<!--Chat chỉ gửi hình ảnh-->
				<div *ngIf="data.Image" class="img-outer">
					<img tds-image [tdsSrc]="data.Image" class="img-responsive img-thumbnail">
				</div>
				<!-- Hình ảnh -->
				<div *ngIf="data.comment?.attachment" class="pb-2 w-full">
					<img tds-image *ngIf="data.comment.attachment.type != 'sticker'"
						[tdsSrc]="data.comment.attachment.media.image.src" />
					<img tds-image *ngIf="data.comment.attachment.type == 'sticker'"
						[tdsSrc]="data.comment.attachment.media.image.src" />
				</div>
				<div class="inline-flex w-fit chat-main-block group">
					<!-- Nội dung bình luận -->
					<div class="chat-body w-full !m-0" tds-tooltip
						tooltipTitle="{{data.DateCreated | date:'dd'}}/{{data.DateCreated | date:'MM'}} {{data.DateCreated | date:'HH:mm'}}">
						<div class="chat-content bg-white px-4 py-2 rounded-b-xl rounded-r-xl">
							<div class="flex flex-auto">
								<!--Nội dung-->
								<div *ngIf="data.message_formatted">
									<div class="name font-semibold pb-1">{{data.comment.from.name}}</div>
									<div class="content-message font-regular" #contentMessage>{{data.comment.message}}
									</div>
								</div>
							</div>
						</div>
					</div>
					<!-- Lỗi gửi tin -->
					<div *ngIf="data.error_message || data.status == enumActivityStatus.fail">
						<span class="tdsi-information-fill" title="{{data.error_message}}"></span>
					</div>
					<!-- Thao tác -->
					<div *ngIf="!data.message?.attachments" class="chat-option invisible group-hover:visible">
						<div class="select-order flex flex-row items-center w-fit h-full pl-3">
							<span tds-tooltip tooltipTitle="Chọn làm số điện thoại"
								class="h-5 w-5 bg-green-400 flex items-center justify-center rounded-md cursor-pointer mr-1.5"
								(click)="selectOrder('phone')">
								<i class="tdsi-call-fill text-xs text-white"></i>
							</span>
							<span tds-tooltip tooltipTitle="Chọn làm địa chỉ"
								class="h-5 w-5 bg-orange-500 flex items-center justify-center rounded-md cursor-pointer mr-1.5"
								(click)="selectOrder('address')">
								<i class="tdsi-pin-fill text-xs text-white"></i>
							</span>
							<span tds-tooltip tooltipTitle="Chọn làm ghi chú"
								class="h-5 w-5 bg-blue-500 flex items-center justify-center rounded-md cursor-pointer"
								(click)="selectOrder('note')">
								<i class="tdsi-note-2-fill text-xs text-white"></i>
							</span>
						</div>
					</div>
				</div>
				<!--Thích hiện ẩn + CreatedBy.Name-->
				<div class="chat-meta bg-transparent text-neutral-1-600 text-caption-2 font-regular mt-1.5">
					<div class="chat-acts flex flex-row items-center" style="position: relative;">
						<button class="link-act hover:underline" [disabled]="isReplyingComment"
							(click)="clickReply(data.comment ? data.comment.can_remove : null)">
							Phản hồi
						</button>
						<tds-spinner *ngIf="isReplyingComment" [color]="'primary'" class="ml-1 w-2 h-2"></tds-spinner>
						<div class="h-1 w-1 bg-neutral-1-300 rounded-full mx-2.5"></div>
						<button class="link-act hover:underline" [disabled]="isLiking"
							(click)="addLike(data.comment ? data.comment.can_like : null)">
							{{data.comment.user_likes ? 'Đã thích' : 'Thích'}}
						</button>
						<tds-spinner *ngIf="isLiking" [color]="'primary'" class="ml-1 w-2 h-2"></tds-spinner>
						<div class="h-1 w-1 bg-neutral-1-300 rounded-full mx-2.5"></div>
						<button class="link-act hover:underline" [disabled]="isHiding"
							(click)="hideComment(data.comment ? data.comment.can_hide: null)">
							{{data.comment.is_hidden ? 'Hiện' : 'Ẩn'}}
						</button>
						<tds-spinner *ngIf="isHiding" [color]="'primary'" class="ml-1 w-2 h-2"></tds-spinner>
						<div class="h-1 w-1 bg-neutral-1-300 rounded-full mx-2.5"></div>
						<span *ngIf="data.DateCreated" class="date-diff cursor-pointer hover:underline" tds-tooltip
							tooltipTitle="{{data.DateCreated | date:'dd'}} Tháng {{data.DateCreated | date:'MM'}}, {{data.DateCreated | date:'yyyy'}} lúc {{data.DateCreated | date:'HH:mm'}}">
							{{data.DateCreated | yiDiffDateTime}}
						</span>
					</div>
					<span class="chat-by font-regular" *ngIf="data.IsHandledBySystem && data.CreatedBy"> Được gửi bởi
						<span class="font-semibold" style="color: #03468b;">{{data.CreatedBy.Name}}</span>
					</span>
				</div>
				<!-- Input trả lời bình luận -->
				<div class="chat-reply flex flex-col gap-y-5 bg-white rounded-xl w-full p-4 mt-4 border-b-2 border-primary-1" *ngIf="isReply == true">
					<div class="flex flex-row w-full">
						<textarea id="inputReply" #contentReply tdsInput placeholder="Nhập nội dung trả lời"
							[(ngModel)]="messageModel" [ngModelOptions]="{standalone: true}"
							class="w-full resize-none !p-0 !m-0" (keydown.enter)="onEnter($event)"></textarea>
						<div class="">
							<button tds-button type="button" color="primary" class="!rounded-full" [size]="'lg'" (click)="messageSendingToServer()">
								<span class="flex items-center px-5">
									<i class="tdsi-send-fill text-lg leading-none mr-2"></i> Gửi
								</span>
							</button>
						</div>
					</div>
					<!-- Check Private Reply -->
					<div class="quick-message gap-5">
						<div class="check gap-5 flex justify-between">
							<tds-checkbox [checked]="isPrivateReply" (change)="changeIsPrivateReply()">
								Gửi về tin nhắn
							</tds-checkbox>
							<div class="icon-send flex flex-row mr-2">
								<span class="sub cursor-pointer mr-2" container="body" placement="auto" tds-popover
									popoverTrigger="click" [popoverContent]="infoEmojiMart" [popoverAutoClose]="true"
									[popoverBackdrop]="true" popoverPlacement="top">
									<i class="tdsi-emotion-line text-xl"></i>
									<ng-template #infoEmojiMart>
										<div (loadEmojiMart)="loadEmojiMart($event)" icon-emoji-mart></div>
									</ng-template>
								</span>

								<span class="sub cursor-pointer mr-2" *ngIf="isPrivateReply"
									(onProductSelected)="onProductSelected($event)" title="Sản phẩm"
									product-show-button>
									<i class="tdsi-product-line text-xl"></i>
								</span>


								<span class="sub cursor-pointer" (onQuickReplySelected)="onQuickReplySelected($event)"
									title="Tin nhắn nhanh" placement="left" quick-reply-button>
									<i class="tdsi-message-template-line text-xl"></i>
								</span>
							</div>
						</div>
					</div>
				</div>
				<!-- Phản hồi bình luận -->
				<div *ngIf="children" class="chat-list">
					<div class="chat-item mt-4 chat-comment flex flex-row"
						*ngFor="let child of children; let i = index">
						<div class="avatar mr-2">
							<tpage-avatar-facebook [shape]="'circle'" [size]="36" [psid]="child.from.id"
								[token]="team?.Facebook_PageToken">
							</tpage-avatar-facebook>
						</div>
						<div class="flex flex-col w-full">
							<div class="inline-flex w-fit group">
								<div class="chat-body !m-0" tds-tooltip
									tooltipTitle="{{child.created_time | date:'dd'}}/{{child.created_time | date:'MM'}} {{child.created_time | date:'HH:mm'}}">
									<div class="chat-content flex-auto bg-white px-4 py-2 rounded-b-xl rounded-r-xl">
										<div class="border-activety-comment" *ngIf="child.message_format">
											<div class="name font-semibold pb-1">{{child.from.name}}</div>
											<div class="content-message font-regular"
												[innerHTML]="child.message_format | safeHtml"></div>
										</div>
										<div class="border-activety-comment" *ngIf="!child.message_format">
											<div class="name font-semibold pb-1">{{child.from.name}}</div>
											<div class="content-message font-regular">{{child.message}}</div>
										</div>
									</div>
								</div>
								<div *ngIf="!child.message?.attachments"
									class="chat-option invisible group-hover:visible">
									<div class="select-order flex flex-row items-center w-fit h-full pl-3">
										<span tds-tooltip tooltipTitle="Chọn làm số điện thoại"
											class="h-5 w-5 bg-green-400 flex items-center justify-center rounded-md cursor-pointer mr-1.5"
											(click)="selectOrder('phone')">
											<i class="tdsi-call-fill text-xs text-white"></i>
										</span>
										<span tds-tooltip tooltipTitle="Chọn làm địa chỉ"
											class="h-5 w-5 bg-orange-500 flex items-center justify-center rounded-md cursor-pointer mr-1.5"
											(click)="selectOrder('address')">
											<i class="tdsi-pin-fill text-xs text-white"></i>
										</span>
										<span tds-tooltip tooltipTitle="Chọn làm ghi chú"
											class="h-5 w-5 bg-blue-500 flex items-center justify-center rounded-md cursor-pointer"
											(click)="selectOrder('note')">
											<i class="tdsi-note-2-fill text-xs text-white"></i>
										</span>
									</div>
								</div>
							</div>
							<div class="chat-meta text-neutral-1-600 text-caption-2 font-regular mt-1.5"
								style="position: relative;">
								<div class="chat-acts flex flex-row items-center" style="position: relative;">
									<span *ngIf="child.created_time" class="date-diff cursor-pointer hover:underline"
										tds-tooltip
										tooltipTitle="{{child.created_time | date:'dd'}} Tháng {{child.created_time | date:'MM'}}, {{child.created_time | date:'yyyy'}} lúc {{child.created_time | date:'HH:mm'}}">
										{{child.created_time | yiDiffDateTime}}
									</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!--Lọc theo comments v2 -->
	<div *ngIf="!data.comment && data.type == 2"
		class="log-comment-v2 w-full mb-3 flex {{ data.is_admin ? 'is_admin' : 'is_client' }} ">
		<div class="w-full flex flex-row">
			<!-- Avatar Facebook_PageId -->
			<div class="mr-2">
				<tpage-avatar-facebook [shape]="'circle'" [size]="'lg'"
					[psid]="!data.is_admin ? data.from_id : team.Facebook_PageId" [token]="team?.Facebook_PageToken">
				</tpage-avatar-facebook>
			</div>
			<!--Nội dung bình luận-->
			<div class="flex flex-col w-full commnent-block">
				<!--Chat chỉ gửi hình ảnh-->
				<div *ngIf="data.Image" class="img-outer">
					<img tds-image [tdsSrc]="data.Image" class="img-responsive img-thumbnail">
				</div>
				<div class="inline-flex w-fit chat-main-block group">
					<!--Nội dung-->
					<div class="chat-body w-full !m-0" tds-tooltip
						tooltipTitle="{{data.DateCreated | date:'dd'}}/{{data.DateCreated | date:'MM'}} {{data.DateCreated | date:'HH:mm'}}">
						<div class="chat-content bg-white px-4 py-2 rounded-b-xl rounded-r-xl">
							<div *ngIf="data.message_formatted">
								<span class="text-error-400">Lỗi hiển thị bài viết</span>
								<div #contentMessage class="content-message"
									[innerHTML]="data.message_formatted | formatIconLike | safeHtml"></div>
							</div>
							<div class="" *ngIf="!data.message_formatted">
								<div class="content-message" #contentMessage>
									{{data.message_formatted | formatIconLike | safeHtml}}
								</div>
							</div>
						</div>
					</div>
					<!-- Lỗi gửi tin -->
					<div *ngIf="data.error_message || data.status == enumActivityStatus.fail">
						<span class="tdsi-information-fill" title="{{data.error_message}}"></span>
					</div>
					<!-- Thao tác -->
					<div *ngIf="!data.message?.attachments" class="chat-option invisible group-hover:visible">
						<div class="select-order flex flex-row items-center w-fit h-full pl-3">
							<span tds-tooltip tooltipTitle="Chọn làm số điện thoại"
								class="h-5 w-5 bg-green-400 flex items-center justify-center rounded-md cursor-pointer mr-1.5"
								(click)="selectOrder('phone')">
								<i class="tdsi-call-fill text-xs text-white"></i>
							</span>
							<span tds-tooltip tooltipTitle="Chọn làm địa chỉ"
								class="h-5 w-5 bg-orange-500 flex items-center justify-center rounded-md cursor-pointer mr-1.5"
								(click)="selectOrder('address')">
								<i class="tdsi-pin-fill text-xs text-white"></i>
							</span>
							<span tds-tooltip tooltipTitle="Chọn làm ghi chú"
								class="h-5 w-5 bg-blue-500 flex items-center justify-center rounded-md cursor-pointer"
								(click)="selectOrder('note')">
								<i class="tdsi-note-2-fill text-xs text-white"></i>
							</span>
						</div>
					</div>
				</div>
				<!--Thích hiện ẩn + CreatedBy.Name-->
				<div class="chat-meta bg-transparent text-neutral-1-600 text-caption-2 font-regular mt-1.5">
					<div class="chat-acts flex flex-row items-center" style="position: relative;">
						<span *ngIf="data.DateCreated" class="date-diff cursor-pointer hover:underline" tds-tooltip
							tooltipTitle="{{data.DateCreated | date:'dd'}} Tháng {{data.DateCreated | date:'MM'}}, {{data.DateCreated | date:'yyyy'}} lúc {{data.DateCreated | date:'HH:mm'}}">
							{{data.DateCreated | yiDiffDateTime}}
						</span>
					</div>
					<span class="chat-by font-regular" *ngIf="data.IsHandledBySystem && data.CreatedBy"> Được gửi bởi
						<span class="font-semibold" style="color: #03468b;">{{data.CreatedBy.Name}}</span>
					</span>
				</div>
				<!-- Input trả lời bình luận -->
				<div class="chat-reply flex flex-col gap-y-5 bg-white rounded-xl w-full p-4 mt-4 border-b-2 border-primary-1" *ngIf="isReply == true">
					<div class="flex flex-row w-full">
						<textarea id="inputReply" #contentReply tdsInput placeholder="Nhập nội dung trả lời"
						[(ngModel)]="messageModel" [ngModelOptions]="{standalone: true}"
							class="w-full resize-none !p-0 !m-0" (keydown.enter)="onEnter($event)"></textarea>
						<div class="">
							<button tds-button type="button" color="primary" class="!rounded-full" [size]="'lg'" (click)="messageSendingToServer()">
								<span class="flex items-center px-5">
									<i class="tdsi-send-fill text-lg leading-none mr-2"></i> Gửi
								</span>
							</button>
						</div>
					</div>
					<!-- Check Private Reply -->
					<div class="quick-message  gap-5">
						<div class="check gap-5 flex justify-between">
							<tds-checkbox [checked]="isPrivateReply" (change)="changeIsPrivateReply()">
								Gửi về tin nhắn
							</tds-checkbox>
							<div class="icon-send flex flex-row mr-2">
								<span class="sub cursor-pointer mr-2" container="body" placement="auto" tds-popover
									popoverTrigger="click" [popoverContent]="infoEmojiMart" [popoverAutoClose]="true"
									[popoverBackdrop]="true" popoverPlacement="top">
									<i class="tdsi-emotion-line text-xl"></i>
									<ng-template #infoEmojiMart>
										<div (loadEmojiMart)="loadEmojiMart($event)" icon-emoji-mart></div>
									</ng-template>
								</span>

								<span class="sub cursor-pointer mr-2" *ngIf="isPrivateReply"
									(onProductSelected)="onProductSelected($event)" title="Sản phẩm"
									product-show-button>
									<i class="tdsi-product-line text-xl"></i>
								</span>

								<span class="sub cursor-pointer" (onQuickReplySelected)="onQuickReplySelected($event)"
									title="Tin nhắn nhanh" placement="left" quick-reply-button>
									<i class="tdsi-message-template-line text-xl"></i>
								</span>
							</div>
						</div>
					</div>
				</div>
				<!-- Phản hồi bình luận -->
				<div *ngIf="children" class="chat-list">
					<div class="chat-item mt-4 chat-comment flex flex-row"
						*ngFor="let child of children; let i = index">
						<div class="avatar mr-2">
							<tpage-avatar-facebook [shape]="'circle'" [size]="36" [psid]="child.from.id"
								[token]="team?.Facebook_PageToken">
							</tpage-avatar-facebook>
						</div>
						<div class="flex flex-col w-full">
							<div class="inline-flex w-fit group">
								<div class="chat-body !m-0" tds-tooltip
									tooltipTitle="{{child.created_time | date:'dd'}}/{{child.created_time | date:'MM'}} {{child.created_time | date:'HH:mm'}}">
									<div class="chat-content flex-auto bg-white px-4 py-2 rounded-b-xl rounded-r-xl">
										<div class="border-activety-comment" *ngIf="child.message_format">
											<div class="name font-semibold pb-1">{{child.from.name}}</div>
											<div class="content-message font-regular"
												[innerHTML]="child.message_format | safeHtml"></div>
										</div>
										<div class="border-activety-comment" *ngIf="!child.message_format">
											<div class="name font-semibold pb-1">{{child.from.name}}</div>
											<div class="content-message font-regular">{{child.message}}</div>
										</div>
									</div>
								</div>
								<div *ngIf="!child.message?.attachments"
									class="chat-option invisible group-hover:visible">
									<div class="select-order flex flex-row items-center w-fit h-full pl-3">
										<span tds-tooltip tooltipTitle="Chọn làm số điện thoại"
											class="h-5 w-5 bg-green-400 flex items-center justify-center rounded-md cursor-pointer mr-1.5"
											(click)="selectOrder('phone')">
											<i class="tdsi-call-fill text-xs text-white"></i>
										</span>
										<span tds-tooltip tooltipTitle="Chọn làm địa chỉ"
											class="h-5 w-5 bg-orange-500 flex items-center justify-center rounded-md cursor-pointer mr-1.5"
											(click)="selectOrder('address')">
											<i class="tdsi-pin-fill text-xs text-white"></i>
										</span>
										<span tds-tooltip tooltipTitle="Chọn làm ghi chú"
											class="h-5 w-5 bg-blue-500 flex items-center justify-center rounded-md cursor-pointer"
											(click)="selectOrder('note')">
											<i class="tdsi-note-2-fill text-xs text-white"></i>
										</span>
									</div>
								</div>
							</div>
							<div class="chat-meta text-neutral-1-600 text-caption-2 font-regular mt-1.5"
								style="position: relative;">
								<div class="chat-acts flex flex-row items-center" style="position: relative;">
									<span *ngIf="child.created_time" class="date-diff cursor-pointer hover:underline"
										tds-tooltip
										tooltipTitle="{{child.created_time | date:'dd'}} Tháng {{child.created_time | date:'MM'}}, {{child.created_time | date:'yyyy'}} lúc {{child.created_time | date:'HH:mm'}}">
										{{child.created_time | yiDiffDateTime}}
									</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!----Popup send_picture lọc theo Messages---->
<ng-template #send_picture>

</ng-template>
