<tds-spin [spinning]="isLoading" >
    <tds-tabset class="bg-transparent">
        <tds-tab title="Thông tin chung" clsContent="h-full w-full pb-2.5 px-4 border-t border-neutral-2-200">
            <form class="flex flex-col pt-4" [formGroup]="_form" >
                <div class="w-full text-body-2 text-neutral-1-900">
                    <div class="grid grid-cols-2 gap-x-8 gap-y-4">
                        <div class="col-span-2 row-span-2 flex">
                            <div class="w-1/6">
                                <tds-upload [beforeUpload]="beforeUpload" [showUploadList]="false">
                                <tds-avatar [isAvatar]="false" class="rounded-lg" [shape]="'square'" [size]="132"
                                    tdsSrc="{{ _form.controls['ImageUrl'].value }}">
                                </tds-avatar>
                                </tds-upload>
                            </div>
                            <div class="w-5/6 flex flex-col gap-y-4">
                                <tds-form-field >
                                    <tds-label>Tên sản phẩm</tds-label>
                                    <input tdsInput autocomplete="off" placeholder="Nhập tên sản phẩm" [required]='true' formControlName="Name" />
                                    <tds-error *ngIf="_form.invalid">Vui lòng nhập tên sản phẩm</tds-error>
                                </tds-form-field>
                                <tds-form-field *ngIf="type == 'liveCampaign'" [color]="_form.controls.OrderTag.invalid && _form.controls.OrderTag.touched? 'error': 'default'">    
                                    <tds-label>Mã chốt đơn</tds-label>
                                    <tds-select placeholder='Nhập từ khóa' [valuePrimitive]="false" formControlName="OrderTag" [required]='true'
                                        [allowClear]="true" [data]="" mode="tags" (selectChange)="onChangeModelTag($event)">
                                    </tds-select>
                                    <tds-error *ngIf="_form.controls.OrderTag.invalid && _form.controls.OrderTag.touched">Vui lòng nhập mã chốt đơn</tds-error>
                                </tds-form-field>
                            </div>
                        </div>
                        <div class="flex items-center gap-x-2 pt-4">
                            <tds-label class="w-1/3">Loại sản phẩm</tds-label>
                            <div class="w-2/3">
                                <tds-form-field>
                                    <tds-select placeholder='Chọn loại sản phẩm' formControlName="Type"
                                        valueField="value" textField="text" [allowClear]="false"
                                        disabledField="isActive" [required]='true' [data]="lstProductType">
                                    </tds-select>
                                </tds-form-field>
                            </div>
                        </div>
                        <div class="flex items-center gap-x-2 pt-4">
                            <tds-label class="w-1/3">Giá bán</tds-label>
                            <div class="w-2/3">
                                <tds-input-number [min]="0" [step]="1000" formControlName="ListPrice" [formatter]="numberWithCommas" [parser]="parserComas">
                                </tds-input-number>
                            </div>
                        </div>
                        <div class="flex items-center gap-x-2">
                            <tds-label class="w-1/3">Mã sản phẩm</tds-label>
                            <div class="w-2/3">
                                <tds-form-field>
                                    <input tdsInput autocomplete="off" placeholder="Để trống sẽ phát sinh tự động" formControlName="DefaultCode"/>
                                </tds-form-field>
                            </div>
                        </div>
                        <div class="flex items-center gap-x-2">
                            <tds-label class="w-1/3">Chiết khấu bán (%)</tds-label>
                            <div class="w-2/3">
                                <tds-input-number [min]="0" [max]="100" [step]="1" formControlName="DiscountSale" [formatter]="numberWithCommas" [parser]="parserComas">
                                </tds-input-number>
                            </div>
                        </div>
                        <div class="flex items-center gap-x-2">
                            <tds-label class="w-1/3">Mã vạch</tds-label>
                            <div class="w-2/3">
                                <tds-form-field>
                                    <input tdsInput autocomplete="off" placeholder="Nhập mã vạch" formControlName="Barcode" />
                                </tds-form-field>
                            </div>
                        </div>
                        <div class="flex items-center gap-x-2">
                            <tds-label class="w-1/3">Giá mua mặc định</tds-label>
                            <div class="w-2/3">
                                <tds-input-number [min]="0" [step]="1000" formControlName="PurchasePrice" [formatter]="numberWithCommas" [parser]="parserComas">
                                </tds-input-number>
                            </div>
                        </div>
                        <div class="flex items-center gap-x-2">
                            <tds-label class="w-1/3">Nhóm sản phẩm</tds-label>
                            <div class="w-2/3 flex gap-x-2">
                                <div class="w-full">
                                    <tds-form-field>
                                        <tds-select valueField="Id" textField="Name" placeholder='Chọn nhóm sản phẩm' formControlName="Categ"
                                            disabledField="isActive" [required]='true' [data]="lstCategory" [allowClear]="true" [valuePrimitive]="false">
                                        </tds-select>
                                    </tds-form-field>
                                </div>
                                <button tds-button-icon type="button" color="secondary" (click)="onCreateCategory()">
                                    <i class="tdsi-plus-circle-fill text-primary-1"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center gap-x-2">
                            <tds-label class="w-1/3">Chiết khấu mua (%)</tds-label>
                            <div class="w-2/3">
                                <tds-input-number [min]="0" [max]="100" [step]="1" formControlName="DiscountPurchase" [formatter]="numberWithCommas" [parser]="parserComas">
                                </tds-input-number>
                            </div>
                        </div>
                        <div class="flex items-center gap-x-2">
                            <tds-label class="w-1/3">Khối lượng (kg)</tds-label>
                            <div class="w-2/3">
                                <tds-input-number [min]="0" [step]="1" formControlName="Weight" [formatter]="numberWithCommas" [parser]="parserComas">
                                </tds-input-number>
                            </div>
                        </div>
                        <div class="flex items-center gap-x-2">
                            <tds-label class="w-1/3">Giá vốn</tds-label>
                            <div class="w-2/3">
                                <tds-input-number [min]="0" [step]="1000" formControlName="StandardPrice" [formatter]="numberWithCommas" [parser]="parserComas">
                                </tds-input-number>
                            </div>
                        </div>
                        <div class="flex items-center gap-x-2">
                            <tds-label class="w-1/3">Số lượng thực tế</tds-label>
                            <div class="w-2/3">
                                <tds-form-field class="w-full">
                                    <tds-input-number
                                    formControlName="InitInventory"
                                    [formatter]="numberWithCommas" [parser]="parserComas"
                                    [min]="0"
                                    class="text-neutral-1-900 text-body-2 font-regular"></tds-input-number>
                                    <tds-error>
                                    Vui lòng nhập số lượng thực tế
                                    </tds-error>
                                </tds-form-field>
                            </div>
                        </div>
                        <div class="col-start-2 flex items-center gap-x-2">
                            <tds-label class="w-1/3">Đơn vị mặc định</tds-label>
                            <div class="w-2/3 flex gap-x-2">
                                <div class="w-full">
                                    <tds-form-field>
                                        <tds-select valueField="Id" textField="Name" placeholder='Chọn đơn vị mặc định' formControlName="UOM"
                                            disabledField="isActive" [required]='true' [data]="lstUOMCategory" [allowClear]="true" [valuePrimitive]="false">
                                        </tds-select>
                                    </tds-form-field>
                                </div>
                                <button tds-button-icon type="button" color="secondary" size="md"  (click)="onSearchUOM('UOM')">
                                    <span class="flex items-center">
                                        <i class="tdsi-search-fill text-neutral-1-500"></i>
                                    </span>
                                </button>
                                <button tds-button-icon type="button" color="secondary" (click)="showCreateUOMModal()">
                                    <i class="tdsi-plus-circle-fill text-primary-1"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-start-2 flex items-center gap-x-2">
                            <tds-label class="w-1/3">Đơn vị mua</tds-label>
                            <div class="w-2/3 flex gap-x-2">
                                <div class="w-full">
                                    <tds-form-field>
                                        <tds-select valueField="Id" textField="Name" placeholder='Chọn đơn vị mua' formControlName="UOMPO"
                                            disabledField="isActive" [required]='true' [data]="lstUOMCategory" [allowClear]="true" [valuePrimitive]="false">
                                        </tds-select>
                                    </tds-form-field>
                                </div>
                                <button tds-button-icon type="button" color="secondary" size="md" (click)="onSearchUOM('UOMPO')">
                                    <span class="flex items-center">
                                        <i class="tdsi-search-fill text-neutral-1-500"></i>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="w-full flex justify-end p-4" *tdsModalFooter>
                        <button tds-button type="button" class="mr-2 w-[100px]" color="secondary" (click)="onCancel()">Đóng</button>
                        <button tds-button type="button" class="w-[100px] mr-2" color="primary" (click)="onSave()" [disabled]="!_form?.valid || isLoading">Lưu</button>
                        <button tds-button type="button" color="primary" class="min-w-[120px] text-white" (click)="onSave('select')" [disabled]="!_form?.valid || isLoading">Lưu và chọn</button>
                    </div>
                </div>
            </form>
        </tds-tab>
        <tds-tab *ngIf="type == 'liveCampaign'" title="Biến thể" clsContent="h-full w-full pb-2.5 border-t border-neutral-2-200">
            <div class="flex flex-col gap-y-8 justify-center items-center" *ngIf="lstVariants.length > 0; else tableAttribute">
                <div class="w-full h-[350px]">
                    <tds-table #variantsTable [listData]="lstVariants" [showPagination]="false" [scroll]="{y:'auto'}">
                      <thead>
                        <tr>
                          <th width="6%">STT</th>
                          <th width="24%">Tên</th>
                          <th width="30%">Mã chốt đơn</th>
                          <th width="20%">Giá</th>
                          <th width="10%" [align]="'center'">Hoạt động</th>
                          <th width="10%" [align]="'center'">Thao tác</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let data of lstVariants; let i = index">
                          <td>{{ 1 + i }}</td>
                          <td>
                            <div class="flex flex-col">
                              <span class="mb-2">{{ data.NameTemplate || data.Name }}</span>
                              <div class="flex flex-wrap items-center gap-1">
                                <tds-tag *ngFor="let item of data.AttributeValues" status='secondary'
                                  rounded="rounded-full">
                                  {{item.NameGet || (item.AttributeName + ': ' + item.Name)}}
                                </tds-tag>
                              </div>
                            </div>
                          </td>
                          <td>
                            <tds-select placeholder='Nhập từ khóa' [valuePrimitive]="false" [ngModel]="data.OrderTag|stringToStringArray" [ngModelOptions]="{standalone: true}"
                                (ngModelChange)="changeTags($event,i)"
                                [allowClear]="true" [data]="" mode="tags" class="w-full">
                            </tds-select>
                          </td>
                          <td>
                            <tds-input-number [(ngModel)]="data.PriceVariant" [ngModelOptions]="{standalone: true}"
                              [min]="0" [step]="1000" [formatter]="numberWithCommas" [parser]="parserComas" class="text-neutral-1-900 text-body-2 font-regular">
                            </tds-input-number>
                          </td>
                          <td class="w-full text-center">
                            <tds-switch [(ngModel)]="data.Active" [ngModelOptions]="{standalone: true}"></tds-switch>
                          </td>
                          <td class="w-full text-center">
                            <button tds-button-icon color="secondary" type="button" size="sm" class=" mr-2"
                              (click)="showEditVariantsModal(data)">
                              <span class="flex items-center">
                                <i class="tdsi-edit-fill text-xl text-neutral-1-500 leading-none"></i>
                              </span>
                            </button>
                            <button tds-button-icon color="secondary" type="button" size="sm"
                              (click)="removeVariants(data)">
                              <span class="flex items-center">
                                <i class="tdsi-trash-fill text-xl text-neutral-1-500 leading-none"></i>
                              </span>
                            </button>
                          </td>
                        </tr>
                        <tr>
                          <div class="p-3">
                            <button tds-button type="button" color="primary" (click)="showCreateAttributeModal()">
                                <span class="flex items-center ">
                                    <i class="tdsi-plus-fill mr-2"></i>Thêm biến thể
                                </span>
                            </button>
                          </div>
                        </tr>
                      </tbody>
                    </tds-table>
                </div>

            </div>
            <ng-template #tableAttribute>
                <div class="flex flex-col gap-y-8 justify-center items-center">
                    <div class="flex flex-col gap-y-4 items-center" >
                        <img src="../../assets/imagesv2/live-campaign/noData.svg" alt="">
                        <span class="text-neutral-1-400 text-body-2">Chưa có biến thể nào</span>
                    </div>
                </div>
                <div class="flex justify-center pt-2">
                  <button tds-button type="button" color="primary" (click)="showCreateAttributeModal()">
                      <span class="flex items-center ">
                          <i class="tdsi-plus-fill mr-2"></i>Thêm biến thể
                      </span>
                  </button>
              </div>
            </ng-template>
        </tds-tab>
    </tds-tabset>
</tds-spin>
